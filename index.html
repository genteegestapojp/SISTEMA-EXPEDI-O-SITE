<!DOCTYPE html>
<html lang="pt-BR">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Sistema de Controle de ExpediÃ§Ã£o - Filiais</title>
Â  Â  <link rel="manifest" href="manifest.json">
Â  Â  <link rel="icon" type="image/png" href="favicon.png">
Â  Â  <link rel="icon" type="image/png" href="favicon.png">
Â  Â  <script src="https://unpkg.com/html5-qrcode"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
Â  Â  <style>
Â  Â  Â  Â  * {
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Ãcones Profissionais */
Â  Â  Â  Â  .feature-icon {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  width: 16px;
Â  Â  Â  Â  Â  Â  height: 16px;
Â  Â  Â  Â  Â  Â  margin-right: 8px;
Â  Â  Â  Â  Â  Â  font-style: normal;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  color: var(--primary);
Â  Â  Â  Â  Â  Â  vertical-align: middle;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  line-height: 16px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .feature-icon.truck::before { content: "ğŸšš"; color: var(--accent); }
Â  Â  Â  Â  .feature-icon.store::before { content: "ğŸ¢"; color: var(--primary); }
Â  Â  Â  Â  .feature-icon.package::before { content: "ğŸ“¦"; color: var(--primary); }
Â  Â  Â  Â  .feature-icon.rolltrainer::before { content: "ğŸ”„"; color: var(--secondary); }
Â  Â  Â  Â  .feature-icon.dock::before { content: "âš“"; color: var(--accent); }
Â  Â  Â  Â  .feature-icon.user::before { content: "ğŸ‘¤"; color: var(--dark); }
Â  Â  Â  Â  .feature-icon.clock::before { content: "â°"; color: #F77F00; }
Â  Â  Â  Â  .feature-icon.calendar::before { content: "ğŸ“…"; color: #F77F00; }
Â  Â  Â  Â  .feature-icon.note::before { content: "ğŸ“"; color: var(--primary); }
Â  Â  Â  Â  .feature-icon.clipboard::before { content: "ğŸ“‹"; color: #F77F00; }
Â  Â  Â  Â  .feature-icon.email::before { content: "ğŸ“§"; color: white; }
Â  Â  Â  Â  .feature-icon.info::before { content: "â„¹ï¸"; color: var(--primary); }
Â  Â  Â  Â  .feature-icon.building::before { content: "ğŸ¢"; color: var(--primary); }
Â  Â  Â  Â  .feature-icon.history::before { content: "ğŸ“œ"; color: var(--light); }


Â  Â  Â  Â  /* VariaÃ§Ãµes de cor para diferentes contextos */
Â  Â  Â  Â  .feature-icon.primary { color: var(--primary); }
Â  Â  Â  Â  .feature-icon.secondary { color: var(--secondary); }
Â  Â  Â  Â  .feature-icon.dark { color: var(--dark); }
Â  Â  Â  Â  .feature-icon.warning { color: #F77F00; }
Â  Â  Â  Â  .feature-icon.white { color: white; }
Â  Â  Â  Â  .feature-icon.accent { color: var(--accent); }

Â  Â  Â  Â  /* Hover effects para Ã­cones interativos */
Â  Â  Â  Â  .feature-icon:hover {
Â  Â  Â  Â  Â  Â  transform: scale(1.1);
Â  Â  Â  Â  Â  Â  transition: transform 0.2s ease;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* VariÃ¡veis CSS */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --primary: #00D4AA;
Â  Â  Â  Â  Â  Â  --secondary: #00B4D8;
Â  Â  Â  Â  Â  Â  --accent: #0077B6;
Â  Â  Â  Â  Â  Â  --dark: #023047;
Â  Â  Â  Â  Â  Â  --darker: #011627;
Â  Â  Â  Â  Â  Â  --light: #90E0EF;
Â  Â  Â  Â  Â  Â  --primary-gradient: linear-gradient(135deg, #00D4AA 0%, #00B4D8 50%, #0077B6 100%);
Â  Â  Â  Â  Â  Â  --secondary-gradient: linear-gradient(135deg, #90E0EF 0%, #00D4AA 100%);
Â  Â  Â  Â  Â  Â  --accent-gradient: linear-gradient(135deg, #0077B6 0%, #023047 100%);
Â  Â  Â  Â  }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Segoe UI', -apple-system, sans-serif;
Â  Â  Â  Â  Â  Â  background: var(--primary-gradient);
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  -webkit-overflow-scrolling: touch;
Â  Â  Â  Â  }

Â  Â  Â  Â  .container {
Â  Â  Â  Â  Â  Â  max-width: 1400px;
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.95);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(20px);
Â  Â  Â  Â  Â  Â  border-radius: 16px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 16px 32px rgba(0, 119, 182, 0.2);
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  }

Â  Â  Â  Â  .connection-status {
Â  Â  Â  Â  Â  Â  background: var(--primary-gradient);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 8px 16px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  }

Â  Â  Â  Â  .connection-status.error {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #D62828, #F77F00);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Indicador de Filial Selecionada */
Â  Â  Â  Â  .filial-indicator {
Â  Â  Â  Â  Â  Â  background: var(--accent-gradient);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 12px 20px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  .filial-indicator.active {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  }

Â  Â  Â  Â  .header {
Â  Â  Â  Â  Â  Â  background: var(--accent-gradient);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 20px 15px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  .header h1 {
Â  Â  Â  Â  Â  Â  font-size: 1.8rem;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  }

Â  Â  Â  Â  .header p {
Â  Â  Â  Â  Â  Â  font-size: 0.95rem;
Â  Â  Â  Â  Â  Â  opacity: 0.9;
Â  Â  Â  Â  Â  Â  line-height: 1.4;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Tela de SeleÃ§Ã£o de Filiais */
Â  Â  Â  Â  .filial-selection {
Â  Â  Â  Â  Â  Â  padding: 40px 20px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  min-height: 400px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  .filial-selection h2 {
Â  Â  Â  Â  Â  Â  color: var(--dark);
Â  Â  Â  Â  Â  Â  font-size: 2rem;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  }

Â  Â  Â  Â  .filial-selection p {
Â  Â  Â  Â  Â  Â  color: var(--secondary);
Â  Â  Â  Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  Â  Â  Â  margin-bottom: 40px;
Â  Â  Â  Â  Â  Â  line-height: 1.5;
Â  Â  Â  Â  }

Â  Â  Â  Â  .filiais-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
Â  Â  Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  Â  Â  max-width: 800px;
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  }

Â  Â  Â  Â  .filial-card {
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.9);
Â  Â  Â  Â  Â  Â  border: 2px solid rgba(0, 212, 170, 0.3);
Â  Â  Â  Â  Â  Â  border-radius: 16px;
Â  Â  Â  Â  Â  Â  padding: 30px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }

Â  Â  Â  Â  .filial-card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-5px);
Â  Â  Â  Â  Â  Â  border-color: var(--primary);
Â  Â  Â  Â  Â  Â  box-shadow: 0 12px 30px rgba(0, 212, 170, 0.3);
Â  Â  Â  Â  }

Â  Â  Â  Â  .filial-card h3 {
Â  Â  Â  Â  Â  Â  color: var(--dark);
Â  Â  Â  Â  Â  Â  font-size: 1.4rem;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  }

Â  Â  Â  Â  .filial-card p {
Â  Â  Â  Â  Â  Â  color: var(--secondary);
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  margin: 5px 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  .filial-card::before {
Â  Â  Â  Â  Â  Â  content: '';
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  Â  Â  height: 4px;
Â  Â  Â  Â  Â  Â  background: var(--primary-gradient);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Sub-abas */
Â  Â  Â  Â  .sub-tabs {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  border-bottom: 2px solid rgba(0, 212, 170, 0.2);
Â  Â  Â  Â  }

Â  Â  Â  Â  .sub-tab {
Â  Â  Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  color: var(--secondary);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  background: none;
Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }

Â  Â  Â  Â  .sub-tab.active {
Â  Â  Â  Â  Â  Â  color: var(--dark);
Â  Â  Â  Â  Â  Â  border-bottom: 3px solid var(--primary);
Â  Â  Â  Â  }

Â  Â  Â  Â  .sub-tab-content {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  .sub-tab-content.active {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Tabs Responsivas */
Â  Â  Â  Â  .tabs {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  background: var(--dark);
Â  Â  Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  Â  Â  Â  -webkit-overflow-scrolling: touch;
Â  Â  Â  Â  Â  Â  scrollbar-width: none;
Â  Â  Â  Â  Â  Â  -ms-overflow-style: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  .tabs::-webkit-scrollbar {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  .tab {
Â  Â  Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  Â  Â  min-width: 120px;
Â  Â  Â  Â  Â  Â  padding: 12px 16px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  color: var(--light);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  background: none;
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  opacity: 0.5;
Â  Â  Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  .tab.enabled {
Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  pointer-events: auto;
Â  Â  Â  Â  }

Â  Â  Â  Â  .tab.enabled:hover {
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  background: rgba(0, 212, 170, 0.1);
Â  Â  Â  Â  }

Â  Â  Â  Â  .tab.active {
Â  Â  Â  Â  Â  Â  background: var(--secondary-gradient);
Â  Â  Â  Â  Â  Â  color: var(--dark);
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  pointer-events: auto;
Â  Â  Â  Â  }

Â  Â  Â  Â  .tab-content {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  padding: 20px 15px;
Â  Â  Â  Â  Â  Â  min-height: 400px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .tab-content.active {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  animation: fadeIn 0.6s ease-in;
Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes fadeIn {
Â  Â  Â  Â  Â  Â  from {
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  Â  Â  transform: translateY(10px);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  to {
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  Â  Â  transform: translateY(0);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  .tab-content h2 {
Â  Â  Â  Â  Â  Â  color: var(--dark);
Â  Â  Â  Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  background: var(--primary-gradient);
Â  Â  Â  Â  Â  Â  -webkit-background-clip: text;
Â  Â  Â  Â  Â  Â  -webkit-text-fill-color: transparent;
Â  Â  Â  Â  Â  Â  background-clip: text;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Form Grid Responsivo */
Â  Â  Â  Â  .form-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  gap: 16px;
Â  Â  Â  Â  Â  Â  margin-bottom: 24px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .form-group {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  }

Â  Â  Â  Â  .form-group label {
Â  Â  Â  Â  Â  Â  margin-bottom: 6px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  color: var(--dark);
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  }

Â  Â  Â  Â  .form-group input,
Â  Â  Â  Â  .form-group select,
Â  Â  Â  Â  .form-group textarea {
Â  Â  Â  Â  Â  Â  padding: 12px 16px;
Â  Â  Â  Â  Â  Â  border: 2px solid rgba(0, 212, 170, 0.3);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.9);
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  -webkit-appearance: none;
Â  Â  Â  Â  Â  Â  -moz-appearance: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  .form-group input:focus,
Â  Â  Â  Â  .form-group select:focus,
Â  Â  Â  Â  .form-group textarea:focus {
Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  Â  Â  border-color: var(--primary);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
Â  Â  Â  Â  }

Â  Â  Â  Â  .form-group textarea {
Â  Â  Â  Â  Â  Â  resize: vertical;
Â  Â  Â  Â  Â  Â  min-height: 80px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Layout de Lojas Responsivo */
Â  Â  Â  Â  .loja-line, .edit-loja-line {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  gap: 12px;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.7);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(0, 212, 170, 0.2);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* BotÃµes Responsivos */
Â  Â  Â  Â  .btn {
Â  Â  Â  Â  Â  Â  padding: 12px 20px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 0.95rem;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 0.5px;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  touch-action: manipulation;
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn-primary {
Â  Â  Â  Â  Â  Â  background: var(--primary-gradient);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn-success {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #00D4AA, #00B4D8);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn-danger {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #D62828, #F77F00);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn-warning {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #F77F00, #FCBF49);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn-small {
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  Â  Â  margin-bottom: 4px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-1px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(0, 119, 182, 0.3);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Stats Grid Responsivo */
Â  Â  Â  Â  .stats-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  gap: 16px;
Â  Â  Â  Â  Â  Â  margin-bottom: 24px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .stat-card {
Â  Â  Â  Â  Â  Â  background: var(--primary-gradient);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 20px rgba(0, 119, 182, 0.3);
Â  Â  Â  Â  Â  Â  transition: all 0.4s ease;
Â  Â  Â  Â  }

Â  Â  Â  Â  .stat-card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-4px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 12px 30px rgba(0, 119, 182, 0.4);
Â  Â  Â  Â  }

Â  Â  Â  Â  .stat-number {
Â  Â  Â  Â  Â  Â  font-size: 2rem;
Â  Â  Â  Â  Â  Â  font-weight: 800;
Â  Â  Â  Â  Â  Â  margin-bottom: 6px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .stat-label {
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  opacity: 0.9;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Time Stats Responsivo */
Â  Â  Â  Â  .time-stats-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  gap: 12px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .historico-time-grid {
Â  Â  Â  Â  Â  Â  Â display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
Â  Â  Â  Â  Â  Â  gap: 12px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .time-stat-card {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #7209B7, #A663CC);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 16px;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 20px rgba(114, 9, 183, 0.3);
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }

Â  Â  Â  Â  .time-stat-card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 25px rgba(114, 9, 183, 0.4);
Â  Â  Â  Â  }

Â  Â  Â  Â  .time-stat-card .stat-number {
Â  Â  Â  Â  Â  Â  font-size: 1.4rem;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  margin-bottom: 4px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .time-stat-card .stat-label {
Â  Â  Â  Â  Â  Â  font-size: 0.75rem;
Â  Â  Â  Â  Â  Â  opacity: 0.95;
Â  Â  Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  Â  Â  line-height: 1.2;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Filtros Responsivos */
Â  Â  Â  Â  .filters-section {
Â  Â  Â  Â  Â  Â  background: rgba(144, 224, 239, 0.1);
Â  Â  Â  Â  Â  Â  padding: 16px;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(0, 212, 170, 0.3);
Â  Â  Â  Â  }

Â  Â  Â  Â  .filters-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  gap: 12px;
Â  Â  Â  Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .filter-group {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  }

Â  Â  Â  Â  .filter-group label {
Â  Â  Â  Â  Â  Â  margin-bottom: 4px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  color: var(--dark);
Â  Â  Â  Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  Â  }

Â  Â  Â  Â  .filter-group input,
Â  Â  Â  Â  .filter-group select {
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  border: 2px solid rgba(0, 212, 170, 0.3);
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.9);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Tabela Responsiva */
Â  Â  Â  Â  .table-container {
Â  Â  Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 20px rgba(0, 119, 182, 0.15);
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.95);
Â  Â  Â  Â  Â  Â  margin: 16px 0;
Â  Â  Â  Â  Â  Â  -webkit-overflow-scrolling: touch;
Â  Â  Â  Â  }

Â  Â  Â  Â  .table-wrapper {
Â  Â  Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  Â  Â  Â  min-height: 200px;
Â  Â  Â  Â  }

Â  Â  Â  Â  table {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  border-collapse: collapse;
Â  Â  Â  Â  Â  Â  background: transparent;
Â  Â  Â  Â  Â  Â  min-width: 800px;
Â  Â  Â  Â  Â  Â  font-size: 0.75rem;
Â  Â  Â  Â  }

Â  Â  Â  Â  th, td {
Â  Â  Â  Â  Â  Â  padding: 8px 4px;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid rgba(0, 212, 170, 0.3);
Â  Â  Â  Â  Â  Â  word-wrap: break-word;
Â  Â  Â  Â  Â  Â  vertical-align: top;
Â  Â  Â  Â  }

Â  Â  Â  Â  th {
Â  Â  Â  Â  Â  Â  background: #0077B6;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  font-size: 0.7rem;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  position: sticky;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  z-index: 10;
Â  Â  Â  Â  }

Â  Â  Â  Â  tr:hover {
Â  Â  Â  Â  Â  Â  background: rgba(144, 224, 239, 0.1);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Status Badges Responsivos */
Â  Â  Â  Â  .status-badge {
Â  Â  Â  Â  Â  Â  padding: 4px 8px;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  font-size: 0.65rem;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  min-width: 60px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .status-pendente {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #D62828, #F77F00);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  .status-aguardando_veiculo {
Â  Â  Â  Â  Â  Â  background: var(--primary-gradient);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  .status-em_carregamento {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #F77F00, #FCBF49);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  .status-carregado {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #00D4AA, #00B4D8);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  .status-aguardando_faturamento {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #7209B7, #A663CC);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  .status-faturamento_iniciado {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #F77F00, #FCBF49);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  .status-faturado {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #00D4AA, #7209B7);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  .status-saiu_para_entrega {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #7209B7, #A663CC);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  .status-entregue {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #6C757D, #ADB5BD);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* NOVO: Estilo para o status de retorno ao CD */
Â  Â  Â  Â  .status-retornando_cd {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #0077B6, #00B4D8, #90E0EF); /* Adicionei uma terceira cor para o efeito ficar melhor */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  background-size: 200% 200%; /* Aumenta o tamanho do fundo para a animaÃ§Ã£o ter espaÃ§o */
Â  Â  Â  Â  Â  Â  animation: animatedGradient 3s ease infinite; /* Aplica a animaÃ§Ã£o que vamos criar */
Â  Â  Â  Â  }

Â  Â  Â  Â  .status-cancelado {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #495057, #6C757D);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
/* ADICIONE ESTE BLOCO ABAIXO */
.status-disponivel {
Â  Â  background: linear-gradient(135deg, #00D4AA, #00B4D8);
Â  Â  color: white;
}

.status-em_viagem {
Â  Â  background: linear-gradient(135deg, #F77F00, #FCBF49);
Â  Â  color: white;
}

.status-folga {
Â  Â  background: linear-gradient(135deg, #6C757D, #ADB5BD);
Â  Â  color: white;
}
Â  Â  Â  Â  .status-retornando_com_imobilizado {
Â  Â  background: linear-gradient(135deg, #4361EE, #7209B7); /* Um roxo/azul diferente */
Â  Â  color: white;
Â  Â  background-size: 200% 200%;
Â  Â  animation: animatedGradient 4s ease infinite;
}

.status-descarregando_imobilizado {
Â  Â  background: linear-gradient(135deg, #F77F00, #D62828); /* Laranja/vermelho para atenÃ§Ã£o */
Â  Â  color: white;
}
Â  Â  Â  Â  /* Transport Cards Responsivos */
Â  Â  Â  Â /* NOVO: Estilo compacto para a lista de status dos motoristas */
.motorista-status-item {
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  justify-content: space-between;
Â  Â  padding: 10px 15px;
Â  Â  margin-bottom: 8px;
Â  Â  border-radius: 8px;
Â  Â  background: rgba(255, 255, 255, 0.9);
Â  Â  border: 1px solid rgba(0, 212, 170, 0.2);
Â  Â  box-shadow: 0 2px 5px rgba(0, 119, 182, 0.05);
}

Â  Â  Â  Â  .transport-card:hover, .historico-card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(0, 119, 182, 0.2);
Â  Â  Â  Â  }

Â  Â  Â  Â  .transport-card h3, .historico-card h3 {
Â  Â  Â  Â  Â  Â  color: var(--dark);
Â  Â  Â  Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  }

Â  Â  Â  Â  .transport-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  Â  Â  margin: 12px 0;
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  }

Â  Â  Â  Â  .transport-actions {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  gap: 12px;
Â  Â  Â  Â  Â  Â  margin-top: 16px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .availability-info {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  Â  Â  background: rgba(144, 224, 239, 0.1);
Â  Â  Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(0, 212, 170, 0.2);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .availability-stat {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .availability-stat .stat-number {
Â  Â  Â  Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  color: var(--dark);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .availability-stat .stat-label {
Â  Â  Â  Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  Â  Â  Â  color: var(--secondary);
Â  Â  Â  Â  }


Â  Â  Â  Â  /* Alertas e NotificaÃ§Ãµes */
Â  Â  Â  Â  .alert {
Â  Â  Â  Â  Â  Â  padding: 12px 16px;
Â  Â  Â  Â  Â  Â  margin: 16px 0;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  }

Â  Â  Â  Â  .alert-success {
Â  Â  Â  Â  Â  Â  background: rgba(0, 212, 170, 0.1);
Â  Â  Â  Â  Â  Â  color: var(--secondary);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--primary);
Â  Â  Â  Â  }

Â  Â  Â  Â  .alert-error {
Â  Â  Â  Â  Â  Â  background: rgba(214, 40, 40, 0.1);
Â  Â  Â  Â  Â  Â  color: #D62828;
Â  Â  Â  Â  Â  Â  border: 1px solid #F77F00;
Â  Â  Â  Â  }

Â  Â  Â  Â  .alert-warning {
Â  Â  Â  Â  Â  Â  background: rgba(247, 127, 0, 0.1);
Â  Â  Â  Â  Â  Â  color: #F77F00;
Â  Â  Â  Â  Â  Â  border: 1px solid #FCBF49;
Â  Â  Â  Â  }

Â  Â  Â  Â  .notification {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 10px;
Â  Â  Â  Â  Â  Â  right: 10px;
Â  Â  Â  Â  Â  Â  left: 10px;
Â  Â  Â  Â  Â  Â  padding: 12px 16px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  .notification.success {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #00D4AA, #00B4D8);
Â  Â  Â  Â  }

Â  Â  Â  Â  .notification.error {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #D62828, #F77F00);
Â  Â  Â  Â  }

Â  Â  Â  Â  .notification.info {
Â  Â  Â  Â  Â  Â  background: var(--primary-gradient);
Â  Â  Â  Â  }

Â  Â  Â  Â  .notification.slide-in {
Â  Â  Â  Â  Â  Â  animation: slideInTop 0.4s ease;
Â  Â  Â  Â  }

Â  Â  Â  Â  .notification.slide-out {
Â  Â  Â  Â  Â  Â  animation: slideOutTop 0.4s ease;
Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes slideInTop {
Â  Â  Â  Â  Â  Â  from {
Â  Â  Â  Â  Â  Â  Â  Â  transform: translateY(-100%);
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  to {
Â  Â  Â  Â  Â  Â  Â  Â  transform: translateY(0);
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes slideOutTop {
Â  Â  Â  Â  Â  Â  from {
Â  Â  Â  Â  Â  Â  Â  Â  transform: translateY(0);
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  to {
Â  Â  Â  Â  Â  Â  Â  Â  transform: translateY(-100%);
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Loading e Spinner */
Â  Â  Â  Â  .loading {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  padding: 40px 20px;
Â  Â  Â  Â  Â  Â  color: var(--secondary);
Â  Â  Â  Â  }

Â  Â  Â  Â  .spinner {
Â  Â  Â  Â  Â  Â  border: 3px solid rgba(0, 212, 170, 0.1);
Â  Â  Â  Â  Â  Â  border-top: 3px solid var(--primary);
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  width: 40px;
Â  Â  Â  Â  Â  Â  height: 40px;
Â  Â  Â  Â  Â  Â  animation: spin 1s linear infinite;
Â  Â  Â  Â  Â  Â  margin: 0 auto 16px;
Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes spin {
Â  Â  Â  Â  Â  Â  0% { transform: rotate(0deg); }
Â  Â  Â  Â  Â  Â  100% { transform: rotate(360deg); }
Â  Â  Â  Â  }

Â  Â  Â  Â  .time-display {
Â  Â  Â  Â  Â  Â  background: rgba(144, 224, 239, 0.15);
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  margin: 6px 0;
Â  Â  Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  color: var(--dark);
Â  Â  Â  Â  }

Â  Â  Â  Â  .time-display.good {
Â  Â  Â  Â  Â  Â  border-left: 3px solid #00D4AA;
Â  Â  Â  Â  }

Â  Â  Â  Â  .time-display.warning {
Â  Â  Â  Â  Â  Â  border-left: 3px solid #F77F00;
Â  Â  Â  Â  }

Â  Â  Â  Â  .time-display.danger {
Â  Â  Â  Â  Â  Â  border-left: 3px solid #D62828;
Â  Â  Â  Â  }

Â  Â  Â  Â  .auto-timestamp {
Â  Â  Â  Â  Â  Â  background: rgba(144, 224, 239, 0.1);
Â  Â  Â  Â  Â  Â  padding: 6px 10px;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  font-size: 0.75rem;
Â  Â  Â  Â  Â  Â  color: var(--dark);
Â  Â  Â  Â  Â  Â  font-style: italic;
Â  Â  Â  Â  Â  Â  margin-top: 8px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Modais Responsivos */
Â  Â  Â  Â  .modal-overlay {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background: rgba(0, 0, 0, 0.8);
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  z-index: 1001;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  }

Â  Â  Â  Â  #addFormModal, #editExpeditionModal, #passwordModal {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.98);
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 20px 40px rgba(0, 119, 182, 0.3);
Â  Â  Â  Â  Â  Â  z-index: 1002;
Â  Â  Â  Â  Â  Â  max-width: 95vw;
Â  Â  Â  Â  Â  Â  max-height: 90vh;
Â  Â  Â  Â  Â  Â  width: 400px;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  #editExpeditionModal {
Â  Â  Â  Â  Â  Â  width: 90vw;
Â  Â  Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .modal-content {
Â  Â  Â  Â  Â  Â  background: white;
Â  Â  Â  Â  Â  Â  padding: 16px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  max-width: 95vw;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  Â  Â  animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes popIn {
Â  Â  Â  Â  Â  Â  from {
Â  Â  Â  Â  Â  Â  Â  Â  transform: scale(0.9);
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  to {
Â  Â  Â  Â  Â  Â  Â  Â  transform: scale(1);
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  .modal-title {
Â  Â  Â  Â  Â  Â  color: var(--dark);
Â  Â  Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  }

Â  Â  Â  Â  .modal-body {
Â  Â  Â  Â  Â  Â  margin-bottom: 16px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .modal-footer {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Progress Bar */
Â  Â  Â  Â  .progress-container {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  background-color: #f3f3f3;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  margin-top: 4px;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  height: 12px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .progress-bar {
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  transition: width 0.4s ease-in-out;
Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  Â  Â  padding-right: 4px;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-size: 0.65rem;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  line-height: 12px;
Â  Â  Â  Â  Â  Â  text-shadow: 0 1px 1px rgba(0,0,0,0.3);
Â  Â  Â  Â  }

Â  Â  Â  Â  .progress-green {
Â  Â  Â  Â  Â  Â  background-color: #60c58e;
Â  Â  Â  Â  }

Â  Â  Â  Â  .progress-orange {
Â  Â  Â  Â  Â  Â  background-color: #ffb86c;
Â  Â  Â  Â  }

Â  Â  Â  Â  .progress-red {
Â  Â  Â  Â  Â  Â  background-color: #ff6c6c;
Â  Â  Â  Â  }

Â  Â  Â  Â  .extra-buttons {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .search-bar input {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 12px 16px;
Â  Â  Â  Â  Â  Â  border: 2px solid rgba(0, 212, 170, 0.3);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.9);
Â  Â  Â  Â  Â  Â  margin-bottom: 16px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .search-bar input:focus {
Â  Â  Â  Â  Â  Â  border-color: var(--primary);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
Â  Â  Â  Â  }

Â  Â  Â  Â  .action-buttons {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 6px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .loja-descarga-card {
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.9);
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(0, 212, 170, 0.3);
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .loja-descarga-card h4 {
Â  Â  Â  Â  Â  Â  color: var(--dark);
Â  Â  Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .loja-descarga-info {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr 1fr;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .charts-container {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  }

Â  Â  Â  Â  @media (min-width: 1024px) {
Â  Â  Â  Â  Â  Â  .charts-container {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: 2fr 1fr;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Media Queries para Tablets */
Â  Â  Â  Â  @media (min-width: 768px) {
Â  Â  Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .header {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 30px 20px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .header h1 {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 2.2rem;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .header p {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .filial-selection {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 60px 40px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .filial-selection h2 {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 2.2rem;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 25px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .filial-selection p {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 50px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .filiais-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
Â  Â  Â  Â  Â  Â  Â  Â  gap: 25px;
Â  Â  Â  Â  Â  Â  Â  Â  max-width: 1000px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .filial-card {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 35px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .tab-content {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 30px 20px;
Â  Â  Â  Â  Â  Â  Â  Â  min-height: 500px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .tab-content h2 {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.8rem;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 25px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .form-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
Â  Â  Â  Â  Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .loja-line, .edit-loja-line {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: 2fr 1fr 1fr auto;
Â  Â  Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 16px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .btn {
Â  Â  Â  Â  Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 0;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 14px 24px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .stats-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
Â  Â  Â  Â  Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .time-stats-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
Â  Â  Â  Â  Â  Â  Â  Â  gap: 16px;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 25px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â .historico-time-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .filters-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
Â  Â  Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .transport-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
Â  Â  Â  Â  Â  Â  Â  Â  gap: 12px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .transport-actions {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr 1fr auto;
Â  Â  Â  Â  Â  Â  Â  Â  gap: 16px;
Â  Â  Â  Â  Â  Â  Â  Â  align-items: end;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  table {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  Â  Â  Â  Â  Â  min-width: 1200px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  th, td {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 10px 6px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .transport-card, .historico-card {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 24px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .notification {
Â  Â  Â  Â  Â  Â  Â  Â  top: 20px;
Â  Â  Â  Â  Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  Â  Â  Â  Â  left: auto;
Â  Â  Â  Â  Â  Â  Â  Â  max-width: 400px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .modal-footer {
Â  Â  Â  Â  Â  Â  Â  Â  flex-direction: row;
Â  Â  Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .extra-buttons {
Â  Â  Â  Â  Â  Â  Â  Â  flex-direction: row;
Â  Â  Â  Â  Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .action-buttons {
Â  Â  Â  Â  Â  Â  Â  Â  flex-direction: row;
Â  Â  Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Media Queries para Desktop */
Â  Â  Â  Â  @media (min-width: 1024px) {
Â  Â  Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .container {
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 24px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .header {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 40px 30px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .header h1 {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 2.5rem;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .header p {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .filial-selection {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 80px 60px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .filial-selection h2 {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 2.5rem;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .filiais-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
Â  Â  Â  Â  Â  Â  Â  Â  gap: 30px;
Â  Â  Â  Â  Â  Â  Â  Â  max-width: 1200px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .tab {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 18px 24px;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .tab-content {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 40px;
Â  Â  Â  Â  Â  Â  Â  Â  min-height: 600px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .tab-content h2 {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 2rem;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .form-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
Â  Â  Â  Â  Â  Â  Â  Â  gap: 24px;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 32px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .form-group input,
Â  Â  Â  Â  Â  Â  .form-group select,
Â  Â  Â  Â  Â  Â  .form-group textarea {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 16px 20px;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .btn {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 16px 32px;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .stat-card {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 28px;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .stat-number {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 2.5rem;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .time-stat-card {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 16px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .time-stat-card .stat-number {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.8rem;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .filters-section {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .table-container {
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 16px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  table {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  Â  Â  Â  Â  Â  min-width: 1400px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .transport-card, .historico-card {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 32px;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 24px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .transport-card h3, .historico-card h3 {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.4rem;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .transport-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
Â  Â  Â  Â  Â  Â  Â  Â  gap: 16px;
Â  Â  Â  Â  Â  Â  Â  Â  margin: 20px 0;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .transport-actions {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr 1fr auto;
Â  Â  Â  Â  Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  Â  Â  Â  Â  margin-top: 24px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  #addFormModal, #editExpeditionModal {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 30px;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  Â  Â  max-width: 800px;
Â  Â  Â  Â  Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .notification {
Â  Â  Â  Â  Â  Â  Â  Â  max-width: 350px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Media Queries para Telas Muito Pequenas */
Â  Â  Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .container {
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .header {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 15px 10px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .header h1 {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 6px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .header p {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .filial-selection {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 30px 15px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .filial-selection h2 {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.6rem;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .filial-selection p {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.95rem;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .filiais-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .filial-card {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .tab {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 10px 12px;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  Â  Â  Â  Â  Â  min-width: 100px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .tab-content {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 15px 10px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .tab-content h2 {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.3rem;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .form-group input,
Â  Â  Â  Â  Â  Â  .form-group select,
Â  Â  Â  Â  Â  Â  .form-group textarea {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 10px 12px;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.95rem;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .btn {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 10px 16px;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .btn-small {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 6px 10px;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .stat-number {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.8rem;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .stat-label {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .time-stat-card .stat-number {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .time-stat-card .stat-label {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.7rem;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  table {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.7rem;
Â  Â  Â  Â  Â  Â  Â  Â  min-width: 700px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  th, td {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 6px 3px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .status-badge {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 3px 6px;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.6rem;
Â  Â  Â  Â  Â  Â  Â  Â  min-width: 50px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .transport-card, .historico-card {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .transport-card h3, .historico-card h3 {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .modal-content {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .modal-title {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  #addFormModal, #editExpeditionModal {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  Â  Â  width: 95vw;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Ajustes especÃ­ficos para orientaÃ§Ã£o landscape em mobile */
Â  Â  Â  Â  @media (max-width: 768px) and (orientation: landscape) {
Â  Â  Â  Â  Â  Â  .header {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .header h1 {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.6rem;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .tab-content {
Â  Â  Â  Â  Â  Â  Â  Â  min-height: 300px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  .modal-overlay {
Â  Â  Â  Â  Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  Â  Â  Â  Â  padding-top: 10px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  #addFormModal, #editExpeditionModal {
Â  Â  Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  Â  Â  top: auto;
Â  Â  Â  Â  Â  Â  Â  Â  left: auto;
Â  Â  Â  Â  Â  Â  Â  Â  transform: none;
Â  Â  Â  Â  Â  Â  Â  Â  margin: 10px auto;
Â  Â  Â  Â  Â  Â  Â  Â  max-height: calc(100vh - 20px);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes animatedGradient {
Â  Â  Â  Â  0% {
Â  Â  Â  Â  Â  Â  background-position: 0% 50%;
Â  Â  Â  Â  }
Â  Â  Â  Â  50% {
Â  Â  Â  Â  Â  Â  background-position: 100% 50%;
Â  Â  Â  Â  }
Â  Â  Â  Â  100% {
Â  Â  Â  Â  Â  Â  background-position: 0% 50%;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <div class="container">
Â  Â  Â  Â  <div id="connectionStatus" class="connection-status">
Â  Â  Â  Â  Â  Â  Conectando ao banco de dados...
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="filialIndicator" class="filial-indicator">
Â  Â  Â  Â  Â  Â  <span class="feature-icon building"></span>
Â  Â  Â  Â  Â  Â  <span id="filialNome">Nenhuma filial selecionada</span>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="header">
Â  Â  Â  Â  Â  Â  <h1>Sistema de Controle de ExpediÃ§Ã£o</h1>
Â  Â  Â  Â  Â  Â  <p>Gerencie todas as operaÃ§Ãµes de transporte e logÃ­stica com rastreamento completo de tempo</p>
Â  Â  Â  Â  Â  Â  <div style="margin-top: 12px; font-size: 0.8rem; opacity: 0.7;">
Â  Â  Â  Â  Â  Â  Â  Â  Desenvolvido por <strong>Juliano Patrick</strong> - JP Tech Solutions
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="filialSelection" class="filial-selection">
Â  Â  Â  Â  Â  Â  <h2>Selecione a Filial</h2>
Â  Â  Â  Â  Â  Â  <p>Escolha a filial para acessar o sistema de expediÃ§Ã£o</p>
Â  Â  Â  Â  Â  Â  <div id="filiaisGrid" class="filiais-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="loading">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="spinner"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Carregando filiais disponÃ­veis...
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="mainSystem" style="display: none;">
Â  Â  Â  Â  Â  Â  <div class="tabs">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab" onclick="showTab('operacao')">OperaÃ§Ã£o</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab" onclick="showTab('transporte')">Transporte</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab" onclick="showTab('faturamento')">Faturamento</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab" onclick="showTab('motoristas')">Motoristas</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab" onclick="showTab('acompanhamento')">Acompanhamento</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab" onclick="showTab('historico')">HistÃ³rico</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab" onclick="showTab('configuracoes')">ConfiguraÃ§Ãµes</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger btn-small" onclick="trocarFilial()" style="margin: 8px; font-size: 0.75rem; padding: 8px 12px; text-transform: none;">Trocar Filial</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="operacao" class="tab-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="text-align: center;">LanÃ§amento de ExpediÃ§Ã£o</h2>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="auto-timestamp">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  A data e hora da expediÃ§Ã£o serÃ£o registradas automaticamente no momento do lanÃ§amento
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <form id="expeditionForm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="grid-column: 1 / -1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size: 1.1rem; color: var(--dark); margin-bottom: 15px;">Lojas e Quantidades:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="lojasContainer" style="background: rgba(144, 224, 239, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(0, 212, 170, 0.3);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="loja-line" data-index="0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-bottom: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Loja:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select class="loja-select" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Carregando lojas...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-bottom: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Pallets:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" class="pallets-input" min="0" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-bottom: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>RollTrainers:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" class="rolltrainers-input" min="0" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; align-items: center; height: 48px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-success btn-small" onclick="addLojaLine()" style="padding: 12px; border-radius: 8px;">+</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="docaSelect">Doca:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="docaSelect" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Carregando docas...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="liderSelect">LÃ­der:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="liderSelect" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Carregando lÃ­deres...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="observacoes">ObservaÃ§Ãµes:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="observacoes" placeholder="ObservaÃ§Ãµes gerais para todas as lojas..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn btn-primary">LanÃ§ar ExpediÃ§Ã£o</button>
Â  Â  Â  Â  Â  Â  Â  Â  </form>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="operacaoAlert"></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="transporte" class="tab-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="text-align: center;">AlocaÃ§Ã£o de Transporte</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="availabilityInfo" class="availability-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="availability-stat">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="availableVehicles">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">VeÃ­culos DisponÃ­veis</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="availability-stat">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="availableDrivers">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Motoristas DisponÃ­veis</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="transporteList" class="loading">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="spinner"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Carregando expediÃ§Ãµes pendentes...
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="faturamento" class="tab-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="text-align: center;">Controle de Faturamento</h2>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="totalCarregadas">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Cargas Carregadas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="background: linear-gradient(135deg, #F77F00, #FCBF49);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="emFaturamento">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Em Faturamento</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="background: linear-gradient(135deg, #00D4AA, #00B4D8);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="faturadas">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Faturadas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-stats-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-stat-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="tempoMedioFaturamento">-</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Tempo MÃ©dio<br>Faturamento (HH:mm)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="faturamentoList" class="loading">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="spinner"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Carregando expediÃ§Ãµes para faturamento...
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â <div id="motoristas" class="tab-content">
Â  Â  <h2 style="text-align: center;">Painel de Motoristas</h2>

Â  Â  <div class="sub-tabs">
Â  Â  Â  Â  <button class="sub-tab active" onclick="showSubTab('motoristas', 'consultaViagens')">Consulta de Viagens</button>
Â  Â  Â  Â  <button class="sub-tab" onclick="showSubTab('motoristas', 'relatoriosMotoristas')">RelatÃ³rios</button>
Â  Â  </div> <div id="consultaViagens" class="sub-tab-content active">

Â  Â  Â  Â  <h2 style="text-align: center;">Ãrea do Motorista</h2>

Â  Â  Â  Â  <div class="transport-card" style="max-width: 600px; margin: 40px auto;">
Â  Â  Â  Â  Â  Â  <h3 style="color: var(--dark); margin-bottom: 20px; font-size: 1.4rem;">Consultar ExpediÃ§Ãµes por Placa</h3>
Â  Â  Â  Â  Â  Â  <p style="color: #666; margin-bottom: 25px;">Insira a placa do seu veÃ­culo para visualizar suas atividades</p>

Â  Â  Â  Â  Â  Â  <div style="display: flex; gap: 15px; justify-content: center; align-items: end; flex-wrap: wrap;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="min-width: 200px; margin-bottom: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="placaMotorista" style="text-align: left;">Selecione a Placa do VeÃ­culo:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="placaMotorista">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Carregando veÃ­culos...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="consultarExpedicoesPorPlaca()" style="height: 54px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Consultar ExpediÃ§Ãµes
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="resultadosMotorista" style="display: none;">
Â  Â  Â  Â  Â  Â  <h3 style="color: var(--dark); margin-bottom: 20px;">Suas ExpediÃ§Ãµes</h3>
Â  Â  Â  Â  Â  Â  <div id="listaExpedicoesMotorista"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="semResultados" style="display: none; text-align: center; padding: 40px;">
Â  Â  Â  Â  Â  Â  <div class="alert alert-warning">
Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="color: #F77F00; margin-bottom: 15px;"><span class="feature-icon clipboard warning"></span>Nenhuma ExpediÃ§Ã£o Encontrada</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <p style="color: #F77F00; margin: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  NÃ£o foram encontradas expediÃ§Ãµes ativas para a placa informada.
Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â 
Â  Â  <div id="relatoriosMotoristas" class="sub-tab-content">
Â  Â  Â  Â  <h2 style="text-align: center;">RelatÃ³rios de Desempenho</h2>
Â  Â  Â  Â  Â <div id="motoristasStatusList" style="margin-bottom: 30px;">
Â  Â  </div>
Â  Â  Â  Â  <div class="filters-section">
Â  Â  Â  Â  Â  Â  <h3 style="color: var(--dark); margin-bottom: 15px; font-size: 1.2rem;">Filtros</h3>
Â  Â  Â  Â  Â  Â  <div class="filters-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="relatorioMotoristaDataInicio">Data InÃ­cio:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="relatorioMotoristaDataInicio">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="relatorioMotoristaDataFim">Data Fim:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="relatorioMotoristaDataFim">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="text-align: right; margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary btn-small" onclick="generateMotoristaReports()">Gerar RelatÃ³rio</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="stats-grid" id="motoristaReportSummary" style="display:none;">
Â  Â  Â  Â  Â  Â  <div class="stat-card"><div class="stat-number" id="totalMotoristas">0</div><div class="stat-label">Motoristas Ativos</div></div>
Â  Â  Â  Â  Â  Â  <div class="stat-card"><div class="stat-number" id="totalViagensMotoristas">0</div><div class="stat-label">Viagens Realizadas</div></div>
Â  Â  Â  Â  Â  Â  <div class="stat-card"><div class="stat-number" id="totalEntregasMotoristas">0</div><div class="stat-label">Total de Entregas</div></div>
Â  Â  Â  Â  Â  Â  <div class="stat-card"><div class="stat-number" id="produtividadeFrota">0%</div><div class="stat-label">Produtividade da Frota</div></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="motoristaChartsContainer" class="charts-container" style="margin: 20px 0;">
Â  Â  Â  Â  Â  Â  <canvas id="motoristasRankingChart"></canvas>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="motoristaTableContainer" class="table-container"></div>
Â  Â  </div>
</div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="historico" class="tab-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="text-align: center;">HistÃ³rico de Entregas</h2>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="sub-tabs">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="sub-tab active" onclick="showSubTab('historico', 'listaEntregas')">Entregas</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="sub-tab" onclick="showSubTab('historico', 'indicadores')">Indicadores</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaEntregas" class="sub-tab-content active">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filters-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="color: var(--dark); margin-bottom: 15px; font-size: 1.2rem;">Filtros e Pesquisa</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filters-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="historicoFiltroDataInicio">Data InÃ­cio:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="historicoFiltroDataInicio" onchange="applyHistoricoFilters()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="historicoFiltroDataFim">Data Fim:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="historicoFiltroDataFim" onchange="applyHistoricoFilters()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="historicoSearchInput">Pesquisar:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="historicoSearchInput" placeholder="Buscar por loja, doca, placa..." onkeyup="applyHistoricoFilters()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: right; margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary btn-small" onclick="clearHistoricoFilters()">Limpar Filtros</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="historicoList" class="loading">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="spinner"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Carregando histÃ³rico...
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="indicadores" class="sub-tab-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="text-align:center; color: var(--dark);">Indicadores de Desempenho de Entregas</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="filters-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="color: var(--dark); margin-bottom: 15px; font-size: 1.2rem;">Filtros dos Indicadores</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filters-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="indicadoresFiltroDataInicio">Data InÃ­cio:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="indicadoresFiltroDataInicio" onchange="applyHistoricoFilters()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="indicadoresFiltroDataFim">Data Fim:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="indicadoresFiltroDataFim" onchange="applyHistoricoFilters()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="indicadoresSummary" class="time-stats-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="charts-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="chartContainerLojas">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h4 style="text-align:center; color: var(--dark);">Ranking de Lojas por Tempo de Descarga</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="lojasRankingChart"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="chartContainerEntregas">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="text-align:center; color: var(--dark);">DistribuiÃ§Ã£o de Entregas</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="entregasChart"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â <div id="acompanhamento" class="tab-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="text-align: center;">Acompanhamento com Controle de Tempos</h2>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="sub-tabs">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="sub-tab active" onclick="showSubTab('acompanhamento', 'acompanhamentoExpedicoes')">ExpediÃ§Ãµes</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="sub-tab" onclick="showSubTab('acompanhamento', 'acompanhamentoFrota')">Frota</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="acompanhamentoExpedicoes" class="sub-tab-content active">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="totalExpedicoes">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Total de ExpediÃ§Ãµes</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="background: linear-gradient(135deg, #D62828, #F77F00);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="pendentesCount">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Pendentes</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="background: linear-gradient(135deg, #F77F00, #FCBF49);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="emAndamentoCount">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Em Andamento</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-stats-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-stat-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="tempoMedioAlocar">-</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Tempo MÃ©dio<br>Alocar Placa (HH:mm)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-stat-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="tempoMedioChegada">-</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Tempo MÃ©dio<br>Chegada Doca (HH:mm)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-stat-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="tempoMedioCarregamento">-</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Tempo MÃ©dio<br>Carregamento (HH:mm)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-stat-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="tempoMedioTotal">-</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Tempo MÃ©dio<br>Total (HH:mm)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filters-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="color: var(--dark); margin-bottom: 15px; font-size: 1.2rem;">Filtros e Pesquisa</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filters-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="filtroDataInicio">Data InÃ­cio:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="filtroDataInicio" onchange="applyFilters()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="filtroDataFim">Data Fim:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="filtroDataFim" onchange="applyFilters()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="filtroStatus">Status:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="filtroStatus" onchange="applyFilters()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Todos os Status</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="pendente">Pendente</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="aguardando_veiculo">Aguardando VeÃ­culo</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="em_carregamento">Em Carregamento</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="carregado">Carregado</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="aguardando_faturamento">Aguardando Faturamento</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="faturamento_iniciado">Faturando</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="faturado">Faturado</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="saiu_para_entrega">Saiu para Entrega</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="retornando_cd">Retornando CD</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="cancelado">Cancelado</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="searchInput">Pesquisar:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="searchInput" placeholder="Buscar por loja, doca, lÃ­der..." onkeyup="applyFilters()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: right; margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary btn-small" onclick="clearFilters()">Limpar Filtros</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table id="acompanhamentoTable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Data/Hora</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Lojas e Cargas</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Pallets</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>RollTrainers</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Doca</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>LÃ­der</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>VeÃ­culo</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>OcupaÃ§Ã£o</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Motorista</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>AnÃ¡lise Tempos</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>AÃ§Ãµes</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="acompanhamentoBody">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td colspan="12" class="loading">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="spinner"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Carregando dados...
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="acompanhamentoFrota" class="sub-tab-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="text-align: center; color: var(--dark);">Acompanhamento de Ociosidade da Frota</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="filters-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="color: var(--dark); margin-bottom: 15px; font-size: 1rem;">Filtros de Ociosidade</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filters-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="ociosidadeFiltroDataInicio">Data InÃ­cio:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="ociosidadeFiltroDataInicio" onchange="calculateIdleness()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="ociosidadeFiltroDataFim">Data Fim:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="ociosidadeFiltroDataFim" onchange="calculateIdleness()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="ociosidadeSummary" class="time-stats-grid" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-stat-card" style="background: linear-gradient(135deg, #0077B6, #00B4D8);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="ociosidadeTotalMedia">-</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Ociosidade MÃ©dia Total<br>(HH:mm)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-container" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table id="ociosidadeTable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Placa</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Status Atual</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Tempo de Ociosidade</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="ociosidadeBody">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="3" class="loading">Selecione o perÃ­odo para calcular...</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <<div id="configuracoes" class="tab-content">
Â  Â  <h2 style="text-align: center;">Acesso Restrito</h2>
Â  Â  <div id="passwordFormContainer" class="transport-card" style="max-width: 400px; margin: 40px auto;">
Â  Â  Â  Â  <p style="text-align: center; color: var(--dark); margin-bottom: 20px;">Por favor, insira a senha para acessar as configuraÃ§Ãµes.</p>
Â  Â  Â  Â  <form id="passwordForm">
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="userInput">Nome de UsuÃ¡rio:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="userInput" required placeholder="Digite seu nome de usuÃ¡rio...">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="passwordInput">Senha:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="passwordInput" required placeholder="Digite a senha...">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn btn-primary btn-small">Acessar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </form>
Â  Â  Â  Â  <div id="passwordAlert" style="text-align: center; margin-top: 15px;"></div>
Â  Â  </div>

Â  Â  <div id="configuracoesContent" style="display: none;">
Â  Â  Â  Â  <div class="sub-tabs">
Â  Â  Â  Â  Â  Â  <button class="sub-tab active" onclick="showSubTab('configuracoes', 'geral')">Geral</button>
Â  Â  Â  Â  Â  Â  <button class="sub-tab" onclick="showSubTab('configuracoes', 'transporteConfig')">Transporte</button>
Â  Â  Â  Â  Â  Â  <button class="sub-tab" onclick="showSubTab('configuracoes', 'motoristasConfig')">Motoristas</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="geral" class="sub-tab-content active">
Â  Â  Â  Â  Â  Â  <h2 style="text-align: center;">ConfiguraÃ§Ãµes Gerais</h2>
Â  Â  Â  Â  Â  Â  <div class="stats-grid" style="text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="debugLojas">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Lojas Carregadas</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="background: linear-gradient(135deg, #F77F00, #FCBF49);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="debugDocas">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Docas Carregadas</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="background: linear-gradient(135deg, #7209B7, #A663CC);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="debugLideres">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">LÃ­deres Carregados</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="background: linear-gradient(135deg, #0077B6, #023047);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="debugVeiculos">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">VeÃ­culos DisponÃ­veis</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="background: rgba(144, 224, 239, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="text-align: center;">Gerenciar Cadastros</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="extra-buttons" style="margin-top: 15px; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-success btn-small" onclick="showAddForm('loja')">+ Adicionar Loja</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-success btn-small" onclick="showAddForm('doca')">+ Adicionar Doca</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-success btn-small" onclick="showAddForm('lider')">+ Adicionar LÃ­der</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-success btn-small" onclick="showAddForm('veiculo')">+ Adicionar VeÃ­culo</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-success btn-small" onclick="showAddForm('motorista')">+ Adicionar Motorista</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-warning btn-small" onclick="showAddForm('acesso')">+ Adicionar Acesso</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="addFormModal">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="addFormTitle">Adicionar Item</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <form id="addForm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="addFormFields" class="form-grid"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn btn-success">Salvar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-danger" onclick="hideAddForm()">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="addFormAlert"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="background: rgba(144, 224, 239, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="text-align: center;">Status do Sistema</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="systemStatus">Carregando informaÃ§Ãµes do sistema...</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="background: rgba(144, 224, 239, 0.1); padding: 20px; border-radius: 10px; text-align: left;">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="text-align: center;">Log do Sistema</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="debugLog">Sistema iniciado...<br></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="transporteConfig" class="sub-tab-content">
Â  Â  Â  Â  Â  Â  <h2 style="text-align: center;">Gerenciamento de VeÃ­culos</h2>
Â  Â  Â  Â  Â  Â  <div class="table-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table id="veiculosConfigTable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Placa</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Modelo</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Tipo</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Capacidade (Pallets)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Status Atual</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Alterar Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="veiculosConfigBody"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="motoristasConfig" class="sub-tab-content">
Â  Â  Â  Â  Â  Â  <h2 style="text-align: center;">Gerenciamento de Motoristas</h2>
Â  Â  Â  Â  Â  Â  <div class="table-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table id="motoristasConfigTable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Nome</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Produtivo (MatrÃ­cula)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Status Atual</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Alterar Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="motoristasConfigBody"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div> </div>Â 
Â  Â  Â  Â 

Â  Â  <div style="background: var(--dark); color: white; text-align: center; padding: 16px; margin-top: 20px; border-radius: 8px;">
Â  Â  Â  Â  <div style="font-size: 0.9rem; margin-bottom: 8px;">
Â  Â  Â  Â  Â  Â  <strong>Sistema de Controle de ExpediÃ§Ã£o v4.3 - HistÃ³rico de Entregas</strong>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="font-size: 0.8rem; opacity: 0.8; line-height: 1.4;">
Â  Â  Â  Â  Â  Â  Desenvolvido por <strong>Juliano Patrick</strong><br>
Â  Â  Â  Â  Â  Â  <strong>JP Tech Solutions</strong><br>
Â  Â  Â  Â  Â  Â  <span class="feature-icon email white"></span>julianocorrea@bateforte.com.br
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="font-size: 0.7rem; opacity: 0.6; margin-top: 8px;">
Â  Â  Â  Â  Â  Â  Sistema Multi-Filial â€¢ Controle de Tempos â€¢ ValidaÃ§Ã£o QR Code â€¢ Interface Responsiva â€¢ RoteirizaÃ§Ã£o com QR Code â€¢ HistÃ³rico
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="qrModal" class="modal-overlay">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <h3 class="modal-title" id="qrModalTitle"></h3>
Â  Â  Â  Â  Â  Â  <div class="modal-body">
Â  Â  Â  Â  Â  Â  Â  Â  <p id="qrModalMessage"></p>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="qr-reader" style="width: 100%;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="qr-result-display" style="display: none; padding: 10px; background-color: #e9f5ff; border-radius: 8px; margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>QR Code escaneado:</strong> <span id="scannedValue"></span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="manualInputContainer" style="display: none; margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="margin-bottom: 10px; color: #666;">Ou, se a cÃ¢mera nÃ£o estiver disponÃ­vel, insira manualmente:</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="qrCodeInput" placeholder="Simular leitura de QR Code..." style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="modal-footer">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" id="confirmQrBtn" onclick="handleQrScan()">Confirmar</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" onclick="closeQrModal()">Cancelar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="editExpeditionModal" class="modal-overlay">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <h3 class="modal-title">Editar ExpediÃ§Ã£o</h3>
Â  Â  Â  Â  Â  Â  <form id="editExpeditionForm">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="editExpeditionId">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="editStatus">Status:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="editStatus">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="pendente">Pendente</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="aguardando_veiculo">Aguardando VeÃ­culo</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="em_carregamento">Em Carregamento</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="carregado">Carregado</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="aguardando_faturamento">Aguardando Faturamento</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="faturamento_iniciado">Faturando</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="faturado">Faturado</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="saiu_para_entrega">Saiu para Entrega</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="entregue">Entregue</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="cancelado">Cancelado</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="editLojasContainer" style="background: rgba(144, 224, 239, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(0, 212, 170, 0.3); margin: 20px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="color: var(--dark); margin-bottom: 10px;">Lojas e Quantidades</h4>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: right; margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-success btn-small" onclick="addEditLojaLine()">+ Adicionar Loja</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="editObservacoes">ObservaÃ§Ãµes:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="editObservacoes" placeholder="ObservaÃ§Ãµes..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-footer" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn btn-success">Salvar EdiÃ§Ãµes</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-danger" onclick="closeEditModal()">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  <div id="editFormAlert"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // API REST do Supabase
Â  Â  Â  Â  const SUPABASE_URL = 'https://owsoweqqttcmuuaohxke.supabase.co';
Â  Â  Â  Â  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93c293ZXFxdHRjbXV1YW9oeGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyMjQ5OTAsImV4cCI6MjA3MTgwMDk5MH0.Iee27SUOIkhMFvgDWXrW3C38DUuMr0MyVtR-NjF6FRk';

Â  Â  Â  Â  const headers = {
Â  Â  Â  Â  Â  Â  'apikey': SUPABASE_ANON_KEY,
Â  Â  Â  Â  Â  Â  'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  'Prefer': 'return=minimal'
Â  Â  Â  Â  };

Â  Â  Â  Â  // VariÃ¡veis globais para cache
Â  Â  Â  Â  let lojas = [];
Â  Â  Â  Â  let docas = [];
Â  Â  Â  Â  let lideres = [];
Â  Â  Â  Â  let veiculos = [];
Â  Â  Â  Â  let motoristas = [];
Â  Â  Â  Â  let filiais = [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  // VariÃ¡veis para filtros
Â  Â  Â  let allExpeditions = [];
Â  Â  Â  let filteredExpeditions = [];
Â  Â  Â  let allHistorico = [];
Â  Â  Â  let filteredHistorico = [];

Â  Â  Â  // NOVO: Objeto para armazenar dados do usuÃ¡rio logado
Â  Â  Â  let currentUser = null; // Substitui o antigo 'passwordAuthenticated'

Â  Â  Â  Â  // Estado da filial selecionada
Â  Â  Â  Â  let selectedFilial = null;

Â  Â  Â  Â  // InstÃ¢ncia do leitor de QR Code
Â  Â  Â  Â  let html5QrCodeScanner = null;

Â  Â  Â  Â  // VariÃ¡veis globais para contadores de linhas
Â  Â  Â  Â  let lojaLineCounter = 0;
Â  Â  Â  Â  let editLojaLineCounter = 0;
Â  Â  Â  Â  let activeTimers = {}; // Para controlar os cronÃ´metros
Â  Â  Â  Â  let chartInstances = {}; // Para controlar instÃ¢ncias dos grÃ¡ficos

Â  Â  Â  Â  // Sistema de debug melhorado
Â  Â  Â  Â  const debugLog = {
Â  Â  Â  Â  Â  Â  entries: [],
Â  Â  Â  Â  Â  Â  add: function(message, type = 'info') {
Â  Â  Â  Â  Â  Â  Â  Â  const timestamp = new Date().toLocaleTimeString();
Â  Â  Â  Â  Â  Â  Â  Â  const entry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
Â  Â  Â  Â  Â  Â  Â  Â  this.entries.push(entry);

Â  Â  Â  Â  Â  Â  Â  Â  const logContainer = document.getElementById('debugLog');
Â  Â  Â  Â  Â  Â  Â  Â  if (logContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logContainer.innerHTML += entry + '<br>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logContainer.scrollTop = logContainer.scrollHeight;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (this.entries.length > 100) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.entries.shift();
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  console.log(`[DEBUG] ${entry}`);
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  clear: function() {
Â  Â  Â  Â  Â  Â  Â  Â  this.entries = [];
Â  Â  Â  Â  Â  Â  Â  Â  const logContainer = document.getElementById('debugLog');
Â  Â  Â  Â  Â  Â  Â  Â  if (logContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logContainer.innerHTML = 'Log limpo...<br>';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // FunÃ§Ã£o para fazer requisiÃ§Ãµes ao Supabase com filtro de filial
Â  Â  Â  Â  async function supabaseRequest(endpoint, method = 'GET', data = null, includeFilialFilter = true) {
Â  Â  Â  Â  Â  Â  let url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Adicionar filtro de filial automaticamente quando necessÃ¡rio
Â  Â  Â  Â  Â  Â  if (includeFilialFilter && selectedFilial && method === 'GET') {
Â  Â  Â  Â  Â  Â  Â  Â  const separator = url.includes('?') ? '&' : '?';
Â  Â  Â  Â  Â  Â  Â  Â  url += `${separator}filial=eq.${selectedFilial.nome}`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const options = {
Â  Â  Â  Â  Â  Â  Â  Â  method,
Â  Â  Â  Â  Â  Â  Â  Â  headers: { ...headers }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  if (data) {
Â  Â  Â  Â  Â  Â  Â  Â  // Se estÃ¡ criando/atualizando e hÃ¡ filial selecionada, adicionar filial aos dados
Â  Â  Â  Â  Â  Â  Â  Â  if (includeFilialFilter && selectedFilial && (method === 'POST' || method === 'PATCH')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (Array.isArray(data)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data = data.map(item => ({ ...item, filial: selectedFilial.nome }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data = { ...data, filial: selectedFilial.nome };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  options.body = JSON.stringify(data);
Â  Â  Â  Â  Â  Â  Â  Â  options.headers.Prefer = 'return=representation';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  debugLog.add(`Fazendo requisiÃ§Ã£o: ${method} ${url}`, 'request');

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(url, options);

Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorText = await response.text();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro na requisiÃ§Ã£o: ${response.status} - ${errorText}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Erro ${response.status}: ${response.statusText}`);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`RequisiÃ§Ã£o bem-sucedida: ${method} ${endpoint}`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  return method === 'DELETE' ? null : await response.json();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Falha na requisiÃ§Ã£o: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  throw error;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  async function logAction(acao, detalhes = null) {
Â  Â  Â  Â  Â  if (!currentUser) {
Â  Â  Â  Â  Â  Â  Â  console.warn('Tentativa de log sem usuÃ¡rio autenticado.');
Â  Â  Â  Â  Â  Â  Â  return; // NÃ£o faz nada se ninguÃ©m estiver logado nas configs
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  const logData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  usuario_nome: currentUser.nome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  filial: selectedFilial ? selectedFilial.nome : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  acao: acao.toUpperCase(), // Ex: 'EDIÃ‡ÃƒO EXPEDIÃ‡ÃƒO'
Â  Â  Â  Â  Â  Â  Â  Â  Â  detalhes: detalhes
Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  // Usamos o supabaseRequest sem 'await' para nÃ£o travar a interface
Â  Â  Â  Â  Â  Â  Â  // A aÃ§Ã£o Ã© registrada em segundo plano.
Â  Â  Â  Â  Â  Â  Â  supabaseRequest('historico_acessos', 'POST', logData, false);Â 
Â  Â  Â  Â  Â  Â  Â  debugLog.add(`AÃ§Ã£o registrada: ${acao}`, 'log');

Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao registrar aÃ§Ã£o no histÃ³rico:', error);
Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Falha ao registrar aÃ§Ã£o: ${error.message}`, 'error');
Â  Â  Â  Â  Â  }
Â  Â  Â  }


Â  Â  Â  Â  // FunÃ§Ã£o para mostrar notificaÃ§Ãµes
Â  Â  Â  Â  function showNotification(message, type = 'info') {
Â  Â  Â  Â  Â  Â  const notification = document.createElement('div');
Â  Â  Â  Â  Â  Â  notification.className = `notification ${type} slide-in`;
Â  Â  Â  Â  Â  Â  notification.innerHTML = message;
Â  Â  Â  Â  Â  Â  document.body.appendChild(notification);

Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  notification.className = `notification ${type} slide-out`;
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (notification.parentNode) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notification.parentNode.removeChild(notification);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  Â  Â  }, 3000);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Verificar conexÃ£o
Â  Â  Â  Â  async function checkConnection() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add('Verificando conexÃ£o com banco de dados...', 'info');
Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest('filiais?select=nome&limit=1', 'GET', null, false);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('connectionStatus').innerHTML = 'Conectado ao banco de dados - Sistema Multi-Filial Ativo';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('connectionStatus').className = 'connection-status';
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add('ConexÃ£o estabelecida com sucesso', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro de conexÃ£o:', error);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('connectionStatus').innerHTML = 'Erro na conexÃ£o: ' + error.message;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('connectionStatus').className = 'connection-status error';
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Falha na conexÃ£o: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Carregar e exibir filiais disponÃ­veis
Â  Â  Â  Â  async function loadFiliais() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add('Carregando filiais disponÃ­veis...', 'info');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Buscar filiais Ãºnicas no banco
Â  Â  Â  Â  Â  Â  Â  Â  const filiaisData = await supabaseRequest('filiais?select=nome,descricao,ativo&ativo=eq.true&order=nome', 'GET', null, false);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!filiaisData || filiaisData.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('filiaisGrid').innerHTML =Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '<div class="alert alert-warning">Nenhuma filial encontrada no banco de dados.</div>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  filiais = filiaisData;
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`${filiais.length} filiais carregadas`, 'success');

Â  Â  Â  Â  Â  Â  Â  Â  // Renderizar cards de filiais
Â  Â  Â  Â  Â  Â  Â  Â  const grid = document.getElementById('filiaisGrid');
Â  Â  Â  Â  Â  Â  Â  Â  grid.innerHTML = '';

Â  Â  Â  Â  Â  Â  Â  Â  filiais.forEach(filial => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.className = 'filial-card';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.onclick = () => selectFilial(filial);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="feature-icon building primary" style="font-size: 2rem; margin-bottom: 15px; display: block;"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>${filial.nome}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>${filial.descricao || 'DescriÃ§Ã£o nÃ£o informada'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 0.8rem; color: var(--secondary); margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Clique para acessar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid.appendChild(card);
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar filiais:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao carregar filiais: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('filiaisGrid').innerHTML =Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<div class="alert alert-error">Erro ao carregar filiais: ${error.message}</div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Selecionar filial e liberar acesso ao sistema
Â  Â  Â  Â  async function selectFilial(filial) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Filial selecionada: ${filial.nome}`, 'info');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  selectedFilial = filial;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Atualizar indicador de filial
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('filialNome').textContent = filial.nome;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('filialIndicator').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Ocultar seleÃ§Ã£o de filiais e mostrar sistema principal
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('filialSelection').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mainSystem').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Habilitar todas as abas
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.tab').forEach(tab => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tab.classList.add('enabled');
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Carregar dados da filial selecionada
Â  Â  Â  Â  Â  Â  Â  Â  await loadSelectData();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Mostrar primeira aba
Â  Â  Â  Â  Â  Â  Â  Â  showTab('operacao');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`Bem-vindo Ã  filial: ${filial.nome}!`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Sistema liberado para filial: ${filial.nome}`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao selecionar filial:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao selecionar filial: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Erro ao acessar filial: ' + error.message, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Trocar filial (voltar para seleÃ§Ã£o)
Â  Â  Â  Â  function trocarFilial() {
Â  Â  Â  Â  Â  Â  debugLog.add('Trocando filial - voltando para seleÃ§Ã£o', 'info');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Limpar dados da filial atual
Â  Â  Â  Â  Â  Â  selectedFilial = null;
Â  Â  Â  Â  Â  Â  lojas = [];
Â  Â  Â  Â  Â  Â  docas = [];
Â  Â  Â  Â  Â  Â  lideres = [];
Â  Â  Â  Â  Â  Â  veiculos = [];
Â  Â  Â  Â  Â  Â  motoristas = [];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Ocultar indicador e sistema principal
Â  Â  Â  Â  Â  Â  document.getElementById('filialIndicator').classList.remove('active');
Â  Â  Â  Â  Â  Â  document.getElementById('mainSystem').style.display = 'none';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Desabilitar abas
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.tab').forEach(tab => {
Â  Â  Â  Â  Â  Â  Â  Â  tab.classList.remove('enabled', 'active');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Mostrar seleÃ§Ã£o de filiais
Â  Â  Â  Â  Â  Â  document.getElementById('filialSelection').style.display = 'block';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showNotification('Selecione uma nova filial para continuar', 'info');
Â  Â  Â  Â  }

Â  Â  Â  Â  // Carregar dados das tabelas auxiliares (filtrado por filial)
Â  Â  Â  Â  async function loadSelectData() {
Â  Â  Â  Â  Â  Â  if (!selectedFilial) {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add('Nenhuma filial selecionada para carregar dados', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Carregando dados para filial: ${selectedFilial.nome}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  const [lojasData, docasData, lideresData, veiculosData, motoristasData] = await Promise.all([
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  supabaseRequest('lojas?select=*,codlojaqr&ativo=eq.true&order=nome'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  supabaseRequest('docas?ativo=eq.true&order=nome'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  supabaseRequest('lideres?ativo=eq.true&order=nome'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  supabaseRequest('veiculos?order=placa'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  supabaseRequest('motoristas?order=nome')
Â  Â  Â  Â  Â  Â  Â  Â  ]);

Â  Â  Â  Â  Â  Â  Â  Â  lojas = lojasData || [];
Â  Â  Â  Â  Â  Â  Â  Â  docas = docasData || [];
Â  Â  Â  Â  Â  Â  Â  Â  lideres = lideresData || [];
Â  Â  Â  Â  Â  Â  Â  Â  veiculos = veiculosData || [];
Â  Â  Â  Â  Â  Â  Â  Â  motoristas = motoristasData || [];

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Dados carregados para ${selectedFilial.nome}: ${lojas.length} lojas, ${docas.length} docas, ${lideres.length} lÃ­deres, ${veiculos.length} veÃ­culos, ${motoristas.length} motoristas`, 'success');

Â  Â  Â  Â  Â  Â  Â  Â  populateSelects();
Â  Â  Â  Â  Â  Â  Â  Â  updateDebugStats();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar dados:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao carregar dados: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('operacaoAlert', 'Erro ao carregar dados: ' + error.message, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Popular select de loja individual
Â  Â  Â  Â  function populateLojaSelect(selectElement) {
Â  Â  Â  Â  Â  Â  selectElement.innerHTML = '<option value="">Selecione uma loja</option>';
Â  Â  Â  Â  Â  Â  lojas.forEach(loja => {
Â  Â  Â  Â  Â  Â  Â  Â  selectElement.innerHTML += `<option value="${loja.id}">${loja.nome} ${loja.codigo ? '(' + loja.codigo + ')' : ''}</option>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // Popular selects
Â  Â  Â  Â  function populateSelects() {
Â  Â  Â  Â  Â  Â  // Popular todos os selects de lojas existentes
Â  Â  Â  Â  Â  Â  const lojaSelects = document.querySelectorAll('.loja-select');
Â  Â  Â  Â  Â  Â  lojaSelects.forEach(select => {
Â  Â  Â  Â  Â  Â  Â  Â  populateLojaSelect(select);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const docaSelect = document.getElementById('docaSelect');
Â  Â  Â  Â  Â  Â  if (docaSelect) {
Â  Â  Â  Â  Â  Â  Â  Â  docaSelect.innerHTML = '<option value="">Selecione uma doca</option>';
Â  Â  Â  Â  Â  Â  Â  Â  docas.forEach(doca => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  docaSelect.innerHTML += `<option value="${doca.id}">${doca.nome} - ${doca.tipo || 'normal'} (${doca.capacidade_pallets || 0} pallets)</option>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const liderSelect = document.getElementById('liderSelect');
Â  Â  Â  Â  Â  Â  if (liderSelect) {
Â  Â  Â  Â  Â  Â  Â  Â  liderSelect.innerHTML = '<option value="">Selecione um lÃ­der</option>';
Â  Â  Â  Â  Â  Â  Â  Â  lideres.forEach(lider => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  liderSelect.innerHTML += `<option value="${lider.id}">${lider.nome}</option>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Popular o select da aba de motoristas
Â  Â  Â  Â  Â  Â  const placaMotoristaSelect = document.getElementById('placaMotorista');
Â  Â  Â  Â  Â  Â  if (placaMotoristaSelect) {
Â  Â  Â  Â  Â  Â  Â  Â  placaMotoristaSelect.innerHTML = '<option value="">Selecione uma placa</option>';
Â  Â  Â  Â  Â  Â  Â  Â  if (veiculos && veiculos.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  veiculos.forEach(veiculo => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const modelo = veiculo.modelo || 'Modelo nÃ£o informado';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placaMotoristaSelect.innerHTML += `<option value="${veiculo.placa}">${veiculo.placa} - ${modelo}</option>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placaMotoristaSelect.innerHTML = '<option value="">Nenhum veÃ­culo encontrado</option>';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Adicionar nova linha de loja
Â  Â  Â  Â  function addLojaLine() {
Â  Â  Â  Â  Â  Â  lojaLineCounter++;
Â  Â  Â  Â  Â  Â  const container = document.getElementById('lojasContainer');

Â  Â  Â  Â  Â  Â  const newLine = document.createElement('div');
Â  Â  Â  Â  Â  Â  newLine.className = 'loja-line';
Â  Â  Â  Â  Â  Â  newLine.setAttribute('data-index', lojaLineCounter);

Â  Â  Â  Â  Â  Â  newLine.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-bottom: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Loja:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select class="loja-select" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione uma loja</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-bottom: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Pallets:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" class="pallets-input" min="0" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-bottom: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>RollTrainers:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" class="rolltrainers-input" min="0" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; align-items: center; height: 48px; gap: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-success btn-small" onclick="addLojaLine()" style="padding: 12px; border-radius: 8px;">+</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-danger btn-small" onclick="removeLojaLine(${lojaLineCounter})" style="padding: 12px; border-radius: 8px;">-</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  container.appendChild(newLine);
Â  Â  Â  Â  Â  Â  populateLojaSelect(newLine.querySelector('.loja-select'));
Â  Â  Â  Â  Â  Â  debugLog.add(`Nova linha de loja adicionada (Ã­ndice: ${lojaLineCounter})`, 'info');
Â  Â  Â  Â  }

Â  Â  Â  Â  // Remover linha de loja
Â  Â  Â  Â  function removeLojaLine(index) {
Â  Â  Â  Â  Â  Â  const line = document.querySelector(`[data-index="${index}"]`);
Â  Â  Â  Â  Â  Â  if (line) {
Â  Â  Â  Â  Â  Â  Â  Â  line.remove();
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Linha de loja removida (Ã­ndice: ${index})`, 'info');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Mostrar abas (sÃ³ funciona se filial estiver selecionada)
Â  Â  Â  Â  async function showTab(tabName) {
Â  Â  Â  Â  Â  Â  if (!selectedFilial) {
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Selecione uma filial primeiro!', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

Â  Â  Â  Â  Â  Â  document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
Â  Â  Â  Â  Â  Â  document.getElementById(tabName).classList.add('active');

Â  Â  Â  Â  Â  Â  debugLog.add(`Navegando para aba: ${tabName}`, 'info');

Â  Â  Â  Â  Â  Â if (tabName === 'transporte') {
Â  Â  Â  Â  Â  Â  Â  Â  loadTransportList();
Â  Â  Â  Â  Â  Â  } else if (tabName === 'faturamento') {
Â  Â  Â  Â  Â  Â  Â  Â  loadFaturamento();
Â  Â  Â  Â  Â  Â } else if (tabName === 'acompanhamento') {
Â  Â  Â  Â  Â  Â  Â  Â  showSubTab('acompanhamento', 'acompanhamentoExpedicoes');
Â  Â  Â  Â  Â  Â  } else if (tabName === 'motoristas') {
Â  Â  Â  Â  Â  Â  Â  Â  await loadMotoristaTab(); // Garante que a lista de status seja carregada
Â  Â  Â  Â  Â  Â  Â  Â  showSubTab('motoristas', 'consultaViagens'); // Abre a sub-aba padrÃ£o
Â  Â  Â  Â  Â  Â  } else if (tabName === 'historico') {
Â  Â  Â  Â  Â  Â  Â  Â  loadHistorico();
Â  Â  Â  Â  Â  Â  Â  Â  showSubTab('historico', 'listaEntregas');
Â  Â  Â  Â  Â  } else if (tabName === 'configuracoes') {
Â  Â  Â  Â  Â  Â  if (currentUser) { // ALTERADO: Verifica se o objeto currentUser existe
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('passwordFormContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('configuracoesContent').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateSystemStatus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateDebugStats();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('passwordFormContainer').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('configuracoesContent').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  // FunÃ§Ã£o para mostrar sub-abas
// FunÃ§Ã£o para mostrar sub-abas (VERSÃƒO CORRIGIDA)
function showSubTab(tabName, subTabName) {
Â  Â  const tabContent = document.getElementById(tabName);
Â  Â  if (!tabContent) return; // SeguranÃ§a extra

Â  Â  // Limpa todas as sub-abas e conteÃºdos
Â  Â  tabContent.querySelectorAll('.sub-tab').forEach(tab => tab.classList.remove('active'));
Â  Â  tabContent.querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));

Â  Â  // Procura pelo botÃ£o da sub-aba e pelo conteÃºdo a ser exibido
Â  Â  const subTabButton = tabContent.querySelector(`[onclick="showSubTab('${tabName}', '${subTabName}')"]`);
Â  Â  const subTabContentToShow = tabContent.querySelector(`#${subTabName}`);

Â  Â  // --- INÃCIO DA CORREÃ‡ÃƒO ---
Â  Â  // Apenas adiciona a classe 'active' se o botÃ£o da sub-aba existir
Â  Â  if (subTabButton) {
Â  Â  Â  Â  subTabButton.classList.add('active');
Â  Â  }
Â  Â  // --- FIM DA CORREÃ‡ÃƒO ---

Â  Â  // Mostra o conteÃºdo da sub-aba
Â  Â  if (subTabContentToShow) {
Â  Â  Â  Â  subTabContentToShow.classList.add('active');
Â  Â  }

Â  Â  debugLog.add(`Navegando para sub-aba: ${subTabName} em ${tabName}`, 'info');

Â  Â  // LÃ³gica adicional para carregar dados especÃ­ficos da sub-aba
Â  Â  if (subTabName === 'indicadores') {
Â  Â  Â  Â  if (subTabName === 'acompanhamentoFrota') {
Â  Â  Â  Â  calculateIdleness();
Â  Â  } else if (subTabName === 'indicadores') {
Â  Â  Â  Â  applyHistoricoFilters();
Â  Â  }
Â  Â  if (subTabName === 'relatoriosMotoristas') {
Â  Â  Â  Â  generateMotoristaReports();
Â  Â  }
Â  Â  if (tabName === 'configuracoes' && subTabName === 'transporteConfig') {
Â  Â  Â  Â  renderVeiculosConfig();
Â  Â  }
Â  Â  if (tabName === 'configuracoes' && subTabName === 'motoristasConfig') {
Â  Â  renderMotoristasConfig();
}
}

Â  Â  Â  Â  // Definir filtros de data padrÃ£o
Â  Â  Â  Â  function setDefaultDateFilters() {
Â  Â  Â  Â  Â  Â  const hoje = new Date();
Â  Â  Â  Â  Â  Â  const primeiroDiaDoMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);

Â  Â  Â  Â  Â  Â  const filtroInicio = document.getElementById('filtroDataInicio');
Â  Â  Â  Â  Â  Â  const filtroFim = document.getElementById('filtroDataFim');

Â  Â  Â  Â  Â  Â  if (filtroInicio && !filtroInicio.value) {
Â  Â  Â  Â  Â  Â  Â  Â  filtroInicio.value = primeiroDiaDoMes.toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (filtroFim && !filtroFim.value) {
Â  Â  Â  Â  Â  Â  Â  Â  filtroFim.value = hoje.toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Mostrar alertas
Â  Â  Â  Â  function showAlert(containerId, message, type = 'success') {
Â  Â  Â  Â  Â  Â  const container = document.getElementById(containerId);
Â  Â  Â  Â  Â  Â  container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  Â  Â  }, 5000);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Validar formulÃ¡rio com mÃºltiplas lojas
Â  Â  Â  Â  function validateForm() {
Â  Â  Â  Â  Â  Â  const lojaLines = document.querySelectorAll('.loja-line');
Â  Â  Â  Â  Â  Â  const docaSelect = document.getElementById('docaSelect');
Â  Â  Â  Â  Â  Â  const liderSelect = document.getElementById('liderSelect');

Â  Â  Â  Â  Â  Â  if (!docaSelect.value.trim()) {
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('operacaoAlert', 'Campo obrigatÃ³rio: Doca', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  docaSelect.focus();
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (!liderSelect.value.trim()) {
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('operacaoAlert', 'Campo obrigatÃ³rio: LÃ­der', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  liderSelect.focus();
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const lojasSelecionadas = [];
Â  Â  Â  Â  Â  Â  for (let i = 0; i < lojaLines.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const line = lojaLines[i];
Â  Â  Â  Â  Â  Â  Â  Â  const lojaSelect = line.querySelector('.loja-select');
Â  Â  Â  Â  Â  Â  Â  Â  const palletsInput = line.querySelector('.pallets-input');
Â  Â  Â  Â  Â  Â  Â  Â  const rolltrainersInput = line.querySelector('.rolltrainers-input');

Â  Â  Â  Â  Â  Â  Â  Â  if (!lojaSelect.value.trim()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('operacaoAlert', `Selecione uma loja na linha ${i + 1}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lojaSelect.focus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (lojasSelecionadas.includes(lojaSelect.value)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('operacaoAlert', `Loja duplicada na linha ${i + 1}. Cada loja pode ser selecionada apenas uma vez.`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lojaSelect.focus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  lojasSelecionadas.push(lojaSelect.value);

Â  Â  Â  Â  Â  Â  Â  Â  const pallets = parseInt(palletsInput.value);
Â  Â  Â  Â  Â  Â  Â  Â  const rolltrainers = parseInt(rolltrainersInput.value);

Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(pallets) || pallets < 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('operacaoAlert', `Quantidade de pallets invÃ¡lida na linha ${i + 1}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  palletsInput.focus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(rolltrainers) || rolltrainers < 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('operacaoAlert', `Quantidade de RollTrainers invÃ¡lida na linha ${i + 1}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rolltrainersInput.focus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (lojaLines.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('operacaoAlert', 'Adicione pelo menos uma loja', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Salvar expediÃ§Ã£o Ãºnica com mÃºltiplos itens
Â  Â  Â  Â  async function saveExpedition(formData) {
Â  Â  Â  Â  Â  Â  if (!validateForm()) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!selectedFilial) {
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('operacaoAlert', 'Erro: Nenhuma filial selecionada', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const dataHoraLancamento = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  Â  const lojaLines = document.querySelectorAll('.loja-line');

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Criando expediÃ§Ã£o Ãºnica para filial ${selectedFilial.nome} com ${lojaLines.length} lojas`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  // 1. Criar a expediÃ§Ã£o principal
Â  Â  Â  Â  Â  Â  Â  Â  const expeditionData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_hora: dataHoraLancamento,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doca_id: formData.docaId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lider_id: formData.liderId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  observacoes: formData.observacoes || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'pendente',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: dataHoraLancamento
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // filial serÃ¡ adicionada automaticamente pela funÃ§Ã£o supabaseRequest
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  const expeditionResponse = await supabaseRequest('expeditions', 'POST', expeditionData);
Â  Â  Â  Â  Â  Â  Â  Â  const expeditionId = expeditionResponse[0].id;

Â  Â  Â  Â  Â  Â  Â  Â  // 2. Criar os itens da expediÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  const itemsData = [];
Â  Â  Â  Â  Â  Â  Â  Â  lojaLines.forEach((line, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lojaSelect = line.querySelector('.loja-select');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const palletsInput = line.querySelector('.pallets-input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rolltrainersInput = line.querySelector('.rolltrainers-input');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  expedition_id: expeditionId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loja_id: lojaSelect.value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pallets: parseInt(palletsInput.value),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rolltrainers: parseInt(rolltrainersInput.value),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status_descarga: 'pendente' // NOVO: status inicial da descarga
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // filial serÃ¡ adicionada automaticamente pela funÃ§Ã£o supabaseRequest
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsData.push(itemData);
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const itemsPromises = itemsData.map(item => supabaseRequest('expedition_items', 'POST', item));
Â  Â  Â  Â  Â  Â  Â  Â  await Promise.all(itemsPromises);

Â  Â  Â  Â  Â  Â  Â  Â  const lojasResumo = itemsData.map(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loja = lojas.find(l => l.id === item.loja_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `${loja ? loja.nome : 'Loja desconhecida'} (${item.pallets}P + ${item.rolltrainers}R)`;
Â  Â  Â  Â  Â  Â  Â  Â  }).join(', ');

Â  Â  Â  Â  Â  Â  Â  Â  const totalPallets = itemsData.reduce((sum, item) => sum + item.pallets, 0);
Â  Â  Â  Â  Â  Â  Â  Â  const totalRolltrainers = itemsData.reduce((sum, item) => sum + item.rolltrainers, 0);

Â  Â  Â  Â  Â  Â  Â  Â  showAlert('operacaoAlert',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `ExpediÃ§Ã£o criada com sucesso para ${selectedFilial.nome}!<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Lojas (${itemsData.length}):</strong> ${lojasResumo}<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Total:</strong> ${totalPallets} pallets + ${totalRolltrainers} rolltrainers`, 'success');

Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`ExpediÃ§Ã£o criada para ${itemsData.length} lojas na filial ${selectedFilial.nome}!`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  resetMultiLojaForm();

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao salvar expediÃ§Ã£o:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao salvar expediÃ§Ã£o: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('operacaoAlert', `Erro: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Resetar formulÃ¡rio de mÃºltiplas lojas
Â  Â  Â  Â  function resetMultiLojaForm() {
Â  Â  Â  Â  Â  Â  document.getElementById('docaSelect').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('liderSelect').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('observacoes').value = '';

Â  Â  Â  Â  Â  Â  const container = document.getElementById('lojasContainer');
Â  Â  Â  Â  Â  Â  container.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="loja-line" data-index="0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-bottom: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Loja:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select class="loja-select" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione uma loja</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-bottom: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Pallets:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" class="pallets-input" min="0" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-bottom: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>RollTrainers:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" class="rolltrainers-input" min="0" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; align-items: center; height: 48px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-success btn-small" onclick="addLojaLine()" style="padding: 12px; border-radius: 8px;">+</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  lojaLineCounter = 0;
Â  Â  Â  Â  Â  Â  populateLojaSelect(container.querySelector('.loja-select'));
Â  Â  Â  Â  }

Â  Â  Â  Â  // Carregar acompanhamento com dados relacionados completos (filtrado por filial)
Â  Â  Â  Â  async function loadAcompanhamento() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('acompanhamentoExpedicoes');
Â  Â  Â  Â  Â  Â  if (!container) return; // SeguranÃ§a caso a sub-aba ainda nÃ£o exista
Â  Â  Â  Â  Â  Â  if (!selectedFilial) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('acompanhamentoBody').innerHTML =
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '<tr><td colspan="12" class="alert alert-error">Selecione uma filial primeiro!</td></tr>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Carregando expediÃ§Ãµes da filial: ${selectedFilial.nome}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  const expeditions = await supabaseRequest('expeditions?status=not.eq.entregue&order=data_hora.desc');
Â  Â  Â  Â  Â  Â  Â  Â  const items = await supabaseRequest('expedition_items');

Â  Â  Â  Â  Â  Â  Â  Â  const expeditionsWithItems = expeditions.map(exp => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const expItems = items.filter(item => item.expedition_id === exp.id);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const doca = docas.find(d => d.id === exp.doca_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lider = lideres.find(l => l.id === exp.lider_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const veiculo = exp.veiculo_id ? veiculos.find(v => v.id === exp.veiculo_id) : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const motorista = exp.motorista_id ? motoristas.find(m => m.id === exp.motorista_id) : null;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const totalCarga = (expItems.reduce((sum, item) => sum + (item.pallets || 0), 0)) + ((expItems.reduce((sum, item) => sum + (item.rolltrainers || 0), 0)) / 2);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ocupacao = veiculo && veiculo.capacidade_pallets > 0 ? (totalCarga / veiculo.capacidade_pallets) * 100 : 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...exp,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  items: expItems,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_pallets: expItems.reduce((sum, item) => sum + (item.pallets || 0), 0),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_rolltrainers: expItems.reduce((sum, item) => sum + (item.rolltrainers || 0), 0),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lojas_count: expItems.length,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lojas_info: expItems.map(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loja = lojas.find(l => l.id === item.loja_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return loja ? `${loja.nome} (${loja.codigo || 'S/C'})` : 'Loja N/A';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join(', '),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doca_nome: doca ? doca.nome : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lider_nome: lider ? lider.nome : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  veiculo_placa: veiculo ? veiculo.placa : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  veiculo_modelo: veiculo ? veiculo.modelo : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motorista_nome: motorista ? motorista.nome : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  veiculo_capacidade: veiculo ? veiculo.capacidade_pallets : 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ocupacao: ocupacao
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`${expeditionsWithItems.length} expediÃ§Ãµes carregadas para ${selectedFilial.nome}`, 'success');

Â  Â  Â  Â  Â  Â  Â  Â  allExpeditions = expeditionsWithItems;
Â  Â  Â  Â  Â  Â  Â  Â  filteredExpeditions = [...allExpeditions];

Â  Â  Â  Â  Â  Â  Â  Â  applyFilters();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar acompanhamento:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao carregar acompanhamento: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('acompanhamentoBody').innerHTML =
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<tr><td colspan="12" class="alert alert-error">Erro: ${error.message}</td></tr>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Aplicar filtros
Â  Â  Â  Â  function applyFilters() {
Â  Â  Â  Â  Â  Â  const dataInicio = document.getElementById('filtroDataInicio').value;
Â  Â  Â  Â  Â  Â  const dataFim = document.getElementById('filtroDataFim').value;
Â  Â  Â  Â  Â  Â  const status = document.getElementById('filtroStatus').value;
Â  Â  Â  Â  Â  Â  const searchTerm = document.getElementById('searchInput').value.toLowerCase();

Â  Â  Â  Â  Â  Â  filteredExpeditions = allExpeditions.filter(exp => {
Â  Â  Â  Â  Â  Â  Â  Â  if (dataInicio) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const expDate = new Date(exp.data_hora).toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (expDate < dataInicio) return false;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (dataFim) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const expDate = new Date(exp.data_hora).toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (expDate > dataFim) return false;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (status && exp.status !== status) return false;

Â  Â  Â  Â  Â  Â  Â  Â  if (searchTerm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const searchableText = [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exp.lojas_info.toLowerCase(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exp.doca_nome || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exp.lider_nome || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exp.veiculo_placa || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exp.motorista_nome || ''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ].join(' ');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!searchableText.includes(searchTerm)) return false;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  updateStats(filteredExpeditions);
Â  Â  Â  Â  Â  Â  updateTimeStats(filteredExpeditions);
Â  Â  Â  Â  Â  Â  renderAcompanhamentoTableWithItems(filteredExpeditions);

Â  Â  Â  Â  Â  Â  debugLog.add(`Filtros aplicados: ${filteredExpeditions.length}/${allExpeditions.length} expediÃ§Ãµes`, 'info');
Â  Â  Â  Â  }

Â  Â  Â  Â  // Limpar filtros
Â  Â  Â  Â  function clearFilters() {
Â  Â  Â  Â  Â  Â  document.getElementById('filtroDataInicio').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('filtroDataFim').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('filtroStatus').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('searchInput').value = '';

Â  Â  Â  Â  Â  Â  filteredExpeditions = [...allExpeditions];
Â  Â  Â  Â  Â  Â  updateStats(filteredExpeditions);
Â  Â  Â  Â  Â  Â  updateTimeStats(filteredExpeditions);
Â  Â  Â  Â  Â  Â  renderAcompanhamentoTableWithItems(filteredExpeditions);

Â  Â  Â  Â  Â  Â  setDefaultDateFilters();
Â  Â  Â  Â  Â  Â  debugLog.add('Filtros limpos', 'info');
Â  Â  Â  Â  }

Â  Â  Â  Â  // FunÃ§Ã£o para converter minutos para formato HH:mm
Â  Â  Â  Â  function minutesToHHMM(minutes) {
Â  Â  Â  Â  Â  Â  if (minutes === null || minutes === undefined || isNaN(minutes) || minutes < 0) return '-';
Â  Â  Â  Â  Â  Â  const hours = Math.floor(minutes / 60);
Â  Â  Â  Â  Â  Â  const mins = Math.round(minutes % 60);
Â  Â  Â  Â  Â  Â  return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Atualizar estatÃ­sticas de tempo
Â  Â  Â  Â  function updateTimeStats(expeditions) {
Â  Â  Â  Â  Â  Â  const temposAlocacao = [];
Â  Â  Â  Â  Â  Â  const temposChegada = [];
Â  Â  Â  Â  Â  Â  const temposCarregamento = [];
Â  Â  Â  Â  Â  Â  const temposTotal = [];

Â  Â  Â  Â  Â  Â  expeditions.forEach(exp => {
Â  Â  Â  Â  Â  Â  Â  Â  const criadoEm = new Date(exp.data_hora || exp.created_at);
Â  Â  Â  Â  Â  Â  Â  Â  const alocadoEm = exp.data_alocacao_veiculo ? new Date(exp.data_alocacao_veiculo) : null;
Â  Â  Â  Â  Â  Â  Â  Â  const chegadaEm = exp.data_chegada_veiculo ? new Date(exp.data_chegada_veiculo) : null;
Â  Â  Â  Â  Â  Â  Â  Â  const saidaEm = exp.data_saida_veiculo ? new Date(exp.data_saida_veiculo) : null;

Â  Â  Â  Â  Â  Â  Â  Â  if (alocadoEm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const minutosAlocar = Math.round((alocadoEm - criadoEm) / 60000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  temposAlocacao.push(minutosAlocar);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (chegadaEm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const minutosAteChegada = Math.round((chegadaEm - criadoEm) / 60000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  temposChegada.push(minutosAteChegada);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (chegadaEm && saidaEm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const minutosCarregamento = Math.round((saidaEm - chegadaEm) / 60000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  temposCarregamento.push(minutosCarregamento);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (saidaEm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const minutosTotal = Math.round((saidaEm - criadoEm) / 60000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  temposTotal.push(minutosTotal);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const calcularMedia = (array) => array.length > 0 ? Math.round(array.reduce((a, b) => a + b, 0) / array.length) : 0;

Â  Â  Â  Â  Â  Â  document.getElementById('tempoMedioAlocar').textContent = temposAlocacao.length > 0 ? minutesToHHMM(calcularMedia(temposAlocacao)) : '-';
Â  Â  Â  Â  Â  Â  document.getElementById('tempoMedioChegada').textContent = temposChegada.length > 0 ? minutesToHHMM(calcularMedia(temposChegada)) : '-';
Â  Â  Â  Â  Â  Â  document.getElementById('tempoMedioCarregamento').textContent = temposCarregamento.length > 0 ? minutesToHHMM(calcularMedia(temposCarregamento)) : '-';
Â  Â  Â  Â  Â  Â  document.getElementById('tempoMedioTotal').textContent = temposTotal.length > 0 ? minutesToHHMM(calcularMedia(temposTotal)) : '-';
Â  Â  Â  Â  }

Â  Â  Â  Â  // Renderizar tabela com nova estrutura (expediÃ§Ãµes + itens)
Â  Â  Â  Â // Renderizar tabela com nova estrutura (expediÃ§Ãµes + itens)
function renderAcompanhamentoTableWithItems(expeditions) {
Â  Â  const tbody = document.getElementById('acompanhamentoBody');

Â  Â  if (expeditions.length === 0) {
Â  Â  Â  Â  tbody.innerHTML = '<tr><td colspan="12" class="loading">Nenhuma expediÃ§Ã£o encontrada</td></tr>';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const html = expeditions.map(exp => {
Â  Â  Â  Â  const temVeiculo = exp.veiculo_id || exp.veiculo_placa;
Â  Â  Â  Â  const veiculo = temVeiculo ? veiculos.find(v => v.id === exp.veiculo_id) : null;

Â  Â  Â  Â  const criadaEm = new Date(exp.data_hora || exp.created_at);
Â  Â  Â  Â  const alocadaEm = exp.data_alocacao_veiculo ? new Date(exp.data_alocacao_veiculo) : null;
Â  Â  Â  Â  const chegadaEm = exp.data_chegada_veiculo ? new Date(exp.data_chegada_veiculo) : null;
Â  Â  Â  Â  const saidaEm = exp.data_saida_veiculo ? new Date(exp.data_saida_veiculo) : null;

Â  Â  Â  Â  let tempoAlocar = '-';
Â  Â  Â  Â  let tempoAteChegada = '-';
Â  Â  Â  Â  let tempoCarregamento = '-';

Â  Â  Â  Â  if (alocadaEm) {
Â  Â  Â  Â  Â  Â  const minutosAlocar = Math.round((alocadaEm - criadaEm) / 60000);
Â  Â  Â  Â  Â  Â  tempoAlocar = minutesToHHMM(minutosAlocar);
Â  Â  Â  Â  }

Â  Â  Â  Â  if (chegadaEm) {
Â  Â  Â  Â  Â  Â  const minutosAteChegada = Math.round((chegadaEm - criadaEm) / 60000);
Â  Â  Â  Â  Â  Â  tempoAteChegada = minutesToHHMM(minutosAteChegada);
Â  Â  Â  Â  }

Â  Â  Â  Â  if (chegadaEm && saidaEm) {
Â  Â  Â  Â  Â  Â  const minutosCarregamento = Math.round((saidaEm - chegadaEm) / 60000);
Â  Â  Â  Â  Â  Â  tempoCarregamento = minutesToHHMM(minutosCarregamento);
Â  Â  Â  Â  }

Â  Â  Â  Â  const analiseTempos = `
Â  Â  Â  Â  Â  Â  <div style="font-size: 0.7rem; line-height: 1.2;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom: 2px;"><strong>Aloc:</strong> ${tempoAlocar}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom: 2px;"><strong>Total:</strong> ${tempoAteChegada}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>Carreg:</strong> ${tempoCarregamento}</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;

Â  Â  Â  Â  let lojasECargasHTML = '';
Â  Â  Â  Â  if (exp.items && exp.items.length > 0) {
Â  Â  Â  Â  Â  Â  lojasECargasHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-weight: 600; color: var(--primary); margin-bottom: 5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${exp.lojas_count || 0} loja${(exp.lojas_count || 0) !== 1 ? 's' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="carga-details">
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  exp.items.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  const loja = lojas.find(l => l.id === item.loja_id);
Â  Â  Â  Â  Â  Â  Â  Â  const lojaDisplay = loja ? `${loja.nome} (${loja.codigo || 'S/C'})` : 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  lojasECargasHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="carga-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${lojaDisplay}</strong><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.pallets || 0}P + ${item.rolltrainers || 0}R
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  lojasECargasHTML += '</div>';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  lojasECargasHTML = '<div style="color: #999; font-style: italic;">Sem itens</div>';
Â  Â  Â  Â  }

Â  Â  Â  Â  let ocupacaoHtml = '-';
Â  Â  Â  Â  let veiculoInfoHtml = '-';
Â  Â  Â  Â  if (veiculo) {
Â  Â  Â  Â  Â  Â  const cargaTotal = (exp.total_pallets || 0) + ((exp.total_rolltrainers || 0) / 2);
Â  Â  Â  Â  Â  Â  const ocupacaoPerc = veiculo.capacidade_pallets > 0 ? Math.round((cargaTotal / veiculo.capacidade_pallets) * 100) : 0;

Â  Â  Â  Â  Â  Â  let barColor = 'progress-green';
Â  Â  Â  Â  Â  Â  if (ocupacaoPerc >= 80 && ocupacaoPerc <= 100) {
Â  Â  Â  Â  Â  Â  Â  Â  barColor = 'progress-orange';
Â  Â  Â  Â  Â  Â  } else if (ocupacaoPerc > 100) {
Â  Â  Â  Â  Â  Â  Â  Â  barColor = 'progress-red';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  veiculoInfoHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; align-items: center; gap: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 1.2rem; color: #495057;">ğŸšš</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 0.8rem; font-weight: 600; color: #495057;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${exp.veiculo_placa || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  ocupacaoHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-container" style="text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar ${barColor}" style="width: ${Math.min(100, ocupacaoPerc)}%;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${ocupacaoPerc}%</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size: 0.85rem; padding: 10px 6px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-weight: 600;">${new Date(exp.data_hora).toLocaleDateString('pt-BR')}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 0.75rem; color: #666;">${new Date(exp.data_hora).toLocaleTimeString('pt-BR')}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size: 0.8rem; padding: 10px 6px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${lojasECargasHTML}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align: center; font-weight: 700; font-size: 1.1rem; color: var(--primary);">${exp.total_pallets || 0}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align: center; font-weight: 700; font-size: 1.1rem; color: var(--secondary);">${exp.total_rolltrainers || 0}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size: 0.85rem; font-weight: 600;">${exp.doca_nome || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size: 0.85rem; font-weight: 600;">${exp.lider_nome || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="status-badge status-${exp.status}">${getStatusLabel(exp.status)}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${veiculoInfoHtml}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${ocupacaoHtml}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size: 0.85rem; font-weight: 600;">${exp.motorista_nome || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size: 0.75rem; padding: 8px 6px;">${analiseTempos}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px 6px; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-warning btn-small" style="padding: 6px 12px; font-size: 0.8rem;" onclick="openEditModal('${exp.id}')">EDITAR</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger btn-small" style="padding: 6px 12px; font-size: 0.8rem;" onclick="deleteExpedition('${exp.id}')">DEL</button>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  `;
Â  Â  }).join('');

Â  Â  tbody.innerHTML = html;
}

Â  Â  Â  Â  // Atualizar estatÃ­sticas gerais (incluindo novos status)
Â  Â  Â  Â  function updateStats(data) {
Â  Â  Â  Â  Â  Â  const stats = {
Â  Â  Â  Â  Â  Â  Â  Â  total: data.length,
Â  Â  Â  Â  Â  Â  Â  Â  pendentes: data.filter(d => d.status === 'pendente').length,
Â  Â  Â  Â  Â  Â  Â  Â  emAndamento: data.filter(d => ['aguardando_veiculo', 'em_carregamento', 'carregado', 'faturamento_iniciado', 'faturado', 'saiu_para_entrega'].includes(d.status)).length
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  document.getElementById('totalExpedicoes').textContent = stats.total;
Â  Â  Â  Â  Â  Â  document.getElementById('pendentesCount').textContent = stats.pendentes;
Â  Â  Â  Â  Â  Â  document.getElementById('emAndamentoCount').textContent = stats.emAndamento;
Â  Â  Â  Â  }

Â  Â  Â  // Nova funÃ§Ã£o com os status de imobilizado
function getStatusLabel(status) {
Â  Â  const labels = {
Â  Â  Â  Â  'pendente': 'Pendente',
Â  Â  Â  Â  'aguardando_veiculo': 'Aguard. VeÃ­culo',
Â  Â  Â  Â  'em_carregamento': 'Carregando',
Â  Â  Â  Â  'carregado': 'Carregado',
Â  Â  Â  Â  'aguardando_faturamento': 'Aguard. Faturamento',
Â  Â  Â  Â  'faturamento_iniciado': 'Faturando',
Â  Â  Â  Â  'faturado': 'Faturado',
Â  Â  Â  Â  'saiu_para_entrega': 'Saiu p/ Entrega',
Â  Â  Â  Â  'entregue': 'Entregue',
Â  Â  Â  Â  'retornando_cd': 'Retornando CD',
Â  Â  Â  Â  'cancelado': 'Cancelado',
Â  Â  Â  Â  'disponivel': 'DisponÃ­vel',
Â  Â  Â  Â  'em_viagem': 'Em Viagem',
Â  Â  Â  Â  'folga': 'Folga',
Â  Â  Â  Â  // NOVOS STATUS ADICIONADOS
Â  Â  Â  Â  'retornando_com_imobilizado': 'Retornando c/ Imobilizado',
Â  Â  Â  Â  'descarregando_imobilizado': 'Desc. Imobilizado'
Â  Â  };
Â  Â  return labels[status] || status;
}
Â  Â  Â  Â  // --- FunÃ§Ãµes da Aba de Faturamento ---
Â  Â  Â  Â  async function loadFaturamento() {
Â  Â  Â  Â  Â  Â  if (!selectedFilial) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('faturamentoList').innerHTML =Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '<div class="alert alert-error">Selecione uma filial primeiro!</div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Carregando faturamento da filial: ${selectedFilial.nome}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  // Carregar expediÃ§Ãµes aguardando faturamento, em faturamento ou faturadas
Â  Â  Â  Â  Â  Â  Â  Â  const expeditions = await supabaseRequest("expeditions?status=in.(aguardando_faturamento,faturamento_iniciado,faturado)&order=data_hora.desc");
Â  Â  Â  Â  Â  Â  Â  Â  const items = await supabaseRequest('expedition_items');

Â  Â  Â  Â  Â  Â  Â  Â  const expeditionsWithItems = expeditions.map(exp => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const expItems = items.filter(item => item.expedition_id === exp.id);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const doca = docas.find(d => d.id === exp.doca_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lider = lideres.find(l => l.id === exp.lider_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const veiculo = exp.veiculo_id ? veiculos.find(v => v.id === exp.veiculo_id) : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const motorista = exp.motorista_id ? motoristas.find(m => m.id === exp.motorista_id) : null;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...exp,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  items: expItems,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_pallets: expItems.reduce((sum, item) => sum + (item.pallets || 0), 0),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_rolltrainers: expItems.reduce((sum, item) => sum + (item.rolltrainers || 0), 0),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lojas_count: expItems.length,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lojas_info: expItems.map(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loja = lojas.find(l => l.id === item.loja_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return loja ? `${loja.nome} (${loja.codigo || 'S/C'})` : 'Loja N/A';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join(', '),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doca_nome: doca ? doca.nome : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lider_nome: lider ? lider.nome : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  veiculo_placa: veiculo ? veiculo.placa : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  veiculo_modelo: veiculo ? veiculo.modelo : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motorista_nome: motorista ? motorista.nome : null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  updateFaturamentoStats(expeditionsWithItems);
Â  Â  Â  Â  Â  Â  Â  Â  renderFaturamentoList(expeditionsWithItems);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`${expeditionsWithItems.length} expediÃ§Ãµes carregadas para faturamento`, 'success');
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar faturamento:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao carregar faturamento: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('faturamentoList').innerHTML =
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<div class="alert alert-error">Erro: ${error.message}</div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Renderizar lista de faturamento
Â  Â  Â  Â  function renderFaturamentoList(expeditionsList) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('faturamentoList');

Â  Â  Â  Â  Â  Â  if (expeditionsList.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = '<div class="alert alert-success">Nenhuma expediÃ§Ã£o pendente de faturamento!</div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â  expeditionsList.forEach(exp => {
Â  Â  Â  Â  Â  Â  Â  Â  // Calcular tempo desde carregamento
Â  Â  Â  Â  Â  Â  Â  Â  const carregadoEm = exp.data_saida_veiculo ? new Date(exp.data_saida_veiculo) : new Date(exp.data_hora);
Â  Â  Â  Â  Â  Â  Â  Â  const agora = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  const tempoEspera = Math.round((agora - carregadoEm) / 60000);
Â  Â  Â  Â  Â  Â  Â  Â  const tempoEsperaTexto = tempoEspera < 60 ? `${tempoEspera} min` : `${Math.floor(tempoEspera/60)}h ${tempoEspera%60}min`;

Â  Â  Â  Â  Â  Â  Â  Â  const lojasInfo = exp.lojas_info || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  const totalPallets = exp.total_pallets || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const totalRolltrainers = exp.total_rolltrainers || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const quantidadeLojas = exp.lojas_count || 0;

Â  Â  Â  Â  Â  Â  Â  Â  // Definir aÃ§Ãµes baseadas no status
Â  Â  Â  Â  Â  Â  Â  Â  let actionButtons = '';
Â  Â  Â  Â  Â  Â  Â  Â  let statusInfo = '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (exp.status === 'aguardando_faturamento') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusInfo = '<div style="color: var(--primary); font-weight: 600; margin-bottom: 8px;">ğŸ“„ Pronto para iniciar faturamento</div>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionButtons = `<button class="btn btn-success" onclick="iniciarFaturamento('${exp.id}')">Iniciar Faturamento</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (exp.status === 'faturamento_iniciado') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const iniciadoEm = exp.data_inicio_faturamento ? new Date(exp.data_inicio_faturamento) : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tempoFaturamento = iniciadoEm ? Math.round((agora - iniciadoEm) / 60000) : 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tempoFaturamentoTexto = minutesToHHMM(tempoFaturamento);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusInfo = `<div style="color: #F77F00; font-weight: 600; margin-bottom: 8px;">ğŸ“„ Faturamento em andamento hÃ¡ ${tempoFaturamentoTexto}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionButtons = `<button class="btn btn-primary" onclick="finalizarFaturamento('${exp.id}')">Finalizar Faturamento</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (exp.status === 'faturado') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const faturadoEm = exp.data_fim_faturamento ? new Date(exp.data_fim_faturamento) : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusInfo = `<div style="color: #00D4AA; font-weight: 600; margin-bottom: 8px;">âœ… Faturado em ${faturadoEm ? faturadoEm.toLocaleString('pt-BR') : 'N/A'}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionButtons = `<button class="btn btn-warning" onclick="marcarSaiuEntrega('${exp.id}')">Marcar SaÃ­da</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="transport-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Faturamento - ${quantidadeLojas} loja${quantidadeLojas > 1 ? 's' : ''}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="color: var(--secondary); font-weight: 600; margin-bottom: 10px;">${lojasInfo}</div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${statusInfo}

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-display ${tempoEspera > 180 ? 'danger' : tempoEspera > 120 ? 'warning' : 'good'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Carregado hÃ¡:</strong> ${tempoEsperaTexto} ${carregadoEm ? '(em ' + carregadoEm.toLocaleString('pt-BR') + ')' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="transport-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>Pallets:</strong> <span style="color: var(--primary); font-weight: 700; font-size: 1.1rem;">${totalPallets}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>RollTrainers:</strong> <span style="color: var(--secondary); font-weight: 700; font-size: 1.1rem;">${totalRolltrainers}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>Doca:</strong> ${exp.doca_nome || 'N/A'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>LÃ­der:</strong> ${exp.lider_nome || 'N/A'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>VeÃ­culo:</strong> ${exp.veiculo_placa || 'N/A'} - ${exp.veiculo_modelo || 'N/A'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>Motorista:</strong> ${exp.motorista_nome || 'N/A'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>Status:</strong> <span class="status-badge status-${exp.status}">${getStatusLabel(exp.status)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${exp.observacoes ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: rgba(144, 224, 239, 0.1); padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 4px solid var(--primary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="feature-icon note"></span><strong style="color: var(--primary);">ObservaÃ§Ãµes:</strong><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: var(--dark);">${exp.observacoes}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center; margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionButtons}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  container.innerHTML = html;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Atualizar estatÃ­sticas do faturamento
Â  Â  Â  Â  function updateFaturamentoStats(expeditions) {
Â  Â  Â  Â  Â  Â  const stats = {
Â  Â  Â  Â  Â  Â  Â  Â  aguardandoFaturamento: expeditions.filter(e => e.status === 'aguardando_faturamento').length,
Â  Â  Â  Â  Â  Â  Â  Â  emFaturamento: expeditions.filter(e => e.status === 'faturamento_iniciado').length,
Â  Â  Â  Â  Â  Â  Â  Â  faturadas: expeditions.filter(e => e.status === 'faturado').length
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  document.getElementById('totalCarregadas').textContent = stats.aguardandoFaturamento;
Â  Â  Â  Â  Â  Â  document.getElementById('emFaturamento').textContent = stats.emFaturamento;
Â  Â  Â  Â  Â  Â  document.getElementById('faturadas').textContent = stats.faturadas;

Â  Â  Â  Â  Â  Â  // Calcular tempo mÃ©dio de faturamento
Â  Â  Â  Â  Â  Â  const expedicoesComFaturamento = expeditions.filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.data_inicio_faturamento && e.data_fim_faturamento
Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  if (expedicoesComFaturamento.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const temposTotalFaturamento = expedicoesComFaturamento.map(exp => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const inicio = new Date(exp.data_inicio_faturamento);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fim = new Date(exp.data_fim_faturamento);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return Math.round((fim - inicio) / 60000);
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const tempoMedio = Math.round(temposTotalFaturamento.reduce((a, b) => a + b, 0) / temposTotalFaturamento.length);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('tempoMedioFaturamento').textContent = minutesToHHMM(tempoMedio);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('tempoMedioFaturamento').textContent = '-';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Iniciar faturamento
Â  Â  Â  Â  async function iniciarFaturamento(expeditionId) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const dataInicio = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  Â  const usuarioFaturamento = selectedFilial ? selectedFilial.nome : 'Sistema';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Tentando iniciar faturamento para expediÃ§Ã£o ${expeditionId}`, 'info');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const updateData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'faturamento_iniciado',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_inicio_faturamento: dataInicio,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuario_faturamento: usuarioFaturamento
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest(`expeditions?id=eq.${expeditionId}`, 'PATCH', updateData);

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Faturamento iniciado para expediÃ§Ã£o ${expeditionId} Ã s ${new Date(dataInicio).toLocaleTimeString('pt-BR')}`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`Faturamento iniciado Ã s ${new Date(dataInicio).toLocaleTimeString('pt-BR')}!`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  loadFaturamento(); // Recarregar lista
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao iniciar faturamento:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao iniciar faturamento: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Erro ao iniciar faturamento: ' + error.message, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Finalizar faturamento
Â  Â  Â  Â  async function finalizarFaturamento(expeditionId) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const dataFim = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Tentando finalizar faturamento para expediÃ§Ã£o ${expeditionId}`, 'info');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const updateData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'faturado',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_fim_faturamento: dataFim
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest(`expeditions?id=eq.${expeditionId}`, 'PATCH', updateData);

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Faturamento finalizado para expediÃ§Ã£o ${expeditionId} Ã s ${new Date(dataFim).toLocaleTimeString('pt-BR')}`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`Faturamento finalizado Ã s ${new Date(dataFim).toLocaleTimeString('pt-BR')}!`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  loadFaturamento(); // Recarregar lista
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao finalizar faturamento:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao finalizar faturamento: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Erro ao finalizar faturamento: ' + error.message, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Marcar saÃ­da para entrega
Â  Â  Â  Â  async function marcarSaiuEntrega(expeditionId) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Marcando expediÃ§Ã£o ${expeditionId} como saiu para entrega`, 'info');
Â  Â  Â  Â  Â  Â  Â  Â  const dataSaida = new Date().toISOString(); // NOVO: Captura a data de saÃ­da
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest(`expeditions?id=eq.${expeditionId}`, 'PATCH', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'saiu_para_entrega',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_saida_entrega: dataSaida // NOVO: Salva a data de saÃ­da
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`ExpediÃ§Ã£o ${expeditionId} marcada como saiu para entrega`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('ExpediÃ§Ã£o marcada como saiu para entrega!', 'success');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  loadFaturamento(); // Recarregar lista
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao marcar saÃ­da:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao marcar saÃ­da: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Erro ao marcar saÃ­da: ' + error.message, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
// ADICIONE ESTA NOVA FUNÃ‡ÃƒO
async function showYesNoModal(message) {
Â  Â  return new Promise((resolve) => {
Â  Â  Â  Â  // Reutilizando o modal de QR, mas adaptando para Sim/NÃ£o
Â  Â  Â  Â  const modal = document.getElementById('qrModal');
Â  Â  Â  Â  const title = document.getElementById('qrModalTitle');
Â  Â  Â  Â  const messageEl = document.getElementById('qrModalMessage');
Â  Â  Â  Â  const qrReader = document.getElementById('qr-reader');
Â  Â  Â  Â  const confirmBtn = document.getElementById('confirmQrBtn');
Â  Â  Â  Â  const cancelBtn = modal.querySelector('.btn-danger');
Â  Â  Â  Â  const qrResultDisplay = document.getElementById('qr-result-display');
Â  Â  Â  Â  const manualInputContainer = document.getElementById('manualInputContainer');

Â  Â  Â  Â  // Esconde elementos desnecessÃ¡rios
Â  Â  Â  Â  qrReader.style.display = 'none';
Â  Â  Â  Â  qrResultDisplay.style.display = 'none';
Â  Â  Â  Â  manualInputContainer.style.display = 'none';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Configura o modal
Â  Â  Â  Â  title.textContent = "ConfirmaÃ§Ã£o de Retorno";
Â  Â  Â  Â  messageEl.innerHTML = message;
Â  Â  Â  Â  confirmBtn.textContent = 'Sim';
Â  Â  Â  Â  cancelBtn.textContent = 'NÃ£o';
Â  Â  Â  Â  confirmBtn.disabled = false;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Limpa eventos antigos para evitar mÃºltiplos cliques
Â  Â  Â  Â  const newConfirmBtn = confirmBtn.cloneNode(true);
Â  Â  Â  Â  confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const newCancelBtn = cancelBtn.cloneNode(true);
Â  Â  Â  Â  cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

Â  Â  Â  Â  // Define as aÃ§Ãµes
Â  Â  Â  Â  newConfirmBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  closeQrModal();
Â  Â  Â  Â  Â  Â  resolve(true); // Retorna true para "Sim"
Â  Â  Â  Â  };
Â  Â  Â  Â  newCancelBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  closeQrModal();
Â  Â  Â  Â  Â  Â  resolve(false); // Retorna false para "NÃ£o"
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  modal.style.display = 'flex';
Â  Â  });
}
Â  Â  Â  Â  // Carregar transporte
Â  Â  Â  Â  async function loadTransportList() {
Â  Â  Â  Â  Â  Â  if (!selectedFilial) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('transporteList').innerHTML =Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '<div class="alert alert-error">Selecione uma filial primeiro!</div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Carregando expediÃ§Ãµes para transporte da filial: ${selectedFilial.nome}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  const expeditions = await supabaseRequest("expeditions?status=in.(pendente,aguardando_veiculo,em_carregamento)&order=data_hora.desc");
Â  Â  Â  Â  Â  Â  Â  Â  const items = await supabaseRequest('expedition_items');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const availableVehicles = veiculos.filter(v => v.status === 'disponivel').length;
Â  Â  Â  Â  Â  Â  Â  Â  const availableDrivers = motoristas.filter(m => m.status === 'disponivel').length;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('availableVehicles').textContent = availableVehicles;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('availableDrivers').textContent = availableDrivers;

Â  Â  Â  Â  Â  Â  Â  Â  const expeditionsWithItems = expeditions.map(exp => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const expItems = items.filter(item => item.expedition_id === exp.id);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const doca = docas.find(d => d.id === exp.doca_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lider = lideres.find(l => l.id === exp.lider_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const veiculo = exp.veiculo_id ? veiculos.find(v => v.id === exp.veiculo_id) : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const motorista = exp.motorista_id ? motoristas.find(m => m.id === exp.motorista_id) : null;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...exp,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  items: expItems,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_pallets: expItems.reduce((sum, item) => sum + (item.pallets || 0), 0),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_rolltrainers: expItems.reduce((sum, item) => sum + (item.rolltrainers || 0), 0),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lojas_count: expItems.length,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lojas_info: expItems.map(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loja = lojas.find(l => l.id === item.loja_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return loja ? `${loja.nome} (${loja.codigo || 'S/C'})` : 'Loja N/A';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join(', '),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doca_nome: doca ? doca.nome : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lider_nome: lider ? lider.nome : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  veiculo_placa: veiculo ? veiculo.placa : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  veiculo_modelo: veiculo ? veiculo.modelo : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motorista_nome: motorista ? motorista.nome : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  veiculo_capacidade: veiculo ? veiculo.capacidade_pallets : 0
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  allExpeditions = expeditionsWithItems;
Â  Â  Â  Â  Â  Â  Â  Â  renderTransportList(expeditionsWithItems, veiculos, motoristas);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`${expeditionsWithItems.length} expediÃ§Ãµes carregadas para transporte`, 'success');
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar dados:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao carregar transporte: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('transporteList').innerHTML =
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<div class="alert alert-error">Erro: ${error.message}</div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // SUBSTITUA SUA FUNÃ‡ÃƒO ANTIGA POR ESTA VERSÃƒO CORRIGIDA
function renderTransportList(expeditionsList, veiculosList, motoristasList) {
Â  Â  const container = document.getElementById('transporteList');

Â  Â  if (expeditionsList.length === 0) {
Â  Â  Â  Â  container.innerHTML = '<div class="alert alert-success">Nenhuma expediÃ§Ã£o pendente de alocaÃ§Ã£o!</div>';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  let html = '';
Â  Â  expeditionsList.forEach(exp => {
Â  Â  Â  Â  const temVeiculo = exp.veiculo_id || exp.veiculo_placa;
Â  Â  Â  Â  const temMotorista = exp.motorista_id || exp.motorista_nome;

Â  Â  Â  Â  const podeAlterarTransporte = !['em_carregamento', 'carregado', 'saiu_para_entrega', 'entregue'].includes(exp.status);

Â  Â  Â  Â  const criadaEm = new Date(exp.data_hora || exp.created_at);
Â  Â  Â  Â  const agora = new Date();
Â  Â  Â  Â  const tempoEspera = Math.round((agora - criadaEm) / 60000);
Â  Â  Â  Â  const tempoEsperaTexto = tempoEspera < 60 ? `${tempoEspera} min` : `${Math.floor(tempoEspera/60)}h ${tempoEspera%60}min`;

Â  Â  Â  Â  const lojasInfo = exp.lojas_info || 'N/A';
Â  Â  Â  Â  const totalPallets = exp.total_pallets || 0;
Â  Â  Â  Â  const totalRolltrainers = exp.total_rolltrainers || 0;
Â  Â  Â  Â  const quantidadeLojas = exp.lojas_count || 0;

Â  Â  Â  Â  const cargaTotalNecessaria = totalPallets + (totalRolltrainers / 2);

Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  <div class="transport-card">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>ExpediÃ§Ã£o - ${quantidadeLojas} loja${quantidadeLojas > 1 ? 's' : ''}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="color: var(--secondary); font-weight: 600; margin-bottom: 10px;">${lojasInfo}</div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-display ${tempoEspera > 60 ? 'warning' : tempoEspera > 120 ? 'danger' : 'good'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Aguardando hÃ¡:</strong> ${tempoEsperaTexto} (desde ${criadaEm.toLocaleString('pt-BR')})
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="transport-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>Pallets:</strong> <span style="color: var(--primary); font-weight: 700; font-size: 1.1rem;">${totalPallets}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>RollTrainers:</strong> <span style="color: var(--secondary); font-weight: 700; font-size: 1.1rem;">${totalRolltrainers}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>Carga (Pallets):</strong> ${Math.ceil(cargaTotalNecessaria)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>Doca:</strong> ${exp.doca_nome || 'N/A'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>LÃ­der:</strong> ${exp.lider_nome || 'N/A'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>Status:</strong> <span class="status-badge status-${exp.status}">${getStatusLabel(exp.status)}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  ${temVeiculo && temMotorista ? `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: rgba(0, 212, 170, 0.1); padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid rgba(0, 212, 170, 0.3);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="color: var(--dark); margin-bottom: 15px;">Transporte Alocado:</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="transport-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>VeÃ­culo:</strong> ${exp.veiculo_placa || 'N/A'} - ${exp.veiculo_modelo || 'N/A'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>Motorista:</strong> ${exp.motorista_nome || 'N/A'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>Alocado em:</strong> ${exp.data_alocacao_veiculo ? new Date(exp.data_alocacao_veiculo).toLocaleString('pt-BR') : 'N/A'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  ${podeAlterarTransporte ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="showReallocateForm('${exp.id}')">Alterar Transporte</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  ` : `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center; padding: 12px; background: rgba(247, 127, 0, 0.1); border-radius: 8px; border: 1px solid #F77F00;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: #F77F00; font-weight: 600; font-size: 0.9rem;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ”’ Transporte nÃ£o pode ser alterado - Carga em ${getStatusLabel(exp.status)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `}
Â  Â  Â  Â  Â  Â  Â  Â  ` : `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="transport-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>VeÃ­culo:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="veiculo_${exp.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione um veÃ­culo</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${veiculosList.filter(v => v.status === 'disponivel').map(v => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isCompatible = (v.capacidade_pallets || 0) >= cargaTotalNecessaria;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const colorClass = isCompatible ? 'background: rgba(0, 212, 170, 0.1); color: var(--dark);' : 'background: rgba(214, 40, 40, 0.1); color: #D62828;';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<option value="${v.id}" style="${colorClass}" ${!isCompatible ? 'disabled' : ''}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isCompatible ? 'âœ…' : 'âš ï¸'} ${v.placa} - ${v.modelo} (${v.capacidade_pallets || 0} pallets)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </option>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Motorista:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="motorista_${exp.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione um motorista</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${motoristasList.filter(m => m.status === 'disponivel').map(m => `<option value="${m.id}">${m.nome} - PRODUTIVO: ${m.PRODUTIVO || 'N/A'}</option>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-success" onclick="allocateTransport('${exp.id}')">Alocar Agora</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `}

Â  Â  Â  Â  Â  Â  Â  Â  <div id="reallocate_${exp.id}" style="display: none; background: rgba(247, 127, 0, 0.1); padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid #F77F00;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="color: var(--dark); margin-bottom: 15px;">Alterar Transporte:</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="transport-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Novo VeÃ­culo:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="new_veiculo_${exp.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione um veÃ­culo</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${veiculosList.map(v => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isCompatible = (v.capacidade_pallets || 0) >= cargaTotalNecessaria;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const colorClass = isCompatible ? 'background: rgba(0, 212, 170, 0.1); color: var(--dark);' : 'background: rgba(214, 40, 40, 0.1); color: #D62828;';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<option value="${v.id}" style="${colorClass}" ${!isCompatible ? 'disabled' : ''}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isCompatible ? 'âœ…' : 'âš ï¸'} ${v.placa} - ${v.modelo} (${v.capacidade_pallets || 0} pallets)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </option>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Novo Motorista:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="new_motorista_${exp.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione um motorista</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${motoristasList.map(m => `<option value="${m.id}">${m.nome} - PRODUTIVO: ${m.PRODUTIVO || 'N/A'}</option>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-success" onclick="reallocateTransport('${exp.id}')">Confirmar AlteraÃ§Ã£o</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" onclick="hideReallocateForm('${exp.id}')" style="margin-left: 10px;">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  });

Â  Â  container.innerHTML = html;
}

Â  Â  Â  Â  // Mostrar/ocultar formulÃ¡rios de realocaÃ§Ã£o
Â  Â  Â  Â  function showReallocateForm(expeditionId) {
Â  Â  Â  Â  Â  Â  debugLog.add(`Abrindo formulÃ¡rio de realocaÃ§Ã£o para expediÃ§Ã£o ${expeditionId}`, 'info');
Â  Â  Â  Â  Â  Â  document.getElementById(`reallocate_${expeditionId}`).style.display = 'block';
Â  Â  Â  Â  }

Â  Â  Â  Â  function hideReallocateForm(expeditionId) {
Â  Â  Â  Â  Â  Â  debugLog.add(`Fechando formulÃ¡rio de realocaÃ§Ã£o para expediÃ§Ã£o ${expeditionId}`, 'info');
Â  Â  Â  Â  Â  Â  document.getElementById(`reallocate_${expeditionId}`).style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  // VariÃ¡vel para controlar alocaÃ§Ãµes em andamento
Â  Â  Â  Â  let allocatingTransports = new Set();

Â  Â  Â  Â  // FunÃ§Ã£o para requisiÃ§Ãµes com timeout
Â  Â  Â  Â  async function supabaseRequestWithTimeout(endpoint, method = 'GET', data = null, timeoutMs = 30000, includeFilialFilter = true) {
Â  Â  Â  Â  Â  Â  return new Promise(async (resolve, reject) => {
Â  Â  Â  Â  Â  Â  Â  Â  const timeoutId = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reject(new Error('Timeout: OperaÃ§Ã£o demorou mais que 30 segundos'));
Â  Â  Â  Â  Â  Â  Â  Â  }, timeoutMs);

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = await supabaseRequest(endpoint, method, data, includeFilialFilter);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(timeoutId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve(result);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(timeoutId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reject(error);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // Alocar transporte
Â  Â  Â  async function allocateTransport(expeditionId) {
Â  Â  Â  Â  Â  if (allocatingTransports.has(expeditionId)) {
Â  Â  Â  Â  Â  Â  Â  showNotification('Aguarde! AlocaÃ§Ã£o jÃ¡ estÃ¡ sendo processada...', 'warning');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const veiculoSelect = document.getElementById(`veiculo_${expeditionId}`);
Â  Â  Â  Â  Â  const motoristaSelect = document.getElementById(`motorista_${expeditionId}`);
Â  Â  Â  Â  Â  const allocateButton = document.querySelector(`button[onclick="allocateTransport('${expeditionId}')"]`);

Â  Â  Â  Â  Â  if (!veiculoSelect || !motoristaSelect) {
Â  Â  Â  Â  Â  Â  Â  showNotification('Erro: Elementos do formulÃ¡rio nÃ£o encontrados', 'error');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const veiculoId = veiculoSelect.value;
Â  Â  Â  Â  Â  const motoristaId = motoristaSelect.value;

Â  Â  Â  Â  Â  if (!veiculoId || !motoristaId) {
Â  Â  Â  Â  Â  Â  Â  showNotification('Por favor, selecione um veÃ­culo e um motorista!', 'error');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  allocatingTransports.add(expeditionId);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (allocateButton) {
Â  Â  Â  Â  Â  Â  Â  allocateButton.disabled = true;
Â  Â  Â  Â  Â  Â  Â  allocateButton.textContent = 'Alocando...';
Â  Â  Â  Â  Â  Â  Â  allocateButton.style.opacity = '0.6';
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  veiculoSelect.disabled = true;
Â  Â  Â  Â  Â  motoristaSelect.disabled = true;

Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  const selectedVehicle = veiculos.find(v => v.id === veiculoId);
Â  Â  Â  Â  Â  Â  Â  const expedition = allExpeditions.find(e => e.id === expeditionId);
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  if (!selectedVehicle || !expedition) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('VeÃ­culo ou expediÃ§Ã£o nÃ£o encontrados');
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  const cargaTotalNecessaria = expedition.total_pallets + (expedition.total_rolltrainers / 2);
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  if (selectedVehicle.capacidade_pallets < cargaTotalNecessaria) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`VeÃ­culo nÃ£o tem capacidade suficiente. NecessÃ¡rio: ${Math.ceil(cargaTotalNecessaria)} pallets. Capacidade: ${selectedVehicle.capacidade_pallets}`);
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  const dataAlocacao = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Iniciando alocaÃ§Ã£o de transporte para expediÃ§Ã£o ${expeditionId}`, 'info');

Â  Â  Â  Â  Â  Â  Â  const expeditionUpdateData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  veiculo_id: veiculoId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  motorista_id: motoristaId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'aguardando_veiculo',
Â  Â  Â  Â  Â  Â  Â  Â  Â  data_alocacao_veiculo: dataAlocacao
Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  await supabaseRequestWithTimeout(`expeditions?id=eq.${expeditionId}`, 'PATCH', expeditionUpdateData, 30000, false);
Â  Â  Â  Â  Â  Â  Â  debugLog.add('ExpediÃ§Ã£o atualizada com sucesso', 'success');
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  await logAction('ALOCAÃ‡ÃƒO TRANSPORTE', `ExpediÃ§Ã£o ID ${expeditionId} alocada ao veÃ­culo ID ${veiculoId} e motorista ID ${motoristaId}.`);

Â  Â  Â  Â  Â  Â  Â  const secondaryOperations = [];

Â  Â  Â  Â  Â  Â  Â  secondaryOperations.push(
Â  Â  Â  Â  Â  Â  Â  Â  Â  supabaseRequestWithTimeout(`veiculos?id=eq.${veiculoId}`, 'PATCH', { status: 'em_uso' }, 10000, false)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(() => debugLog.add('Status do veÃ­culo atualizado', 'success'))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => debugLog.add(`Aviso: Erro ao atualizar veÃ­culo: ${error.message}`, 'warning'))
Â  Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  Â  secondaryOperations.push(
Â  Â  Â  Â  Â  Â  Â  Â  Â  supabaseRequestWithTimeout(`motoristas?id=eq.${motoristaId}`, 'PATCH', { status: 'em_viagem' }, 10000, false)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(() => debugLog.add('Status do motorista atualizado', 'success'))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => debugLog.add(`Aviso: Erro ao atualizar motorista: ${error.message}`, 'warning'))
Â  Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  Â  await Promise.allSettled(secondaryOperations.map(op =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Promise.race([op, new Promise((_, reject) =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => reject(new Error('Timeout secundÃ¡rio')), 10000)
Â  Â  Â  Â  Â  Â  Â  Â  Â  )])
Â  Â  Â  Â  Â  Â  Â  ));

Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Transporte alocado com sucesso Ã s ${new Date(dataAlocacao).toLocaleTimeString('pt-BR')}`, 'success');
Â  Â  Â  Â  Â  Â  Â  showNotification(`Transporte alocado Ã s ${new Date(dataAlocacao).toLocaleTimeString('pt-BR')}!`, 'success');

Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  await Promise.all([
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadSelectData(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadTransportList()
Â  Â  Â  Â  Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  Â  Â  Â  } catch (reloadError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Aviso: Erro ao recarregar dados: ${reloadError.message}`, 'warning');
Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(loadTransportList, 2000);
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao alocar transporte:', error);
Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao alocar transporte: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  showNotification(`Erro: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  loadTransportList();
Â  Â  Â  Â  Â  Â  Â  }, 2000);

Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  allocatingTransports.delete(expeditionId);
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  if (allocateButton) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  allocateButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  allocateButton.textContent = 'Alocar Agora';
Â  Â  Â  Â  Â  Â  Â  Â  Â  allocateButton.style.opacity = '1';
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  if (veiculoSelect) veiculoSelect.disabled = false;
Â  Â  Â  Â  Â  Â  Â  if (motoristaSelect) motoristaSelect.disabled = false;
Â  Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  Â  // Realocar transporte
Â  Â  Â  Â  // Realocar transporte
Â  Â  Â  Â  Â async function reallocateTransport(expeditionId) {
Â  Â  Â  Â  Â  Â  Â if (allocatingTransports.has(expeditionId)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showNotification('Aguarde! RealocaÃ§Ã£o jÃ¡ estÃ¡ sendo processada...', 'warning');
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â const newVeiculoSelect = document.getElementById(`new_veiculo_${expeditionId}`);
Â  Â  Â  Â  Â  Â  Â const newMotoristaSelect = document.getElementById(`new_motorista_${expeditionId}`);
Â  Â  Â  Â  Â  Â  Â const reallocateButton = document.querySelector(`button[onclick="reallocateTransport('${expeditionId}')"]`);

Â  Â  Â  Â  Â  Â  Â if (!newVeiculoSelect || !newMotoristaSelect) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showNotification('Erro: Elementos do formulÃ¡rio nÃ£o encontrados', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â const newVeiculoId = newVeiculoSelect.value;
Â  Â  Â  Â  Â  Â  Â const newMotoristaId = newMotoristaSelect.value;

Â  Â  Â  Â  Â  Â  Â if (!newVeiculoId || !newMotoristaId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showNotification('Por favor, selecione um novo veÃ­culo e motorista!', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â const selectedVehicle = veiculos.find(v => v.id === newVeiculoId);
Â  Â  Â  Â  Â  Â  Â const expedition = allExpeditions.find(e => e.id === expeditionId);
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â if (!selectedVehicle || !expedition) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showNotification('Erro: Dados nÃ£o encontrados para validaÃ§Ã£o', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â const cargaTotalNecessaria = expedition.total_pallets + (expedition.total_rolltrainers / 2);
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â if (selectedVehicle.capacidade_pallets < cargaTotalNecessaria) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showNotification(`Novo veÃ­culo nÃ£o tem capacidade suficiente. NecessÃ¡rio: ${Math.ceil(cargaTotalNecessaria)} pallets. Capacidade: ${selectedVehicle.capacidade_pallets}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â if (!await showConfirmationModal('Confirma a alteraÃ§Ã£o do transporte? O veÃ­culo e motorista atuais serÃ£o liberados.')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â allocatingTransports.add(expeditionId);
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â if (reallocateButton) {
Â  Â  Â  Â  Â  Â  Â  Â  Â reallocateButton.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â reallocateButton.textContent = 'Realocando...';
Â  Â  Â  Â  Â  Â  Â  Â  Â reallocateButton.style.opacity = '0.6';
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â newVeiculoSelect.disabled = true;
Â  Â  Â  Â  Â  Â  Â newMotoristaSelect.disabled = true;

Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â debugLog.add(`Iniciando realocaÃ§Ã£o de transporte para expediÃ§Ã£o ${expeditionId}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  Â const expeditionData = await supabaseRequestWithTimeout(`expeditions?id=eq.${expeditionId}&select=veiculo_id,motorista_id`, 'GET', null, 30000, false);

Â  Â  Â  Â  Â  Â  Â  Â  Â if (!expeditionData || expeditionData.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(`ExpediÃ§Ã£o ${expeditionId} nÃ£o encontrada`);
Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â  Â  Â const oldExpedition = expeditionData[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â const dataRealocacao = new Date().toISOString();

Â  Â  Â  Â  Â  Â  Â  Â  Â await supabaseRequestWithTimeout(`expeditions?id=eq.${expeditionId}`, 'PATCH', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â veiculo_id: newVeiculoId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â motorista_id: newMotoristaId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â status: 'aguardando_veiculo',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data_alocacao_veiculo: dataRealocacao
Â  Â  Â  Â  Â  Â  Â  Â  Â }, 30000, false);

Â  Â  Â  Â  Â  Â  Â  Â  Â debugLog.add('ExpediÃ§Ã£o realocada com sucesso', 'success');

Â  Â  Â  Â  Â  Â  Â  Â  Â const secondaryOperations = [];

Â  Â  Â  Â  Â  Â  Â  Â  Â // Libera os recursos ANTIGOS
Â  Â  Â  Â  Â  Â  Â  Â  Â if (oldExpedition.veiculo_id) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â secondaryOperations.push(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â supabaseRequestWithTimeout(`veiculos?id=eq.${oldExpedition.veiculo_id}`, 'PATCH', { status: 'disponivel' }, 10000, false)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .then(() => debugLog.add(`VeÃ­culo anterior liberado: ${oldExpedition.veiculo_id}`, 'success'))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .catch(error => debugLog.add(`Aviso: Erro ao liberar veÃ­culo anterior: ${error.message}`, 'warning'))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â );
Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â  Â  Â if (oldExpedition.motorista_id) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â secondaryOperations.push(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â supabaseRequestWithTimeout(`motoristas?id=eq.${oldExpedition.motorista_id}`, 'PATCH', { status: 'disponivel' }, 10000, false)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .then(() => debugLog.add(`Motorista anterior liberado: ${oldExpedition.motorista_id}`, 'success'))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .catch(error => debugLog.add(`Aviso: Erro ao liberar motorista anterior: ${error.message}`, 'warning'))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â );
Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â  Â  Â // <<-- INÃCIO DA CORREÃ‡ÃƒO -->>
Â  Â  Â  Â  Â  Â  Â  Â  Â // Ocupa os NOVOS recursos
Â  Â  Â  Â  Â  Â  Â  Â  Â secondaryOperations.push(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â supabaseRequestWithTimeout(`veiculos?id=eq.${newVeiculoId}`, 'PATCH', { status: 'em_uso' }, 10000, false)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .then(() => debugLog.add('Novo veÃ­culo alocado', 'success'))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .catch(error => debugLog.add(`Aviso: Erro ao alocar novo veÃ­culo: ${error.message}`, 'warning'))
Â  Â  Â  Â  Â  Â  Â  Â  Â );

Â  Â  Â  Â  Â  Â  Â  Â  Â secondaryOperations.push(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â supabaseRequestWithTimeout(`motoristas?id=eq.${newMotoristaId}`, 'PATCH', { status: 'em_viagem' }, 10000, false)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .then(() => debugLog.add('Novo motorista alocado', 'success'))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .catch(error => debugLog.add(`Aviso: Erro ao alocar novo motorista: ${error.message}`, 'warning'))
Â  Â  Â  Â  Â  Â  Â  Â  Â );
Â  Â  Â  Â  Â  Â  Â  Â  Â // <<-- FIM DA CORREÃ‡ÃƒO -->>

Â  Â  Â  Â  Â  Â  Â  Â  Â await Promise.allSettled(secondaryOperations.map(op =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Promise.race([op, new Promise((_, reject) =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â setTimeout(() => reject(new Error('Timeout secundÃ¡rio')), 10000)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â )])
Â  Â  Â  Â  Â  Â  Â  Â  Â ));

Â  Â  Â  Â  Â  Â  Â  Â  Â debugLog.add(`Transporte realocado com sucesso Ã s ${new Date(dataRealocacao).toLocaleTimeString('pt-BR')}`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â showNotification('Transporte alterado com sucesso!', 'success');

Â  Â  Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await Promise.all([
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â loadSelectData(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â loadTransportList()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ]);
Â  Â  Â  Â  Â  Â  Â  Â  Â } catch (reloadError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â debugLog.add(`Aviso: Erro ao recarregar dados: ${reloadError.message}`, 'warning');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â setTimeout(loadTransportList, 2000);
Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error('Erro ao realocar transporte:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â debugLog.add(`Erro ao realocar transporte: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â showNotification(`Erro ao realocar: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â setTimeout(loadTransportList, 2000);

Â  Â  Â  Â  Â  Â  Â } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â allocatingTransports.delete(expeditionId);
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â if (reallocateButton) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â reallocateButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â reallocateButton.textContent = 'Confirmar AlteraÃ§Ã£o';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â reallocateButton.style.opacity = '1';
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â if (newVeiculoSelect) newVeiculoSelect.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â if (newMotoristaSelect) newMotoristaSelect.disabled = false;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â }

Â  Â  Â  Â  // FunÃ§Ã£o para mostrar modal de confirmaÃ§Ã£o
Â  Â  Â  Â  function showConfirmationModal(message) {
Â  Â  Â  Â  Â  Â  return new Promise((resolve) => {
Â  Â  Â  Â  Â  Â  Â  Â  const modal = document.getElementById('qrModal');
Â  Â  Â  Â  Â  Â  Â  Â  const title = document.getElementById('qrModalTitle');
Â  Â  Â  Â  Â  Â  Â  Â  const messageEl = document.getElementById('qrModalMessage');
Â  Â  Â  Â  Â  Â  Â  Â  const qrReader = document.getElementById('qr-reader');
Â  Â  Â  Â  Â  Â  Â  Â  const confirmBtn = document.getElementById('confirmQrBtn');
Â  Â  Â  Â  Â  Â  Â  Â  const qrResultDisplay = document.getElementById('qr-result-display');
Â  Â  Â  Â  Â  Â  Â  Â  const manualInputContainer = document.getElementById('manualInputContainer');

Â  Â  Â  Â  Â  Â  Â  Â  title.textContent = "ConfirmaÃ§Ã£o";
Â  Â  Â  Â  Â  Â  Â  Â  messageEl.innerHTML = message;

Â  Â  Â  Â  Â  Â  Â  Â  qrReader.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  qrResultDisplay.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  manualInputContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  confirmBtn.style.display = 'block';

Â  Â  Â  Â  Â  Â  Â  Â  const newConfirmBtn = confirmBtn.cloneNode(true);
Â  Â  Â  Â  Â  Â  Â  Â  confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const newCancelBtn = modal.querySelector('.btn-danger').cloneNode(true);
Â  Â  Â  Â  Â  Â  Â  Â  modal.querySelector('.btn-danger').parentNode.replaceChild(newCancelBtn, modal.querySelector('.btn-danger'));

Â  Â  Â  Â  Â  Â  Â  Â  newConfirmBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeQrModal();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve(true);
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  newCancelBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeQrModal();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve(false);
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  modal.style.display = 'flex';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // Deletar expediÃ§Ã£o
Â  Â  Â  Â  // Deletar expediÃ§Ã£oÂ 
Â  Â  Â  Â  Â async function deleteExpedition(expeditionId) {Â 
Â  Â  Â  Â  Â  Â  Â if (!await showConfirmationModal('Tem certeza que deseja excluir esta expediÃ§Ã£o? Os veÃ­culos e motoristas alocados serÃ£o liberados.')) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â return;Â 
Â  Â  Â  Â  Â  Â  Â }Â 
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â try {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â debugLog.add(`Iniciando exclusÃ£o da expediÃ§Ã£o ${expeditionId}`, 'info');Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â // 1. ANTES DE DELETAR, PEGAMOS OS DADOS DA EXPEDIÃ‡ÃƒO PARA SABER QUAL VEÃCULO/MOTORISTA LIBERAR
Â  Â  Â  Â  Â  Â  Â  Â  Â const expeditionResponse = await supabaseRequest(`expeditions?id=eq.${expeditionId}&select=veiculo_id,motorista_id`, 'GET', null, false);
Â  Â  Â  Â  Â  Â  Â  Â  Â const expedition = expeditionResponse[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â // 2. AGORA SIM, DELETAMOS A EXPEDIÃ‡ÃƒO
Â  Â  Â  Â  Â  Â  Â  Â  Â await supabaseRequest(`expeditions?id=eq.${expeditionId}`, 'DELETE', null, false);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â debugLog.add('ExpediÃ§Ã£o excluÃ­da com sucesso do banco de dados', 'success');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â // 3. LIBERAMOS O MOTORISTA E O VEÃCULO (SE EXISTIREM)
Â  Â  Â  Â  Â  Â  Â  Â  Â if (expedition && expedition.veiculo_id && expedition.motorista_id) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â debugLog.add(`Liberando veÃ­culo ${expedition.veiculo_id} e motorista ${expedition.motorista_id}`, 'info');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await Promise.all([
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â supabaseRequest(`veiculos?id=eq.${expedition.veiculo_id}`, 'PATCH', { status: 'disponivel' }, false),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â supabaseRequest(`motoristas?id=eq.${expedition.motorista_id}`, 'PATCH', { status: 'disponivel' }, false)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â debugLog.add('VeÃ­culo e motorista liberados com sucesso', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â showNotification('ExpediÃ§Ã£o excluÃ­da e recursos liberados!', 'success');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â // Recarrega os dados de todas as abas relevantes
Â  Â  Â  Â  Â  Â  Â  Â  Â await loadSelectData();
Â  Â  Â  Â  Â  Â  Â  Â  Â loadAcompanhamento();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â loadTransportList();
Â  Â  Â  Â  Â  Â  Â } catch (error) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error('Erro ao excluir expediÃ§Ã£o:', error);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â debugLog.add(`Erro ao excluir: ${error.message}`, 'error');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â showNotification('Erro: ' + error.message, 'error');Â 
Â  Â  Â  Â  Â  Â  Â }Â 
Â  Â  Â  Â  Â }

Â  Â  Â  Â  // --- FunÃ§Ãµes da Aba do Motorista ---
Â  Â  Â  Â  async function loadMotoristaTab() {
Â  Â  Â  Â  Â  Â  debugLog.add('Preparando a aba do motorista', 'info');
Â  Â  Â  Â  Â  Â  document.getElementById('resultadosMotorista').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('semResultados').style.display = 'none';
Â  Â  Â  Â  Â  Â  // NOVO: Renderiza a lista de status dos motoristas sempre que a aba Ã© aberta
Â  Â  Â  Â  Â  Â  await renderMotoristasStatusList();
Â  Â  Â  Â  }
// Nova funÃ§Ã£o com a lÃ³gica de botÃµes condicionais
async function renderMotoristasStatusList() {
Â  Â  const container = document.getElementById('motoristasStatusList');
Â  Â  if (!container) return;

Â  Â  const activeExpeditions = await supabaseRequest(`expeditions?status=not.in.(entregue,cancelado)`);
Â  Â  const returningExpeditions = await supabaseRequest(`expeditions?status=eq.entregue&order=data_hora.desc&limit=50`);

Â  Â  let html = `
Â  Â  Â  Â  <div class="stats-grid">
Â  Â  Â  Â  Â  Â  <div class="stat-card" style="background: var(--primary-gradient);">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number">${motoristas.filter(m => m.status === 'disponivel').length}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Motoristas DisponÃ­veis</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="stat-card" style="background: linear-gradient(135deg, #F77F00, #FCBF49);">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number">${motoristas.filter(m => ['em_viagem', 'descarregando_imobilizado'].includes(m.status)).length}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Em Atividade</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="stat-card" style="background: linear-gradient(135deg, #0077B6, #023047);">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number">${motoristas.filter(m => ['retornando_cd', 'retornando_com_imobilizado'].includes(m.status)).length}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Retornando ao CD</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <h3 style="margin-top: 30px; margin-bottom: 15px; text-align: center; color: var(--dark);">Status dos Motoristas</h3>
Â  Â  `;

Â  Â  const motoristasComStatus = motoristas.map(m => {
Â  Â  Â  Â  const activeExp = activeExpeditions.find(exp => exp.motorista_id === m.id);
Â  Â  Â  Â  if (activeExp) {
Â  Â  Â  Â  Â  Â  return { ...m, displayStatus: activeExp.status, veiculoId: activeExp.veiculo_id };
Â  Â  Â  Â  }
Â  Â  Â  Â  // ALTERAÃ‡ÃƒO: Garante que o status do banco seja usado se nÃ£o houver viagem ativa
Â  Â  Â  Â  const lastExp = returningExpeditions.find(exp => exp.motorista_id === m.id);
Â  Â  Â  Â  return { ...m, displayStatus: m.status, veiculoId: lastExp ? lastExp.veiculo_id : null };
Â  Â  });

Â  Â  motoristasComStatus.sort((a, b) => {
Â  Â  Â  Â  const order = { 'descarregando_imobilizado': 0, 'em_carregamento': 1, 'saiu_para_entrega': 2, 'aguardando_faturamento': 3, 'retornando_com_imobilizado': 4, 'retornando_cd': 5, 'disponivel': 6, 'folga': 7 };
Â  Â  Â  Â  return (order[a.displayStatus] || 99) - (order[b.displayStatus] || 99) || a.nome.localeCompare(b.nome);
Â  Â  });

Â  Â  motoristasComStatus.forEach(m => {
Â  Â  Â  Â  let statusLabel = getStatusLabel(m.displayStatus);
Â  Â  Â  Â  let statusClass = `status-badge status-${m.displayStatus.replace(/ /g, '_')}`;
Â  Â  Â  Â  let actionButton = '';

Â  Â  Â  Â  // LÃ“GICA DE BOTÃ•ES ATUALIZADA
Â  Â  Â  Â  if ((m.displayStatus === 'retornando_cd' || m.displayStatus === 'retornando_com_imobilizado') && m.veiculoId) {
Â  Â  Â  Â  Â  Â  actionButton = `<button class="btn btn-primary btn-small" onclick="marcarRetornoCD('${m.id}', '${m.veiculoId}')" style="margin-left: auto;">Cheguei no CD</button>`;
Â  Â  Â  Â  } else if (m.displayStatus === 'descarregando_imobilizado' && m.veiculoId) {
Â  Â  Â  Â  Â  Â  actionButton = `<button class="btn btn-warning btn-small" onclick="finalizarDescargaImobilizado('${m.id}', '${m.veiculoId}')" style="margin-left: auto;">Finalizar Descarga Imob.</button>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  <div class="motorista-status-item">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong style="font-size: 1rem; color: var(--dark);">${m.nome}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; align-items: center; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="${statusClass}">${statusLabel}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionButton}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  });

Â  Â  container.innerHTML = html;
}

Â  Â  Â  Â  async function consultarExpedicoesPorPlaca() {
Â  Â  Â  Â  Â  Â  const placaSelect = document.getElementById('placaMotorista');
Â  Â  Â  Â  Â  Â  const placa = placaSelect.value.trim();

Â  Â  Â  Â  Â  Â  if (!placa) {
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Por favor, selecione uma placa de veÃ­culo', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (!selectedFilial) {
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Selecione uma filial primeiro!', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  debugLog.add(`Consultando expediÃ§Ãµes para placa: ${placa} na filial: ${selectedFilial.nome}`, 'info');

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // ALTERAÃ‡ÃƒO: IncluÃ­do status 'saiu_para_entrega'
Â  Â  Â  Â  Â  Â  Â  Â  const expeditions = await supabaseRequest("expeditions?status=in.(aguardando_veiculo,em_carregamento,saiu_para_entrega)&order=data_hora.desc");
Â  Â  Â  Â  Â  Â  Â  Â  const items = await supabaseRequest('expedition_items');

Â  Â  Â  Â  Â  Â  Â  Â  const expeditionsWithItems = expeditions
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(exp => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const expItems = items.filter(item => item.expedition_id === exp.id);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const doca = docas.find(d => d.id === exp.doca_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lider = lideres.find(l => l.id === exp.lider_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const veiculo = exp.veiculo_id ? veiculos.find(v => v.id === exp.veiculo_id) : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const motorista = exp.motorista_id ? motoristas.find(m => m.id === exp.motorista_id) : null;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...exp,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  items: expItems, // Manter os itens associados
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_pallets: expItems.reduce((sum, item) => sum + (item.pallets || 0), 0),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_rolltrainers: expItems.reduce((sum, item) => sum + (item.rolltrainers || 0), 0),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lojas_count: expItems.length,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lojas_info: expItems.map(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loja = lojas.find(l => l.id === item.loja_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return loja ? `${loja.nome} (${loja.codigo || 'S/C'})` : 'Loja N/A';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join(', '),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doca_nome: doca ? doca.nome : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doca_id: doca ? doca.id : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lider_nome: lider ? lider.nome : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  veiculo_placa: veiculo ? veiculo.placa : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  veiculo_modelo: veiculo ? veiculo.modelo : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motorista_nome: motorista ? motorista.nome : null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .filter(exp => exp.veiculo_placa && exp.veiculo_placa === placa);

Â  Â  Â  Â  Â  Â  Â  Â  if (expeditionsWithItems.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderExpedicoesMotorista(expeditionsWithItems, placa);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`${expeditionsWithItems.length} expediÃ§Ãµes encontradas para placa ${placa}`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mostrarSemResultados();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Nenhuma expediÃ§Ã£o encontrada para placa ${placa}`, 'info');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao consultar expediÃ§Ãµes:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao consultar expediÃ§Ãµes: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Erro ao consultar expediÃ§Ãµes: ' + error.message, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderExpedicoesMotorista(expeditions, placa) {
Â  Â  Â  Â  Â  Â  document.getElementById('semResultados').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('resultadosMotorista').style.display = 'block';

Â  Â  Â  Â  Â  Â  const container = document.getElementById('listaExpedicoesMotorista');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Limpa timers antigos
Â  Â  Â  Â  Â  Â  Object.values(activeTimers).forEach(clearInterval);
Â  Â  Â  Â  Â  Â  activeTimers = {};

Â  Â  Â  Â  Â  Â  let html = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="transport-card" style="margin-bottom: 25px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="color: var(--primary); margin-bottom: 10px;"><span class="feature-icon truck"></span>VeÃ­culo: ${placa} - Filial: ${selectedFilial.nome}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="color: var(--dark); margin: 0;">${expeditions.length} expediÃ§Ã£o${expeditions.length > 1 ? 'Ãµes' : ''} encontrada${expeditions.length > 1 ? 's' : ''}</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  expeditions.forEach((exp, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const docaCompleta = docas.find(d => d.id === exp.doca_id);
Â  Â  Â  Â  Â  Â  Â  Â  const coddocaValue = docaCompleta ? docaCompleta.coddoca : exp.doca_nome;

Â  Â  Â  Â  Â  Â  Â  Â  const criadaEm = new Date(exp.data_hora || exp.created_at);
Â  Â  Â  Â  Â  Â  Â  Â  const agora = new Date();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="transport-card" style="margin-bottom: 25px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin: 0; color: var(--dark);">Viagem #${index + 1}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge status-${exp.status}">${getStatusLabel(exp.status)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  Â  Â  Â  Â  if (exp.status === 'saiu_para_entrega') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // NOVO: RenderizaÃ§Ã£o para o processo de descarga
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += renderPainelDescarga(exp);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // LÃ³gica existente para carregamento
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tempoEspera = Math.round((agora - criadaEm) / 60000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tempoEsperaTexto = minutesToHHMM(tempoEspera);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let proximaAcao = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let corStatus = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let actionButton = '';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (exp.status === 'aguardando_veiculo') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  proximaAcao = 'ğŸ‘‰ Dirija-se Ã  doca para iniciar o carregamento';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  corStatus = 'var(--primary)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionButton = `<button class="btn btn-success" onclick="openQrModal('iniciar', '${exp.id}', '${coddocaValue}')">Iniciar Carregamento</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (exp.status === 'em_carregamento') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  proximaAcao = 'â³ Aguarde a finalizaÃ§Ã£o do carregamento';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  corStatus = '#F77F00';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionButton = `<button class="btn btn-primary" onclick="openQrModal('finalizar', '${exp.id}', '${coddocaValue}')">Finalizar Carregamento</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: rgba(144, 224, 239, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="color: ${corStatus}; font-weight: 600; margin-bottom: 8px;">${proximaAcao}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="transport-grid" style="margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="feature-icon store"></span><strong>Lojas:</strong> ${exp.lojas_count} (${exp.lojas_info})</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="feature-icon package"></span><strong>Pallets:</strong> <span style="color: var(--primary); font-weight: 700; font-size: 1.1rem;">${exp.total_pallets}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="feature-icon rolltrainer"></span><strong>RollTrainers:</strong> <span style="color: var(--secondary); font-weight: 700; font-size: 1.1rem;">${exp.total_rolltrainers}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="feature-icon dock"></span><strong>Doca:</strong> ${exp.doca_nome} (${coddocaValue})</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="feature-icon user"></span><strong>LÃ­der:</strong> ${exp.lider_nome}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="feature-icon clock"></span><strong>Aguardando hÃ¡:</strong> ${tempoEsperaTexto}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${exp.observacoes ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: rgba(144, 224, 239, 0.1); padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 4px solid var(--primary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="feature-icon note"></span><strong style="color: var(--primary);">ObservaÃ§Ãµes:</strong><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: var(--dark);">${exp.observacoes}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center; margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionButton}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  html += `</div>`;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  container.innerHTML = html;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // NOVO: FunÃ§Ã£o para renderizar o painel de descarga
Â  Â  Â  Â  function renderPainelDescarga(exp) {
Â  Â  Â  Â  Â  Â  let html = '<h3 style="color: var(--dark); margin-bottom: 20px;">Roteiro de Entregas</h3>';
Â  Â  Â  Â  Â  Â  let emTransito = true;
Â  Â  Â  Â  Â  Â  let ultimaDescargaFinalizada = new Date(exp.data_saida_entrega);

Â  Â  Â  Â  Â  Â  exp.items.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  const loja = lojas.find(l => l.id === item.loja_id);
Â  Â  Â  Â  Â  Â  Â  Â  let statusDescargaLabel, statusColor, actionButton = '';

Â  Â  Â  Â  Â  Â  Â  Â  let tempoTransito = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (item.data_inicio_descarga) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const inicioDescarga = new Date(item.data_inicio_descarga);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const minutosTransito = (inicioDescarga - ultimaDescargaFinalizada) / 60000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempoTransito = `<div class="time-display good"><strong>Tempo de TrÃ¢nsito:</strong> ${minutesToHHMM(minutosTransito)}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // CronÃ´metro em tempo real
Â  Â  Â  Â  Â  Â  Â  Â  let timerHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (item.status_descarga === 'em_descarga' && item.data_inicio_descarga) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timerId = `timer_${item.id}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timerHtml = `<div id="${timerId}" class="time-display warning"><strong>Tempo em Loja:</strong> Calculando...</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const startTime = new Date(item.data_inicio_descarga).getTime();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(activeTimers[timerId]) clearInterval(activeTimers[timerId]);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeTimers[timerId] = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const now = new Date().getTime();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diff = now - startTime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const minutes = diff / 60000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timerEl = document.getElementById(timerId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(timerEl) timerEl.innerHTML = `<strong>Tempo em Loja:</strong> ${minutesToHHMM(minutes)}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  Â  Â  if (item.status_descarga === 'pendente' && emTransito) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusDescargaLabel = 'PrÃ³xima Entrega';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusColor = 'var(--primary)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionButton = `<button class="btn btn-success" onclick="openQrModal('iniciar_descarga', '${item.id}', '${loja.codlojaqr || ''}', '${exp.id}')">Iniciar Descarga</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  emTransito = false; // Apenas a primeira pendente pode ser iniciada
Â  Â  Â  Â  Â  Â  Â  Â  } else if (item.status_descarga === 'pendente' && !emTransito) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusDescargaLabel = 'Aguardando';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusColor = '#6c757d';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (item.status_descarga === 'em_descarga') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusDescargaLabel = 'Em Descarga';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusColor = '#F77F00';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionButton = `<button class="btn btn-primary" onclick="openQrModal('finalizar_descarga', '${item.id}', '${loja.codlojaqr || ''}', '${exp.id}')">Finalizar Descarga</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  emTransito = false;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (item.status_descarga === 'descarregado') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusDescargaLabel = 'Descarregado';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusColor = '#00D4AA';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ultimaDescargaFinalizada = new Date(item.data_fim_descarga); // Atualiza para o prÃ³ximo cÃ¡lculo de trÃ¢nsito
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="loja-descarga-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h4><span class="feature-icon store"></span> ${loja ? `${loja.nome} (${loja.codigo || 'S/C'})` : 'N/A'}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span style="font-weight: bold; color: ${statusColor};">${statusDescargaLabel}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="loja-descarga-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>Pallets:</strong> ${item.pallets}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><strong>RollTrainers:</strong> ${item.rolltrainers}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${tempoTransito}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${timerHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.data_inicio_descarga && item.data_fim_descarga ? `<div class="time-display good"><strong>Tempo Total em Loja:</strong> ${minutesToHHMM((new Date(item.data_fim_descarga) - new Date(item.data_inicio_descarga)) / 60000)}</div>` : ''}

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center; margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionButton}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return html;
Â  Â  Â  Â  }

Â  Â  Â  Â  function mostrarSemResultados() {
Â  Â  Â  Â  Â  Â  document.getElementById('resultadosMotorista').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('semResultados').style.display = 'block';
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FunÃ§Ãµes do Modal de QR Code ---
Â  Â  Â  Â  let modalState = {
Â  Â  Â  Â  Â  Â  action: null,
Â  Â  Â  Â  Â  Â  scannedValue: null,
Â  Â  Â  Â  Â  Â  mainId: null,
Â  Â  Â  Â  Â  Â  secondaryId: null,
Â  Â  Â  Â  Â  Â  expectedCode: null
Â  Â  Â  Â  };

Â  Â  Â  Â  // VariÃ¡vel para controlar o estado do scanner
Â  Â  Â  Â  let scannerIsRunning = false;

Â  Â  Â  Â  async function openQrModal(action, mainId, code, secondaryId = null) {
Â  Â  Â  Â  Â  Â  modalState.action = action;
Â  Â  Â  Â  Â  Â  modalState.mainId = mainId;
Â  Â  Â  Â  Â  Â  modalState.secondaryId = secondaryId;
Â  Â  Â  Â  Â  Â  modalState.expectedCode = code;
Â  Â  Â  Â  Â  Â  modalState.scannedValue = null;

Â  Â  Â  Â  Â  Â  const modalTitle = document.getElementById('qrModalTitle');
Â  Â  Â  Â  Â  Â  const modalMessage = document.getElementById('qrModalMessage');
Â  Â  Â  Â  Â  Â  const qrReader = document.getElementById('qr-reader');
Â  Â  Â  Â  Â  Â  const qrResultDisplay = document.getElementById('qr-result-display');
Â  Â  Â  Â  Â  Â  const confirmBtn = document.getElementById('confirmQrBtn');
Â  Â  Â  Â  Â  Â  const manualInputContainer = document.getElementById('manualInputContainer');

Â  Â  Â  Â  Â  Â  qrResultDisplay.style.display = 'none';
Â  Â  Â  Â  Â  Â  confirmBtn.disabled = true;
Â  Â  Â  Â  Â  Â  qrReader.innerHTML = '';
Â  Â  Â  Â  Â  Â  qrReader.style.display = 'block';

Â  Â  Â  Â  Â  Â  if (action === 'iniciar') {
Â  Â  Â  Â  Â  Â  Â  Â  modalTitle.textContent = 'Iniciar Carregamento';
Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.textContent = `Por favor, escaneie o QR Code da Doca (cÃ³digo: ${code}) para iniciar o carregamento.`;
Â  Â  Â  Â  Â  Â  } else if (action === 'finalizar') {
Â  Â  Â  Â  Â  Â  Â  Â  modalTitle.textContent = 'Finalizar Carregamento';
Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.textContent = `Por favor, escaneie o QR Code da Doca (cÃ³digo: ${code}) para finalizar o carregamento.`;
Â  Â  Â  Â  Â  Â  } else if (action === 'iniciar_descarga') {
Â  Â  Â  Â  Â  Â  Â  Â  modalTitle.textContent = 'Iniciar Descarga';
Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.textContent = `Por favor, escaneie o QR Code da Loja (cÃ³digo: ${code}) para iniciar a descarga.`;
Â  Â  Â  Â  Â  Â  } else if (action === 'finalizar_descarga') {
Â  Â  Â  Â  Â  Â  Â  Â  modalTitle.textContent = 'Finalizar Descarga';
Â  Â  Â  Â  Â  Â  Â  Â  modalMessage.textContent = `Por favor, escaneie o QR Code da Loja (cÃ³digo: ${code}) para finalizar a descarga.`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('qrModal').style.display = 'flex';

Â  Â  Â  Â  Â  Â  // Limpar scanner anterior se existir
Â  Â  Â  Â  Â  Â  if (html5QrCodeScanner) {
Â  Â  Â  Â  Â  Â  Â  Â  await stopScannerSafely();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  html5QrCodeScanner = new Html5Qrcode("qr-reader");
Â  Â  Â  Â  Â  Â  const config = { fps: 10, qrbox: { width: 250, height: 250 } };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await html5QrCodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanError);
Â  Â  Â  Â  Â  Â  Â  Â  scannerIsRunning = true;
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add('Scanner de QR Code iniciado com sucesso.', 'info');
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao iniciar scanner: ${error}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  qrReader.innerHTML = '<div style="color: red; padding: 20px;">NÃ£o foi possÃ­vel acessar a cÃ¢mera. Verifique as permissÃµes.</div>';
Â  Â  Â  Â  Â  Â  Â  Â  manualInputContainer.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  scannerIsRunning = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function onScanSuccess(decodedText, decodedResult) {
Â  Â  Â  Â  Â  Â  if (modalState.scannedValue !== decodedText) {
Â  Â  Â  Â  Â  Â  Â  Â  modalState.scannedValue = decodedText;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const scannedValueEl = document.getElementById('scannedValue');
Â  Â  Â  Â  Â  Â  Â  Â  scannedValueEl.textContent = decodedText;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('qr-reader').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('qr-result-display').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('confirmQrBtn').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`QR Code escaneado: ${decodedText}`, 'success');

Â  Â  Â  Â  Â  Â  Â  Â  // Parar o scanner com verificaÃ§Ã£o de estado
Â  Â  Â  Â  Â  Â  Â  Â  stopScannerSafely();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function onScanError(errorMessage) {
Â  Â  Â  Â  Â  Â  // Silenciar erros repetitivos do scanner
Â  Â  Â  Â  }

Â  Â  Â  Â  async function stopScannerSafely() {
Â  Â  Â  Â  Â  Â  if (html5QrCodeScanner && scannerIsRunning) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await html5QrCodeScanner.stop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scannerIsRunning = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add('Scanner parado com sucesso', 'info');
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao parar scanner: ${error}`, 'warning');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scannerIsRunning = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeQrModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('qrModal').style.display = 'none';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Parar o scanner de forma segura
Â  Â  Â  Â  Â  Â  stopScannerSafely().then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  if (html5QrCodeScanner) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html5QrCodeScanner.clear();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html5QrCodeScanner = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }).catch(() => {
Â  Â  Â  Â  Â  Â  Â  Â  // Em caso de erro, apenas limpar
Â  Â  Â  Â  Â  Â  Â  Â  if (html5QrCodeScanner) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html5QrCodeScanner = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  scannerIsRunning = false;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  modalState.action = null;
Â  Â  Â  Â  Â  Â  modalState.mainId = null;
Â  Â  Â  Â  Â  Â  modalState.secondaryId = null;
Â  Â  Â  Â  Â  Â  modalState.expectedCode = null;
Â  Â  Â  Â  Â  Â  modalState.scannedValue = null;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function handleQrScan() {
Â  Â  Â  Â  Â  Â  let valueToProcess = modalState.scannedValue;

Â  Â  Â  Â  Â  Â  if (!valueToProcess) {
Â  Â  Â  Â  Â  Â  Â  Â  valueToProcess = document.getElementById('qrCodeInput').value.trim();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (!valueToProcess) {
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Nenhum QR Code escaneado ou valor inserido.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (valueToProcess.toLowerCase() !== modalState.expectedCode.toLowerCase()) {
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`QR Code incorreto! Esperado: "${modalState.expectedCode}", Recebido: "${valueToProcess}". Por favor, escaneie o local correto.`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`ValidaÃ§Ã£o falhou - Esperado: ${modalState.expectedCode}, Recebido: ${valueToProcess}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  debugLog.add(`QR Code validado com sucesso: ${valueToProcess}`, 'success');

Â  Â  Â  Â  Â  Â  if (modalState.action === 'iniciar') {
Â  Â  Â  Â  Â  Â  Â  Â  await startLoading(modalState.mainId);
Â  Â  Â  Â  Â  Â  } else if (modalState.action === 'finalizar') {
Â  Â  Â  Â  Â  Â  Â  Â  await finishLoading(modalState.mainId);
Â  Â  Â  Â  Â  Â  } else if (modalState.action === 'iniciar_descarga') {
Â  Â  Â  Â  Â  Â  Â  Â  await iniciarDescarga(modalState.mainId, modalState.secondaryId);
Â  Â  Â  Â  Â  Â  } else if (modalState.action === 'finalizar_descarga') {
Â  Â  Â  Â  Â  Â  Â  Â  await finalizarDescarga(modalState.mainId, modalState.secondaryId);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  closeQrModal();
Â  Â  Â  Â  }

Â  Â  Â  Â  async function startLoading(expeditionId) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const doca = docas.find(d => d.coddoca === modalState.expectedCode);
Â  Â  Â  Â  Â  Â  Â  Â  if (!doca) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Doca com cÃ³digo "${modalState.expectedCode}" nÃ£o encontrada no cache local.`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const dataChegada = new Date().toISOString();

Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest(`expeditions?id=eq.${expeditionId}`, 'PATCH', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_chegada_veiculo: dataChegada,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'em_carregamento'
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest(`docas?id=eq.${doca.id}`, 'PATCH', { status: 'em_uso' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Status da doca atualizado para em_uso`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  } catch (docaError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Aviso: NÃ£o foi possÃ­vel atualizar status da doca: ${docaError.message}`, 'warning');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Carregamento iniciado para expediÃ§Ã£o ${expeditionId}. Doca: ${doca.nome} (${modalState.expectedCode})`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`Carregamento iniciado na Doca ${doca.nome}!`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  consultarExpedicoesPorPlaca();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao iniciar carregamento: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Erro ao iniciar carregamento: ' + error.message, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // NOVO: FunÃ§Ãµes para controlar a descarga
Â  Â  Â  Â  async function iniciarDescarga(itemId, expeditionId) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const dataInicio = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Iniciando descarga do item ${itemId}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest(`expedition_items?id=eq.${itemId}`, 'PATCH', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status_descarga: 'em_descarga',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_inicio_descarga: dataInicio
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Descarga iniciada com sucesso!', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  consultarExpedicoesPorPlaca();

Â  Â  Â  Â  Â  Â  } catch(error) {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao iniciar descarga: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Erro ao iniciar descarga: ' + error.message, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

// CÃ“DIGO CORRIGIDO
async function finalizarDescarga(itemId, expeditionId) {
Â  Â  try {
Â  Â  Â  Â  const dataFim = new Date().toISOString();
Â  Â  Â  Â  debugLog.add(`Finalizando descarga do item ${itemId}`, 'info');

Â  Â  Â  Â  await supabaseRequest(`expedition_items?id=eq.${itemId}`, 'PATCH', {
Â  Â  Â  Â  Â  Â  status_descarga: 'descarregado',
Â  Â  Â  Â  Â  Â  data_fim_descarga: dataFim
Â  Â  Â  Â  });

Â  Â  Â  Â  const timerId = `timer_${itemId}`;
Â  Â  Â  Â  if (activeTimers[timerId]) {
Â  Â  Â  Â  Â  Â  clearInterval(activeTimers[timerId]);
Â  Â  Â  Â  Â  Â  delete activeTimers[timerId];
Â  Â  Â  Â  }

Â  Â  Â  Â  const itemsResponse = await supabaseRequest(`expedition_items?expedition_id=eq.${expeditionId}`);
Â  Â  Â  Â  const todosDescarregados = itemsResponse.every(item => item.status_descarga === 'descarregado');

Â  Â  Â  Â  if (todosDescarregados) {
Â  Â  Â  Â  Â  Â  debugLog.add(`Todas as lojas da expediÃ§Ã£o ${expeditionId} foram descarregadas. Finalizando...`, 'info');
Â  Â  Â  Â  Â  Â  await supabaseRequest(`expeditions?id=eq.${expeditionId}`, 'PATCH', {
Â  Â  Â  Â  Â  Â  Â  Â  status: 'entregue'
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // NOVO: Pergunta sobre imobilizados
Â  Â  Â  Â  Â  Â  const retornandoComImobilizado = await showYesNoModal('O motorista estÃ¡ retornando com imobilizados (pallets, rolltainers, etc.)?');
Â  Â  Â  Â  Â  Â  const novoStatusMotorista = retornandoComImobilizado ? 'retornando_com_imobilizado' : 'retornando_cd';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const expeditionDetails = await supabaseRequest(`expeditions?id=eq.${expeditionId}&select=motorista_id`);
Â  Â  Â  Â  Â  Â  if (expeditionDetails && expeditionDetails[0] && expeditionDetails[0].motorista_id) {
Â  Â  Â  Â  Â  Â  Â  Â  const motoristaId = expeditionDetails[0].motorista_id;
Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest(`motoristas?id=eq.${motoristaId}`, 'PATCH', { status: novoStatusMotorista }, false);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Status do motorista ${motoristaId} alterado para '${novoStatusMotorista}'`, 'success');

Â  Â  Â  Â  Â  Â  Â  Â  await loadSelectData();
Â  Â  Â  Â  Â  Â  Â  Â  await renderMotoristasStatusList();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // A notificaÃ§Ã£o foi movida para dentro do IF para ter a lÃ³gica correta
Â  Â  Â  Â  Â  Â  showNotification(`Ãšltima entrega finalizada! Viagem concluÃ­da, status: ${getStatusLabel(novoStatusMotorista)}.`, 'success');

Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showNotification('Descarga da loja finalizada! Prossiga para a prÃ³xima entrega.', 'success');
Â  Â  Â  Â  }

Â  Â  Â  Â  consultarExpedicoesPorPlaca();

Â  Â  } catch(error) {
Â  Â  Â  Â  debugLog.add(`Erro ao finalizar descarga: ${error.message}`, 'error');
Â  Â  Â  Â  showNotification('Erro ao finalizar descarga: ' + error.message, 'error');
Â  Â  }
Â  Â  // A chave extra '}' foi removida daqui.
}
Â  Â  Â  Â  async function finishLoading(expeditionId) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const doca = docas.find(d => d.coddoca === modalState.expectedCode);
Â  Â  Â  Â  Â  Â  Â  Â  if (!doca) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Doca com cÃ³digo "${modalState.expectedCode}" nÃ£o encontrada no cache local.`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const dataSaida = new Date().toISOString();

Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest(`expeditions?id=eq.${expeditionId}`, 'PATCH', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_saida_veiculo: dataSaida,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'aguardando_faturamento'
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest(`docas?id=eq.${doca.id}`, 'PATCH', { status: 'disponivel' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Status da doca atualizado para disponivel`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  } catch (docaError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Aviso: NÃ£o foi possÃ­vel atualizar status da doca: ${docaError.message}`, 'warning');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Carregamento finalizado para expediÃ§Ã£o ${expeditionId}.`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`Carregamento finalizado! ExpediÃ§Ã£o aguardando faturamento.`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  consultarExpedicoesPorPlaca();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao finalizar carregamento: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Erro ao finalizar carregamento: ' + error.message, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FunÃ§Ãµes do Modal de EdiÃ§Ã£o ---
Â  Â  Â  Â  async function openEditModal(expeditionId) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Abrindo modal de ediÃ§Ã£o para expediÃ§Ã£o ${expeditionId}`, 'info');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const expeditionData = await supabaseRequest(`expeditions?id=eq.${expeditionId}`, 'GET', null, false);
Â  Â  Â  Â  Â  Â  Â  Â  if (!expeditionData || expeditionData.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showNotification('ExpediÃ§Ã£o nÃ£o encontrada!', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const expedition = expeditionData[0];
Â  Â  Â  Â  Â  Â  Â  Â  const items = await supabaseRequest(`expedition_items?expedition_id=eq.${expeditionId}`, 'GET', null, false);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('editExpeditionId').value = expeditionId;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('editStatus').value = expedition.status;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('editObservacoes').value = expedition.observacoes || '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const lojasContainer = document.getElementById('editLojasContainer');
Â  Â  Â  Â  Â  Â  Â  Â  lojasContainer.innerHTML = '<h4 style="color: var(--dark); margin-bottom: 10px;">Lojas e Quantidades</h4>';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  editLojaLineCounter = 0;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (items && items.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  items.forEach((item, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addEditLojaLine();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lastLine = document.querySelector(`#editLojasContainer .edit-loja-line:last-child`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (lastLine) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const select = lastLine.querySelector('.edit-loja-select');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const palletsInput = lastLine.querySelector('.edit-pallets-input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rolltrainersInput = lastLine.querySelector('.edit-rolltrainers-input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (select) select.value = item.loja_id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (palletsInput) palletsInput.value = item.pallets || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (rolltrainersInput) rolltrainersInput.value = item.rolltrainers || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addEditLojaLine();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('editExpeditionModal').style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao abrir modal de ediÃ§Ã£o:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao abrir modal de ediÃ§Ã£o: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Erro ao carregar dados para ediÃ§Ã£o: ' + error.message, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeEditModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('editExpeditionModal').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('editFormAlert').innerHTML = '';
Â  Â  Â  Â  }

Â  Â  Â  Â  function addEditLojaLine() {
Â  Â  Â  Â  Â  Â  editLojaLineCounter++;
Â  Â  Â  Â  Â  Â  const container = document.getElementById('editLojasContainer');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const newLine = document.createElement('div');
Â  Â  Â  Â  Â  Â  newLine.className = 'edit-loja-line';
Â  Â  Â  Â  Â  Â  newLine.setAttribute('data-edit-index', editLojaLineCounter);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  newLine.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-bottom: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Loja:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select class="edit-loja-select" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione uma loja</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${lojas.map(loja =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<option value="${loja.id}">${loja.nome} ${loja.codigo ? '(' + loja.codigo + ')' : ''}</option>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-bottom: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Pallets:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" class="edit-pallets-input" min="0" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-bottom: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>RollTrainers:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" class="edit-rolltrainers-input" min="0" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; align-items: center; height: 48px; gap: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-success btn-small" onclick="addEditLojaLine()" style="padding: 12px; border-radius: 8px;">+</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-danger btn-small" onclick="removeEditLojaLine(${editLojaLineCounter})" style="padding: 12px; border-radius: 8px;">-</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  container.appendChild(newLine);
Â  Â  Â  Â  Â  Â  debugLog.add(`Nova linha de ediÃ§Ã£o adicionada (Ã­ndice: ${editLojaLineCounter})`, 'info');
Â  Â  Â  Â  }

Â  Â  Â  Â  function removeEditLojaLine(index) {
Â  Â  Â  Â  Â  Â  const line = document.querySelector(`[data-edit-index="${index}"]`);
Â  Â  Â  Â  Â  Â  if (line) {
Â  Â  Â  Â  Â  Â  Â  Â  line.remove();
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Linha de ediÃ§Ã£o removida (Ã­ndice: ${index})`, 'info');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function saveEditedExpedition() {
Â  Â  Â  Â  Â  Â  const expeditionId = document.getElementById('editExpeditionId').value;
Â  Â  Â  Â  Â  Â  const newStatus = document.getElementById('editStatus').value;
Â  Â  Â  Â  Â  Â  const observacoes = document.getElementById('editObservacoes').value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Salvando ediÃ§Ãµes da expediÃ§Ã£o ${expeditionId}`, 'info');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest(`expeditions?id=eq.${expeditionId}`, 'PATCH', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: newStatus,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  observacoes: observacoes || null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest(`expedition_items?expedition_id=eq.${expeditionId}`, 'DELETE');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const editLines = document.querySelectorAll('.edit-loja-line');
Â  Â  Â  Â  Â  Â  Â  Â  const itemsData = [];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  editLines.forEach(line => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lojaSelect = line.querySelector('.edit-loja-select');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const palletsInput = line.querySelector('.edit-pallets-input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rolltrainersInput = line.querySelector('.edit-rolltrainers-input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (lojaSelect && lojaSelect.value) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsData.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  expedition_id: expeditionId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loja_id: lojaSelect.value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pallets: parseInt(palletsInput.value) || 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rolltrainers: parseInt(rolltrainersInput.value) || 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status_descarga: 'pendente' // NOVO: Garante o status ao editar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // filial serÃ¡ adicionada automaticamente pela funÃ§Ã£o supabaseRequest
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (itemsData.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemsPromises = itemsData.map(item => supabaseRequest('expedition_items', 'POST', item));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await Promise.all(itemsPromises);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await logAction('EDIÃ‡ÃƒO EXPEDIÃ‡ÃƒO', `ExpediÃ§Ã£o ID ${expeditionId} alterada para status '${newStatus}'.`);

debugLog.add('ExpediÃ§Ã£o editada com sucesso', 'success');
showNotification('ExpediÃ§Ã£o atualizada com sucesso!', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add('ExpediÃ§Ã£o editada com sucesso', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('ExpediÃ§Ã£o atualizada com sucesso!', 'success');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  closeEditModal();
Â  Â  Â  Â  Â  Â  Â  Â  loadAcompanhamento();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao salvar ediÃ§Ãµes:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao salvar ediÃ§Ãµes: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('editFormAlert').innerHTML =Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<div class="alert alert-error">Erro ao salvar: ${error.message}</div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- FunÃ§Ãµes da Aba de HistÃ³rico ---
Â  Â  Â  Â  async function loadHistorico() {
Â  Â  Â  Â  Â  Â  if (!selectedFilial) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('historicoList').innerHTML =
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '<div class="alert alert-error">Selecione uma filial primeiro!</div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Carregando histÃ³rico da filial: ${selectedFilial.nome}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  const expeditions = await supabaseRequest('expeditions?status=eq.entregue&order=data_hora.desc');
Â  Â  Â  Â  Â  Â  Â  Â  const items = await supabaseRequest('expedition_items');

Â  Â  Â  Â  Â  Â  Â  Â  const expeditionsWithDetails = expeditions.map(exp => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const expItems = items.filter(item => item.expedition_id === exp.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const veiculo = exp.veiculo_id ? veiculos.find(v => v.id === exp.veiculo_id) : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const totalCarga = (expItems.reduce((sum, item) => sum + (item.pallets || 0), 0)) + ((expItems.reduce((sum, item) => sum + (item.rolltrainers || 0), 0)) / 2);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ocupacao = veiculo && veiculo.capacidade_pallets > 0 ? (totalCarga / veiculo.capacidade_pallets) * 100 : 0;


Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...exp,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  items: expItems,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_pallets: expItems.reduce((sum, item) => sum + (item.pallets || 0), 0),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_rolltrainers: expItems.reduce((sum, item) => sum + (item.rolltrainers || 0), 0),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lojas_count: expItems.length,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lojas_info: expItems.map(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loja = lojas.find(l => l.id === item.loja_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return loja ? `${loja.nome}` : 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join(', '),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doca_nome: docas.find(d => d.id === exp.doca_id)?.nome || 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lider_nome: lideres.find(l => l.id === exp.lider_id)?.nome || 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  veiculo_placa: veiculo?.placa || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motorista_nome: motoristas.find(m => m.id === exp.motorista_id)?.nome || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ocupacao: ocupacao.toFixed(1)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  allHistorico = expeditionsWithDetails;
Â  Â  Â  Â  Â  Â  Â  Â  filteredHistorico = [...allHistorico];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  applyHistoricoFilters();
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`${expeditionsWithDetails.length} expediÃ§Ãµes carregadas para o histÃ³rico`, 'success');

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar histÃ³rico:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao carregar histÃ³rico: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('historicoList').innerHTML =
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<div class="alert alert-error">Erro ao carregar histÃ³rico: ${error.message}</div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Nova funÃ§Ã£o com o cÃ¡lculo e exibiÃ§Ã£o do Tempo de PÃ¡tio
function renderHistorico(expeditions) {
Â  Â  const container = document.getElementById('historicoList');

Â  Â  if (expeditions.length === 0) {
Â  Â  Â  Â  container.innerHTML = '<div class="alert alert-info">Nenhum registro encontrado para os filtros selecionados.</div>';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â Â 

Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â  expeditions.forEach(exp => {
Â  Â  Â  Â  Â  Â  Â  Â  // CÃ¡lculos de tempo
Â  Â  Â  Â  Â  Â  Â  Â  const t0 = new Date(exp.data_hora);
Â  Â  Â  Â  Â  Â  Â  Â  const t6 = exp.data_saida_entrega ? new Date(exp.data_saida_entrega) : null;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Roteiro de entrega
Â  Â  Â  Â  Â  Â  Â  Â  let roteiroHtml = '<div style="margin-top:10px;">';
Â  Â  Â  Â  Â  Â  Â  Â  let ultimaData = t6;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(exp.items && exp.items.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â exp.items.sort((a,b) => new Date(a.data_inicio_descarga) - new Date(b.data_inicio_descarga)).forEach((item, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loja = lojas.find(l => l.id === item.loja_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const t_chegada = item.data_inicio_descarga ? new Date(item.data_inicio_descarga) : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const t_saida = item.data_fim_descarga ? new Date(item.data_fim_descarga) : null;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tempoTransito = ultimaData && t_chegada ? (t_chegada - ultimaData) / 60000 : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tempoEmLoja = t_saida && t_chegada ? (t_saida - t_chegada) / 60000 : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  roteiroHtml += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="loja-descarga-card" style="padding: 10px; margin-bottom: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong style="font-size:0.9rem;">${index + 1}. ${loja.nome}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${tempoTransito !== null ? `<div class="time-display" style="font-size:0.7rem; padding: 4px 8px;"><strong>TrÃ¢nsito:</strong> ${minutesToHHMM(tempoTransito)}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${tempoEmLoja !== null ? `<div class="time-display good" style="font-size:0.7rem; padding: 4px 8px;"><strong>Em Loja:</strong> ${minutesToHHMM(tempoEmLoja)}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t_saida) ultimaData = t_saida;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  roteiroHtml += '</div>'
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="historico-card" style="padding: 16px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="font-size:1.1rem;">Viagem de ${new Date(exp.data_hora).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' })}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="color: #666; font-size: 0.8rem;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>VeÃ­culo:</strong> ${exp.veiculo_placa || 'N/A'} |Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Motorista:</strong> ${exp.motorista_nome || 'N/A'} |
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Lojas:</strong> ${exp.lojas_count}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div style="text-align: right;">
Â  Â  <span class="status-badge status-entregue">Entregue</span>
Â  Â  <div style="font-weight: bold; font-size:0.8rem; margin-top: 5px;">OcupaÃ§Ã£o: ${exp.ocupacao}%</div>
Â  Â  <button class="btn btn-danger btn-small" style="margin-top: 10px; padding: 6px 10px;" onclick="deleteHistoricoExpedition('${exp.id}')">Excluir</button>
</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${roteiroHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  container.innerHTML = html;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function applyHistoricoFilters() {
Â  Â  Â  Â  Â  Â  const dataInicio = document.getElementById('historicoFiltroDataInicio').value || document.getElementById('indicadoresFiltroDataInicio').value;
Â  Â  Â  Â  Â  Â  const dataFim = document.getElementById('historicoFiltroDataFim').value || document.getElementById('indicadoresFiltroDataFim').value;
Â  Â  Â  Â  Â  Â  const searchTerm = document.getElementById('historicoSearchInput').value.toLowerCase();

Â  Â  Â  Â  Â  Â  filteredHistorico = allHistorico.filter(exp => {
Â  Â  Â  Â  Â  Â  Â  Â  if (dataInicio) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const expDate = new Date(exp.data_hora).toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (expDate < dataInicio) return false;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (dataFim) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const expDate = new Date(exp.data_hora).toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (expDate > dataFim) return false;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (searchTerm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const searchableText = [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exp.lojas_info.toLowerCase(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exp.doca_nome.toLowerCase(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exp.veiculo_placa?.toLowerCase() || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exp.motorista_nome?.toLowerCase() || ''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ].join(' ');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!searchableText.includes(searchTerm)) return false;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  renderHistorico(filteredHistorico);
Â  Â  Â  Â  Â  Â  generateHistoricoIndicators(filteredHistorico);
Â  Â  Â  Â  }

Â  Â  Â  Â  function clearHistoricoFilters(){
Â  Â  Â  Â  Â  Â  document.getElementById('historicoFiltroDataInicio').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('historicoFiltroDataFim').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('historicoSearchInput').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('indicadoresFiltroDataInicio').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('indicadoresFiltroDataFim').value = '';
Â  Â  Â  Â  Â  Â  filteredHistorico = [...allHistorico];
Â  Â  Â  Â  Â  Â  renderHistorico(filteredHistorico);
Â  Â  Â  Â  Â  Â  generateHistoricoIndicators(filteredHistorico);
Â  Â  Â  Â  }


Â  Â Â 

Â  Â  Â  Â  async function forceSyncData() {
Â  Â  Â  Â  Â  Â  debugLog.add('Iniciando sincronizaÃ§Ã£o forÃ§ada...', 'info');
Â  Â  Â  Â  Â  Â  showNotification('Sincronizando dados...', 'info');

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await loadSelectData();
Â  Â  Â  Â  Â  Â  Â  Â  loadAcompanhamento();
Â  Â  Â  Â  Â  Â  Â  Â  updateDebugStats();
Â  Â  Â  Â  Â  Â  Â  Â  updateSystemStatus();

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add('SincronizaÃ§Ã£o concluÃ­da com sucesso', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Dados sincronizados com sucesso!', 'success');
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro na sincronizaÃ§Ã£o: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Erro na sincronizaÃ§Ã£o: ' + error.message, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function testConnection() {
Â  Â  Â  Â  Â  Â  debugLog.add('Testando conexÃ£o com Supabase...', 'info');

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const startTime = performance.now();
Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest('filiais?select=nome&limit=1', 'GET', null, false);
Â  Â  Â  Â  Â  Â  Â  Â  const endTime = performance.now();
Â  Â  Â  Â  Â  Â  Â  Â  const responseTime = Math.round(endTime - startTime);

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`ConexÃ£o OK - Tempo de resposta: ${responseTime}ms`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`ConexÃ£o OK (${responseTime}ms)`, 'success');
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Falha na conexÃ£o: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Falha na conexÃ£o: ' + error.message, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function clearCache() {
Â  Â  Â  Â  Â  Â  lojas = [];
Â  Â  Â  Â  Â  Â  docas = [];
Â  Â  Â  Â  Â  Â  lideres = [];
Â  Â  Â  Â  Â  Â  veiculos = [];
Â  Â  Â  Â  Â  Â  motoristas = [];

Â  Â  Â  Â  Â  Â  const lojaSelects = document.querySelectorAll('.loja-select');
Â  Â  Â  Â  Â  Â  lojaSelects.forEach(select => {
Â  Â  Â  Â  Â  Â  Â  Â  select.innerHTML = '<option value="">Carregue os dados...</option>';
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const docaSelect = document.getElementById('docaSelect');
Â  Â  Â  Â  Â  Â  if (docaSelect) {
Â  Â  Â  Â  Â  Â  Â  Â  docaSelect.innerHTML = '<option value="">Carregue os dados...</option>';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const liderSelect = document.getElementById('liderSelect');
Â  Â  Â  Â  Â  Â  if (liderSelect) {
Â  Â  Â  Â  Â  Â  Â  Â  liderSelect.innerHTML = '<option value="">Carregue os dados...</option>';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  updateDebugStats();
Â  Â  Â  Â  Â  Â  debugLog.add('Cache limpo', 'info');
Â  Â  Â  Â  Â  Â  showNotification('Cache limpo!', 'success');
Â  Â  Â  Â  }

Â  Â  Â  Â  function clearDebugLog() {
Â  Â  Â  Â  Â  Â  debugLog.clear();
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateDebugStats() {
Â  Â  Â  Â  Â  Â  document.getElementById('debugLojas').textContent = lojas.length;
Â  Â  Â  Â  Â  Â  document.getElementById('debugDocas').textContent = docas.length;
Â  Â  Â  Â  Â  Â  document.getElementById('debugLideres').textContent = lideres.length;
Â  Â  Â  Â  Â  Â  document.getElementById('debugVeiculos').textContent = veiculos.filter(v => v.status === 'disponivel').length;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function updateSystemStatus() {
Â  Â  Â  Â  Â  Â  const status = document.getElementById('systemStatus');
Â  Â  Â  Â  Â  Â  if (!status) return;

Â  Â  Â  Â  Â  Â  const systemInfo = `
DESENVOLVEDOR: Juliano Patrick - JP Tech Solutions
CONTATO: julianocorrea@bateforte.com.br

FILIAL ATIVA: ${selectedFilial ? selectedFilial.nome : 'Nenhuma selecionada'}
URL do Supabase: ${SUPABASE_URL}
Data/Hora: ${new Date().toLocaleString('pt-BR')}

SISTEMA MULTI-FILIAL ATIVO:
âœ“ Controle por filial implementado
âœ“ Filtros automÃ¡ticos por filial
âœ“ Timestamps automÃ¡ticos no lanÃ§amento
âœ“ Controle de alocaÃ§Ã£o de veÃ­culos
âœ“ Registro manual de chegada/saÃ­da na doca
âœ“ CÃ¡lculos automÃ¡ticos de tempo
âœ“ ValidaÃ§Ã£o QR Code com coddoca
âœ“ Interface responsiva para mobile
âœ“ RoteirizaÃ§Ã£o e controle de descarga com QR Code
âœ“ HistÃ³rico de entregas com anÃ¡lise de tempo

CACHE LOCAL:
â€¢ Lojas: ${lojas.length} carregadas
â€¢ Docas: ${docas.length} carregadas
â€¢ LÃ­deres: ${lideres.length} carregados
â€¢ VeÃ­culos: ${veiculos.length} carregados
â€¢ Motoristas: ${motoristas.length} carregados

STATUS: Sistema multi-filial funcionando normalmente
VERSÃƒO: 4.3 - HistÃ³rico de Entregas
DESENVOLVIDO POR: JP Tech Solutions
ÃšLTIMA ATUALIZAÃ‡ÃƒO: ${new Date().toLocaleTimeString()}
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  status.textContent = systemInfo;
Â  Â  Â  Â  }

Â  Â  Â  Â  // FormulÃ¡rios de cadastro com filial
Â  Â  Â  Â  function showAddForm(type) {
Â  Â  Â  Â  Â  Â  if (!selectedFilial) {
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Selecione uma filial primeiro!', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  debugLog.add(`Abrindo formulÃ¡rio: ${type}`, 'info');

Â  Â  Â  Â  Â  Â  const modal = document.getElementById('addFormModal');
Â  Â  Â  Â  Â  Â  const title = document.getElementById('addFormTitle');
Â  Â  Â  Â  Â  Â  const fieldsContainer = document.getElementById('addFormFields');

Â  Â  Â  Â  Â  Â  modal.style.display = 'block';

Â  Â  Â  Â  Â  Â  if (type === 'loja') {
Â  Â  Â  Â  Â  Â  Â  Â  title.textContent = `Adicionar Nova Loja - ${selectedFilial.nome}`;
Â  Â  Â  Â  Â  Â  Â  Â  fieldsContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_nome">Nome da Loja:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="add_nome" required placeholder="Ex: Big Box Loja 88">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_codigo">CÃ³digo da Loja:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="add_codigo" required placeholder="Ex: BIG088">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_cidade">Cidade:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="add_cidade" required placeholder="Ex: CuiabÃ¡, RondonÃ³polis">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_codlojaqr">CÃ³digo QR da Loja:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="add_codlojaqr" required placeholder="Ex: LOJA_BIG088" style="text-transform: uppercase;" onkeyup="this.value = this.value.toUpperCase()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Filial:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" value="${selectedFilial.nome}" disabled style="background: #f5f5f5;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  } else if (type === 'doca') {
Â  Â  Â  Â  Â  Â  Â  Â  title.textContent = `Adicionar Nova Doca - ${selectedFilial.nome}`;
Â  Â  Â  Â  Â  Â  Â  Â  fieldsContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_nome">Nome da Doca:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="add_nome" required placeholder="Ex: Doca 1, Doca A, etc.">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_capacidade_pallets">Capacidade (Pallets):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="add_capacidade_pallets" min="0" required placeholder="Ex: 30">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_coddoca">CÃ³digo da Doca (QR Code):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="add_coddoca" required placeholder="Ex: DOCA1, DOCA_A">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Filial:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" value="${selectedFilial.nome}" disabled style="background: #f5f5f5;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  } else if (type === 'lider') {
Â  Â  Â  Â  Â  Â  Â  Â  title.textContent = `Adicionar Novo LÃ­der - ${selectedFilial.nome}`;
Â  Â  Â  Â  Â  Â  Â  Â  fieldsContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_nome">Nome do LÃ­der:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="add_nome" required placeholder="Ex: JoÃ£o Silva Santos">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_codigo_funcionario">CÃ³digo FuncionÃ¡rio (MatrÃ­cula):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="add_codigo_funcionario" required placeholder="Ex: LID001, 79105100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Filial:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" value="${selectedFilial.nome}" disabled style="background: #f5f5f5;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  } else if (type === 'veiculo') {
Â  Â  Â  Â  Â  Â  Â  Â  title.textContent = `Adicionar Novo VeÃ­culo - ${selectedFilial.nome}`;
Â  Â  Â  Â  Â  Â  Â  Â  fieldsContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_placa">Placa do VeÃ­culo:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="add_placa" required placeholder="Ex: ABC-1234" style="text-transform: uppercase;" onkeyup="this.value = this.value.toUpperCase()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_modelo">Modelo:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="add_modelo" required placeholder="Ex: Mercedes Actros 2651">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_capacidade_pallets">Capacidade (Pallets):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="add_capacidade_pallets" min="1" required placeholder="Ex: 26">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_tipo">Tipo:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="add_tipo" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione o tipo</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="JJS">JJS</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="PERLOG">PERLOG</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_status">Status:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="add_status" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="disponivel">DisponÃ­vel</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="em_uso">Em Uso</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="manutencao">ManutenÃ§Ã£o</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Filial:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" value="${selectedFilial.nome}" disabled style="background: #f5f5f5;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  } else if (type === 'motorista') {
Â  Â  Â  Â  Â  Â  Â  Â  title.textContent = `Adicionar Novo Motorista - ${selectedFilial.nome}`;
Â  Â  Â  Â  Â  Â  Â  Â  fieldsContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_nome">Nome do Motorista:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="add_nome" required placeholder="Ex: JoÃ£o Silva Pereira">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_produtivo">Produtivo (MatrÃ­cula):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="add_produtivo" required placeholder="Ex: 45676912345">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_status">Status:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="add_status" required>
Â  Â  <option value="disponivel">DisponÃ­vel</option>
Â  Â  <option value="em_viagem">Ocupado (Em Viagem)</option>
Â  Â  <option value="folga">Folga</option>
</select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Filial:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" value="${selectedFilial.nome}" disabled style="background: #f5f5f5;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  else if (type === 'acesso') {
Â  Â  Â  Â  title.textContent = `Adicionar Novo Acesso - ${selectedFilial.nome}`;

Â  Â  Â  Â  // LÃ³gica de permissÃ£o: SÃ³ mestres podem criar outros mestres
Â  Â  Â  Â  let tipoAcessoHtml = '';
Â  Â  Â  Â  if (currentUser && currentUser.tipo_acesso === 'ALL') {
Â  Â  Â  Â  Â  Â  // Se for master, mostra um dropdown para escolher
Â  Â  Â  Â  Â  Â  tipoAcessoHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_tipo_acesso">Tipo de Acesso:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="add_tipo_acesso" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="ALL">ALL (Master - Acesso Total)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="${selectedFilial.nome}">${selectedFilial.nome} (Acesso apenas a esta filial)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Se nÃ£o for master, o acesso Ã© travado na filial atual
Â  Â  Â  Â  Â  Â  tipoAcessoHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_tipo_acesso">Tipo de Acesso:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="add_tipo_acesso" value="${selectedFilial.nome}" disabled style="background: #f5f5f5;">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  fieldsContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_nome">Nome de UsuÃ¡rio:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="add_nome" required placeholder="Ex: joao.silva">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="add_senha">Senha:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="add_senha" required placeholder="Crie uma senha forte">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  ${tipoAcessoHtml}
Â  Â  Â  Â  `;
Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function hideAddForm() {
Â  Â  Â  Â  Â  Â  debugLog.add('Fechando formulÃ¡rio', 'info');
Â  Â  Â  Â  Â  Â  document.getElementById('addFormModal').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('addFormAlert').innerHTML = '';
Â  Â  Â  Â  }

Â  Â  Â  Â  // FunÃ§Ãµes de salvamento com filial (removendo parÃ¢metro false desnecessÃ¡rio)
Â  Â  Â  Â  async function saveLoja() {
Â  Â  Â  Â  Â  Â  const nome = document.getElementById('add_nome').value.trim();
Â  Â  Â  Â  Â  Â  const codigo = document.getElementById('add_codigo').value.trim();
Â  Â  Â  Â  Â  Â  const cidade = document.getElementById('add_cidade').value.trim();
Â  Â  Â  Â  Â  Â  const codlojaqr = document.getElementById('add_codlojaqr').value.trim().toUpperCase();

Â  Â  Â  Â  Â  Â  if (!nome || !codigo || !cidade || !codlojaqr) {
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', 'Por favor, preencha todos os campos', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Salvando nova loja: ${nome} (${codigo}) - QR: ${codlojaqr} - Filial: ${selectedFilial.nome}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  const lojaData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: nome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codigo: codigo,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cidade: cidade,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codlojaqr: codlojaqr,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ativo: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // filial serÃ¡ adicionada automaticamente pela funÃ§Ã£o supabaseRequest
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest('lojas', 'POST', lojaData);

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Loja "${nome}" criada com sucesso`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', `Loja "${nome}" criada com sucesso para ${selectedFilial.nome}!`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`Nova loja "${nome}" adicionada Ã  ${selectedFilial.nome}!`, 'success');

Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadSelectData();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideAddForm();
Â  Â  Â  Â  Â  Â  Â  Â  }, 2000);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao salvar loja:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao salvar loja: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', `Erro: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // NOVO: FunÃ§Ã£o para salvar um novo acesso
Â  Â  Â  async function saveAcesso() {
Â  Â  Â  Â  Â  const nome = document.getElementById('add_nome').value.trim();
Â  Â  Â  Â  Â  const senha = document.getElementById('add_senha').value;
Â  Â  Â  Â  Â  const tipo_acesso = document.getElementById('add_tipo_acesso').value;

Â  Â  Â  Â  Â  if (!nome || !senha || !tipo_acesso) {
Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', 'Por favor, preencha todos os campos', 'error');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Criando novo usuÃ¡rio: ${nome} com acesso '${tipo_acesso}'`, 'info');

Â  Â  Â  Â  Â  Â  Â  const acessoData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: nome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  senha: senha, // Lembre-se da nota de seguranÃ§a sobre senhas!
Â  Â  Â  Â  Â  Â  Â  Â  Â  tipo_acesso: tipo_acesso
Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  await supabaseRequest('acessos', 'POST', acessoData, false);

Â  Â  Â  Â  Â  Â  Â  // Registra a criaÃ§Ã£o do usuÃ¡rio no histÃ³rico
Â  Â  Â  Â  Â  Â  Â  await logAction('CRIAÃ‡ÃƒO USUÃRIO', `UsuÃ¡rio '${nome}' foi criado com tipo de acesso '${tipo_acesso}'.`);

Â  Â  Â  Â  Â  Â  Â  debugLog.add(`UsuÃ¡rio "${nome}" criado com sucesso`, 'success');
Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', `UsuÃ¡rio "${nome}" criado com sucesso!`, 'success');
Â  Â  Â  Â  Â  Â  Â  showNotification(`Novo usuÃ¡rio "${nome}" adicionado!`, 'success');

Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  hideAddForm();
Â  Â  Â  Â  Â  Â  Â  }, 2000);

Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao salvar acesso:', error);
Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao salvar acesso: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', `Erro: ${error.message}. Verifique se o nome de usuÃ¡rio jÃ¡ existe.`, 'error');
Â  Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  Â  async function saveDoca() {
Â  Â  Â  Â  Â  Â  const nome = document.getElementById('add_nome').value.trim();
Â  Â  Â  Â  Â  Â  const capacidadePallets = parseInt(document.getElementById('add_capacidade_pallets').value);
Â  Â  Â  Â  Â  Â  const coddoca = document.getElementById('add_coddoca').value.trim();

Â  Â  Â  Â  Â  Â  if (!nome || !capacidadePallets || capacidadePallets < 0 || !coddoca) {
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', 'Por favor, preencha todos os campos corretamente', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Salvando nova doca: ${nome} (${capacidadePallets} pallets) - CÃ³digo: ${coddoca} - Filial: ${selectedFilial.nome}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  const docaData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: nome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  capacidade_pallets: capacidadePallets,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  coddoca: coddoca,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ativo: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // filial serÃ¡ adicionada automaticamente pela funÃ§Ã£o supabaseRequest
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest('docas', 'POST', docaData);

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Doca "${nome}" criada com sucesso`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', `Doca "${nome}" criada com sucesso para ${selectedFilial.nome}!`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`Nova doca "${nome}" adicionada Ã  ${selectedFilial.nome}!`, 'success');

Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadSelectData();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideAddForm();
Â  Â  Â  Â  Â  Â  Â  Â  }, 2000);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao salvar doca:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao salvar doca: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', `Erro: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function saveLider() {
Â  Â  Â  Â  Â  Â  const nome = document.getElementById('add_nome').value.trim();
Â  Â  Â  Â  Â  Â  const codigoFuncionario = document.getElementById('add_codigo_funcionario').value.trim();

Â  Â  Â  Â  Â  Â  if (!nome || !codigoFuncionario) {
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', 'Por favor, preencha todos os campos', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Salvando novo lÃ­der: ${nome} (${codigoFuncionario}) - Filial: ${selectedFilial.nome}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  const liderData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: nome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codigo_funcionario: codigoFuncionario,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ativo: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // filial serÃ¡ adicionada automaticamente pela funÃ§Ã£o supabaseRequest
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest('lideres', 'POST', liderData);

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`LÃ­der "${nome}" criado com sucesso`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', `LÃ­der "${nome}" criado com sucesso para ${selectedFilial.nome}!`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`Novo lÃ­der "${nome}" adicionado Ã  ${selectedFilial.nome}!`, 'success');

Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadSelectData();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideAddForm();
Â  Â  Â  Â  Â  Â  Â  Â  }, 2000);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao salvar lÃ­der:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao salvar lÃ­der: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', `Erro: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function saveVeiculo() {
Â  Â  Â  Â  Â  Â  const placa = document.getElementById('add_placa').value.trim().toUpperCase();
Â  Â  Â  Â  Â  Â  const modelo = document.getElementById('add_modelo').value.trim();
Â  Â  Â  Â  Â  Â  const capacidadePallets = parseInt(document.getElementById('add_capacidade_pallets').value);
Â  Â  Â  Â  Â  Â  const tipo = document.getElementById('add_tipo').value.trim();
Â  Â  Â  Â  Â  Â  const status = document.getElementById('add_status').value.trim();


Â  Â  Â  Â  Â  Â  if (!placa || !modelo || !capacidadePallets || !tipo) {
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', 'Por favor, preencha todos os campos', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (capacidadePallets < 1) {
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', 'A capacidade deve ser maior que zero', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (tipo !== 'JJS' && tipo !== 'PERLOG') {
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', 'Tipo deve ser JJS ou PERLOG', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Salvando novo veÃ­culo: ${placa} - ${modelo} (${capacidadePallets} pallets) - Tipo: ${tipo} - Filial: ${selectedFilial.nome}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  const veiculoData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placa: placa,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modelo: modelo,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  capacidade_pallets: capacidadePallets,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tipo: tipo,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: status
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // filial serÃ¡ adicionada automaticamente pela funÃ§Ã£o supabaseRequest
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest('veiculos', 'POST', veiculoData);

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`VeÃ­culo "${placa}" criado com sucesso`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', `VeÃ­culo "${placa}" criado com sucesso para ${selectedFilial.nome}!`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`Novo veÃ­culo "${placa}" adicionado Ã  ${selectedFilial.nome}!`, 'success');

Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadSelectData();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideAddForm();
Â  Â  Â  Â  Â  Â  Â  Â  }, 2000);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao salvar veÃ­culo:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao salvar veÃ­culo: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', `Erro: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function saveMotorista() {
Â  Â  Â  Â  Â  Â  const nome = document.getElementById('add_nome').value.trim();
Â  Â  Â  Â  Â  Â  const produtivo = document.getElementById('add_produtivo').value.trim();
Â  Â  Â  Â  Â  Â  const status = document.getElementById('add_status').value.trim();

Â  Â  Â  Â  Â  Â  if (!nome || !produtivo) {
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', 'Por favor, preencha todos os campos', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Salvando novo motorista: ${nome} (${produtivo}) - Filial: ${selectedFilial.nome}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  const motoristaData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: nome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  PRODUTIVO: produtivo,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: status
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // filial serÃ¡ adicionada automaticamente pela funÃ§Ã£o supabaseRequest
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  await supabaseRequest('motoristas', 'POST', motoristaData);

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Motorista "${nome}" criado com sucesso`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', `Motorista "${nome}" criado com sucesso para ${selectedFilial.nome}!`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`Novo motorista "${nome}" adicionado Ã  ${selectedFilial.nome}!`, 'success');

Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadSelectData();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideAddForm();
Â  Â  Â  Â  Â  Â  Â  Â  }, 2000);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao salvar motorista:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao salvar motorista: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', `Erro: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Event listeners
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', function() {
Â  Â  Â  Â  Â  Â  // Event listener para o formulÃ¡rio de expediÃ§Ã£o
Â  Â  Â  Â  Â  Â  const expeditionForm = document.getElementById('expeditionForm');
Â  Â  Â  Â  Â  Â  if (expeditionForm) {
Â  Â  Â  Â  Â  Â  Â  Â  expeditionForm.addEventListener('submit', function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!selectedFilial) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('operacaoAlert', 'Selecione uma filial primeiro!', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const formData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  docaId: document.getElementById('docaSelect').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  liderId: document.getElementById('liderSelect').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  observacoes: document.getElementById('observacoes').value
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveExpedition(formData);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  // COLE ESTE BLOCO INTEIRO NO LUGAR DA SUA FUNÃ‡ÃƒO DE LOGIN ATUAL

// Event listener para formulÃ¡rio de senha
const passwordForm = document.getElementById('passwordForm');
if (passwordForm) {
Â  Â  passwordForm.addEventListener('submit', async function(e) {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â Â 
Â  Â  Â  Â  const nome = document.getElementById('userInput').value.trim();
Â  Â  Â  Â  const senha = document.getElementById('passwordInput').value;

Â  Â  Â  Â  if (!nome || !senha) {
Â  Â  Â  Â  Â  Â  showAlert('passwordAlert', 'Nome e senha sÃ£o obrigatÃ³rios.', 'error');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // Montamos a URL para a nossa funÃ§Ã£o personalizada
Â  Â  Â  Â  Â  Â  const endpoint = `acessos?select=nome,tipo_acesso&nome=eq.${nome}&senha=eq.${senha}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Usamos a nossa funÃ§Ã£o supabaseRequest
Â  Â  Â  Â  Â  Â  const result = await supabaseRequest(endpoint, 'GET', null, false);

Â  Â  Â  Â  Â  Â  // Se o array de resultado estiver vazio, o login falhou.
Â  Â  Â  Â  Â  Â  if (!result || result.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('passwordAlert', 'Nome de usuÃ¡rio ou senha incorretos.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Tentativa de login falhou para o usuÃ¡rio: ${nome}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('passwordInput').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Se deu certo, pegamos o primeiro usuÃ¡rio do resultado
Â  Â  Â  Â  Â  Â  const user = result[0];

Â  Â  Â  Â  Â  Â  // Armazena os dados do usuÃ¡rio na variÃ¡vel global
Â  Â  Â  Â  Â  Â  currentUser = {
Â  Â  Â  Â  Â  Â  Â  Â  nome: user.nome,
Â  Â  Â  Â  Â  Â  Â  Â  tipo_acesso: user.tipo_acesso
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  // Libera o acesso Ã  Ã¡rea de configuraÃ§Ãµes
Â  Â  Â  Â  Â  Â  showNotification('Acesso concedido!', 'success');
Â  Â  Â  Â  Â  Â  document.getElementById('passwordFormContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('configuracoesContent').style.display = 'block';
Â  Â  Â  Â  Â  Â  document.getElementById('passwordInput').value = '';Â 
Â  Â  Â  Â  Â  Â  updateSystemStatus();
Â  Â  Â  Â  Â  Â  updateDebugStats();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Registra a aÃ§Ã£o de login no histÃ³rico
Â  Â  Â  Â  Â  Â  await logAction('LOGIN', `UsuÃ¡rio '${currentUser.nome}' acessou as configuraÃ§Ãµes.`);

Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  showAlert('passwordAlert', 'Erro ao verificar credenciais. Verifique a conexÃ£o.', 'error');
Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  }
Â  Â  });
}

/*
* NOTA DE SEGURANÃ‡A IMPORTANTE, JP!
* O mÃ©todo que implementamos (.eq('senha', senha)) envia a senha em texto puro.
* Para um ambiente de produÃ§Ã£o real, o ideal Ã© usar o sistema de autenticaÃ§Ã£o
* do prÃ³prio Supabase (Supabase Auth), que armazena as senhas de forma criptografada.
* Para o seu sistema interno e como aprendizado, o mÃ©todo atual funciona, masÂ 
* tenha essa boa prÃ¡tica em mente para projetos futuros!
*/
Â  Â  Â  Â  Â  Â // Event listener para formulÃ¡rio de adiÃ§Ã£o
Â  Â  Â  const addForm = document.getElementById('addForm');
Â  Â  Â  if (addForm) {
Â  Â  Â  Â  Â  addForm.addEventListener('submit', async function(e) {
Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  const title = document.getElementById('addFormTitle').textContent;

Â  Â  Â  Â  Â  Â  Â  if (title.includes('Loja')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  await saveLoja();
Â  Â  Â  Â  Â  Â  Â  } else if (title.includes('Doca')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  await saveDoca();
Â  Â  Â  Â  Â  Â  Â  } else if (title.includes('LÃ­der')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  await saveLider();
Â  Â  Â  Â  Â  Â  Â  } else if (title.includes('VeÃ­culo')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  await saveVeiculo();
Â  Â  Â  Â  Â  Â  Â  } else if (title.includes('Motorista')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  await saveMotorista();
Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  // ADICIONE ESTE BLOCO
Â  Â  Â  Â  Â  Â  Â  else if (title.includes('Acesso')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  await saveAcesso();
Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  // ----------------
Â  Â  Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('addFormAlert', 'Funcionalidade em desenvolvimento', 'warning');
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Event listener para formulÃ¡rio de ediÃ§Ã£o
Â  Â  Â  Â  Â  Â  const editForm = document.getElementById('editExpeditionForm');
Â  Â  Â  Â  Â  Â  if (editForm) {
Â  Â  Â  Â  Â  Â  Â  Â  editForm.addEventListener('submit', async function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await saveEditedExpedition();
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // Gerar relatÃ³rio de tempos (atualizado para filial)
Â  Â  Â  Â  async function generateReport() {
Â  Â  Â  Â  Â  Â  if (!selectedFilial) {
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Selecione uma filial primeiro!', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Gerando relatÃ³rio de tempos para filial: ${selectedFilial.nome}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  const data = await supabaseRequest('expeditions');

Â  Â  Â  Â  Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

Â  Â  Â  Â  Â  Â  Â  Â  const monthlyData = data.filter(exp => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const expDate = new Date(exp.data_hora);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return expDate >= startOfMonth;
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const temposAlocacao = [];
Â  Â  Â  Â  Â  Â  Â  Â  const temposCarregamento = [];

Â  Â  Â  Â  Â  Â  Â  Â  monthlyData.forEach(exp => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (exp.data_alocacao_veiculo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const criadoEm = new Date(exp.data_hora || exp.created_at);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const alocadoEm = new Date(exp.data_alocacao_veiculo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  temposAlocacao.push(Math.round((alocadoEm - criadoEm) / 60000));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (exp.data_chegada_veiculo && exp.data_saida_veiculo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const chegadaEm = new Date(exp.data_chegada_veiculo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const saidaEm = new Date(exp.data_saida_veiculo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  temposCarregamento.push(Math.round((saidaEm - chegadaEm) / 60000));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const tempoMedioAlocacao = temposAlocacao.length > 0
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? Math.round(temposAlocacao.reduce((a, b) => a + b, 0) / temposAlocacao.length)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : 0;

Â  Â  Â  Â  Â  Â  Â  Â  const tempoMedioCarregamento = temposCarregamento.length > 0
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? Math.round(temposCarregamento.reduce((a, b) => a + b, 0) / temposCarregamento.length)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : 0;

Â  Â  Â  Â  Â  Â  Â  Â  const reportText = `
RELATÃ“RIO DE PERFORMANCE E TEMPOS
FILIAL: ${selectedFilial.nome}
${today.toLocaleDateString('pt-BR', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  month: 'long',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  year: 'numeric'
Â  Â  Â  Â  Â  Â  Â  Â  }).toUpperCase()}

RESUMO GERAL:
â€¢ Total de expediÃ§Ãµes: ${monthlyData.length}
â€¢ Entregues: ${monthlyData.filter(d => d.status === 'entregue').length}
â€¢ Em andamento: ${monthlyData.filter(d => ['aguardando_veiculo', 'em_carregamento', 'carregado', 'saiu_para_entrega'].includes(d.status)).length}
â€¢ Pendentes: ${monthlyData.filter(d => d.status === 'pendente').length}

ANÃLISE DE TEMPOS:
â€¢ Tempo mÃ©dio para alocaÃ§Ã£o: ${minutesToHHMM(tempoMedioAlocacao)}
â€¢ Tempo mÃ©dio de carregamento: ${minutesToHHMM(tempoMedioCarregamento)}
â€¢ ExpediÃ§Ãµes com alocaÃ§Ã£o: ${temposAlocacao.length}
â€¢ ExpediÃ§Ãµes carregadas: ${temposCarregamento.length}

PERFORMANCE:
â€¢ Taxa de alocaÃ§Ã£o: ${monthlyData.length > 0 ? ((temposAlocacao.length/monthlyData.length)*100).toFixed(1) : 0}%
â€¢ Taxa de carregamento: ${temposAlocacao.length > 0 ? ((temposCarregamento.length/temposAlocacao.length)*100).toFixed(1) : 0}%

RelatÃ³rio gerado em: ${new Date().toLocaleString('pt-BR')}
Â  Â  Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add('RelatÃ³rio de tempos gerado com sucesso', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(reportText, 'info');
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao gerar relatÃ³rio:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao gerar relatÃ³rio: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Erro ao gerar relatÃ³rio', 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Backup de dados (atualizado para filial)
Â  Â  Â  Â  async function backupData() {
Â  Â  Â  Â  Â  Â  if (!selectedFilial) {
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Selecione uma filial primeiro!', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Iniciando backup da filial: ${selectedFilial.nome}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  const data = await supabaseRequest('expeditions');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const backup = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  version: '4.0_multi_filial',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  filial: selectedFilial.nome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: data
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  const blob = new Blob([JSON.stringify(backup, null, 2)], {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: 'application/json'
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  Â  Â  link.setAttribute('href', url);
Â  Â  Â  Â  Â  Â  Â  Â  link.setAttribute('download', `backup_${selectedFilial.nome}_${new Date().toISOString().split('T')[0]}.json`);
Â  Â  Â  Â  Â  Â  Â  Â  link.style.visibility = 'hidden';
Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(link);

Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Backup da filial ${selectedFilial.nome} realizado`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`Backup da filial ${selectedFilial.nome} realizado com sucesso!`, 'success');
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro no backup:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro no backup: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Erro ao fazer backup', 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Ver detalhes com anÃ¡lise completa de tempos (atualizado para filial)
Â  Â  Â  Â  async function viewDetails(expeditionId) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Carregando detalhes da expediÃ§Ã£o ${expeditionId}`, 'info');

Â  Â  Â  Â  Â  Â  Â  Â  const data = await supabaseRequest(`expeditions?id=eq.${expeditionId}`, 'GET', null, false);
Â  Â  Â  Â  Â  Â  Â  Â  const expedition = data[0];

Â  Â  Â  Â  Â  Â  Â  Â  if (!expedition) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showNotification('ExpediÃ§Ã£o nÃ£o encontrada!', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const criadoEm = new Date(expedition.created_at || expedition.data_hora);
Â  Â  Â  Â  Â  Â  Â  Â  const alocadoEm = expedition.data_alocacao_veiculo ? new Date(expedition.data_alocacao_veiculo) : null;
Â  Â  Â  Â  Â  Â  Â  Â  const chegadaEm = expedition.data_chegada_veiculo ? new Date(expedition.data_chegada_veiculo) : null;
Â  Â  Â  Â  Â  Â  Â  Â  const saidaEm = expedition.data_saida_veiculo ? new Date(expedition.data_saida_veiculo) : null;

Â  Â  Â  Â  Â  Â  Â  Â  let analiseCompleta = `
ANÃLISE COMPLETA DE TEMPOS - EXPEDIÃ‡ÃƒO
FILIAL: ${expedition.filial || selectedFilial?.nome || 'N/A'}

INFORMAÃ‡Ã•ES BÃSICAS:
Criada em: ${criadoEm.toLocaleString('pt-BR')}
Status: ${getStatusLabel(expedition.status)}

TRANSPORTE ALOCADO:
VeÃ­culo: ${expedition.veiculo_placa ? `${expedition.veiculo_placa} - ${expedition.veiculo_modelo}` : 'NÃ£o alocado'}
Motorista: ${expedition.motorista_nome || 'NÃ£o alocado'}

TIMELINE COMPLETA:
`;

Â  Â  Â  Â  Â  Â  Â  Â  if (alocadoEm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const minutosAlocar = Math.round((alocadoEm - criadoEm) / 60000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  analiseCompleta += `
â€¢ AlocaÃ§Ã£o: ${alocadoEm.toLocaleString('pt-BR')}
Â  â±ï¸ Tempo para alocar: ${minutesToHHMM(minutosAlocar)}`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (minutosAlocar <= 30) analiseCompleta += ' âœ… (Excelente)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (minutosAlocar <= 60) analiseCompleta += ' âš ï¸ (AtenÃ§Ã£o)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else analiseCompleta += ' âŒ (Demorado)';
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (chegadaEm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const minutosAteChegada = Math.round((chegadaEm - criadoEm) / 60000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const minutosAlocacaoChegada = alocadoEm ? Math.round((chegadaEm - alocadoEm) / 60000) : 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  analiseCompleta += `

â€¢ Chegada na Doca: ${chegadaEm.toLocaleString('pt-BR')}
Â  â±ï¸ Tempo total (criaÃ§Ã£o â†’ chegada): ${minutesToHHMM(minutosAteChegada)}`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (alocadoEm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  analiseCompleta += `
Â  â±ï¸ Tempo (alocaÃ§Ã£o â†’ chegada): ${minutesToHHMM(minutosAlocacaoChegada)}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (saidaEm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const minutosCarregamento = Math.round((saidaEm - chegadaEm) / 60000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  analiseCompleta += `

â€¢ SaÃ­da da Doca: ${saidaEm.toLocaleString('pt-BR')}
Â  â±ï¸ Tempo de carregamento: ${minutesToHHMM(minutosCarregamento)}`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (minutosCarregamento <= 45) analiseCompleta += ' âœ… (RÃ¡pido)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (minutosCarregamento <= 90) analiseCompleta += ' âš ï¸ (Normal)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else analiseCompleta += ' âŒ (Lento)';
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (!alocadoEm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const minutosAguardando = Math.round((new Date() - criadoEm) / 60000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  analiseCompleta += `

â³ AGUARDANDO ALOCAÃ‡ÃƒO HÃ: ${minutesToHHMM(minutosAguardando)}`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (minutosAguardando > 60) analiseCompleta += ' âš ï¸ (Urgente!)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (minutosAguardando > 120) analiseCompleta += ' âŒ (CrÃ­tico!)';
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  analiseCompleta += `

OBSERVAÃ‡Ã•ES:
${expedition.observacoes || 'Nenhuma'}
Â  Â  Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  Â  Â  showNotification(analiseCompleta, 'info');
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar detalhes:', error);
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add(`Erro ao carregar detalhes: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Erro: ' + error.message, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Inicializar aplicaÃ§Ã£o
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', async function() {
Â  Â  Â  Â  Â  Â  debugLog.add('Sistema de Controle de ExpediÃ§Ã£o Multi-Filial iniciado', 'info');
Â  Â  Â  Â  Â  Â  debugLog.add(`URL: ${SUPABASE_URL}`, 'info');
Â  Â  Â  Â  Â  Â  debugLog.add('Funcionalidades ativas: Sistema Multi-Filial, Timestamps automÃ¡ticos, Controle de doca, AnÃ¡lise de tempos, Filtros por data, ValidaÃ§Ã£o QR Code', 'info');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Chart.register(ChartDataLabels);

Â  Â  Â  Â  Â  Â  const connected = await checkConnection();
Â  Â  Â  Â  Â  Â  if (connected) {
Â  Â  Â  Â  Â  Â  Â  Â  await loadFiliais();
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Sistema multi-filial carregado! Selecione uma filial para continuar.', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add('Sistema multi-filial totalmente carregado', 'success');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Erro na conexÃ£o com o banco', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add('Sistema iniciado com erro de conexÃ£o', 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  function showAlert(containerId, message, type = 'success') {
Â  Â  Â  Â  Â  Â  const container = document.getElementById(containerId);
Â  Â  Â  Â  Â  Â  if (container) {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  }, 5000);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â // Nova funÃ§Ã£o com a lÃ³gica de status
async function marcarRetornoCD(motoristaId, veiculoId) {
Â  Â  try {
Â  Â  Â  Â  const motorista = motoristas.find(m => m.id === motoristaId);
Â  Â  Â  Â  if (!motorista) throw new Error('Motorista nÃ£o encontrado!');

Â  Â  Â  Â  let novoStatusMotorista, novoStatusVeiculo, notificationMessage;

Â  Â  Â  Â  if (motorista.status === 'retornando_com_imobilizado') {
Â  Â  Â  Â  Â  Â  novoStatusMotorista = 'descarregando_imobilizado';
Â  Â  Â  Â  Â  Â  novoStatusVeiculo = 'descarregando_imobilizado'; // Atualiza o veÃ­culo tambÃ©m
Â  Â  Â  Â  Â  Â  notificationMessage = 'Retorno com imobilizado registrado. Inicie a descarga.';
Â  Â  Â  Â  Â  Â  debugLog.add(`Motorista ${motoristaId} chegou com imobilizado. Status alterado para 'descarregando_imobilizado'.`, 'info');
Â  Â  Â  Â  } else { // Status Ã© 'retornando_cd'
Â  Â  Â  Â  Â  Â  novoStatusMotorista = 'disponivel';
Â  Â  Â  Â  Â  Â  novoStatusVeiculo = 'disponivel';
Â  Â  Â  Â  Â  Â  notificationMessage = 'Retorno ao CD registrado. Motorista e veÃ­culo disponÃ­veis!';
Â  Â  Â  Â  Â  Â  debugLog.add(`Motorista ${motoristaId} chegou. Status alterado para 'disponivel'.`, 'info');
Â  Â  Â  Â  }

Â  Â  Â  Â  await Promise.all([
Â  Â  Â  Â  Â  Â  supabaseRequest(`motoristas?id=eq.${motoristaId}`, 'PATCH', { status: novoStatusMotorista }, false),
Â  Â  Â  Â  Â  Â  supabaseRequest(`veiculos?id=eq.${veiculoId}`, 'PATCH', { status: novoStatusVeiculo }, false)
Â  Â  Â  Â  ]);
Â  Â  Â  Â Â 
Â  Â  Â  Â  showNotification(notificationMessage, 'success');

Â  Â  Â  Â  await loadSelectData();
Â  Â  Â  Â  await renderMotoristasStatusList(); // Usar a funÃ§Ã£o que redesenha a lista

Â  Â  } catch (error) {
Â  Â  Â  Â  debugLog.add(`Erro ao marcar retorno ao CD: ${error.message}`, 'error');
Â  Â  Â  Â  showNotification('Erro ao marcar retorno: ' + error.message, 'error');
Â  Â  }
}
// ADICIONE ESTA NOVA FUNÃ‡ÃƒO
async function finalizarDescargaImobilizado(motoristaId, veiculoId) {
Â  Â  try {
Â  Â  Â  Â  debugLog.add(`Finalizando descarga de imobilizado para motorista ${motoristaId} e veÃ­culo ${veiculoId}`, 'info');

Â  Â  Â  Â  await Promise.all([
Â  Â  Â  Â  Â  Â  supabaseRequest(`motoristas?id=eq.${motoristaId}`, 'PATCH', { status: 'disponivel' }, false),
Â  Â  Â  Â  Â  Â  supabaseRequest(`veiculos?id=eq.${veiculoId}`, 'PATCH', { status: 'disponivel' }, false)
Â  Â  Â  Â  ]);

Â  Â  Â  Â  showNotification('Descarga de imobilizado finalizada. Motorista e veÃ­culo disponÃ­veis!', 'success');

Â  Â  Â  Â  await loadSelectData();
Â  Â  Â  Â  await renderMotoristasStatusList();

Â  Â  } catch (error) {
Â  Â  Â  Â  debugLog.add(`Erro ao finalizar descarga de imobilizado: ${error.message}`, 'error');
Â  Â  Â  Â  showNotification('Erro ao finalizar descarga: ' + error.message, 'error');
Â  Â  }
}
Â  Â  Â  Â  // Funcionalidade de trocar filial no cabeÃ§alho
Â  Â  Â  Â  document.addEventListener('click', function(e) {
Â  Â  Â  Â  Â  Â  if (e.target.closest('.btn-danger') && e.target.textContent.includes('Trocar Filial')) {
Â  Â  Â  Â  Â  Â  Â  Â  trocarFilial();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // Controle de navegaÃ§Ã£o por teclado para melhor UX
Â  Â  Â  Â  document.addEventListener('keydown', function(e) {
Â  Â  Â  Â  Â  Â  if (e.key === 'Escape') {
Â  Â  Â  Â  Â  Â  Â  Â  // Fechar modais com ESC
Â  Â  Â  Â  Â  Â  Â  Â  closeQrModal();
Â  Â  Â  Â  Â  Â  Â  Â  closeEditModal();
Â  Â  Â  Â  Â  Â  Â  Â  hideAddForm();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // Auto-atualizaÃ§Ã£o de dados a cada 5 minutos (opcional)
Â  Â  Â  Â  setInterval(async function() {
Â  Â  Â  Â  Â  Â  if (selectedFilial && document.querySelector('.tab.active')?.onclick) {
Â  Â  Â  Â  Â  Â  Â  Â  const activeTab = document.querySelector('.tab.active').onclick.toString().match(/'(\w+)'/)?.[1];
Â  Â  Â  Â  Â  Â  Â  Â  if (activeTab === 'acompanhamento') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  debugLog.add('Auto-atualizando dados do acompanhamento...', 'info');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadAcompanhamento();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 300000); // 5 minutos
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- NOVAS FUNÃ‡Ã•ES PARA GRÃFICOS E INDICADORES ---

Â  Â  Â  Â  function generateHistoricoIndicators(data) {
Â  Â  Â  Â  Â  Â  const summaryContainer = document.getElementById('indicadoresSummary');
Â  Â  Â  Â  Â  Â  if (data.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  summaryContainer.innerHTML = '<div class="alert alert-info">Sem dados para exibir indicadores.</div>';
Â  Â  Â  Â  Â  Â  Â  Â  destroyChart('lojasRankingChart');
Â  Â  Â  Â  Â  Â  Â  Â  destroyChart('entregasChart');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let totalViagens = data.length;
Â  Â  Â  Â  Â  Â  let totalEntregas = 0;
Â  Â  Â  Â  Â  Â  let temposDeViagem = [];
Â  Â  Â  Â  Â  Â  let temposInternos = [];
Â  Â  Â  Â  Â  Â  let temposEmTransito = [];
Â  Â  Â  Â  Â  Â  let temposEmLoja = [];
Â  Â  Â  Â  Â  Â  let lojasData = {};
Â  Â  Â  Â  Â  Â  let entregasFort = 0;
Â  Â  Â  Â  Â  Â  let entregasComper = 0;

Â  Â  Â  Â  Â  Â  data.forEach(exp => {
Â  Â  Â  Â  Â  Â  Â  Â  totalEntregas += exp.items.length;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const t0_criacao = new Date(exp.data_hora);
Â  Â  Â  Â  Â  Â  Â  Â  const t6_saidaEntrega = exp.data_saida_entrega ? new Date(exp.data_saida_entrega) : null;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let t_ultimaDescarga = null;
Â  Â  Â  Â  Â  Â  Â  Â  exp.items.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.data_fim_descarga) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const t_fim = new Date(item.data_fim_descarga);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!t_ultimaDescarga || t_fim > t_ultimaDescarga) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t_ultimaDescarga = t_fim;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (t6_saidaEntrega && t_ultimaDescarga) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  temposDeViagem.push((t_ultimaDescarga - t0_criacao) / 60000);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(t6_saidaEntrega) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  temposInternos.push((t6_saidaEntrega - t0_criacao) / 60000);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  let ultimaData = t6_saidaEntrega;
Â  Â  Â  Â  Â  Â  Â  Â  let totalTransitoViagem = 0;
Â  Â  Â  Â  Â  Â  Â  Â  let totalLojaViagem = 0;

Â  Â  Â  Â  Â  Â  Â  Â  exp.items.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loja = lojas.find(l => l.id === item.loja_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const t_chegada = item.data_inicio_descarga ? new Date(item.data_inicio_descarga) : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const t_saida = item.data_fim_descarga ? new Date(item.data_fim_descarga) : null;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tempoTransito = ultimaData && t_chegada ? (t_chegada - ultimaData) / 60000 : 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tempoEmLoja = t_saida && t_chegada ? (t_saida - t_chegada) / 60000 : 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalTransitoViagem += tempoTransito;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalLojaViagem += tempoEmLoja;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loja) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!lojasData[loja.id]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lojasData[loja.id] = { nome: `${loja.nome} (${loja.codigo})`, tempos: [], entregas: 0 };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(tempoEmLoja > 0) lojasData[loja.id].tempos.push(tempoEmLoja);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lojasData[loja.id].entregas++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (loja.nome.toLowerCase().includes('fort')) entregasFort++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (loja.nome.toLowerCase().includes('comper')) entregasComper++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t_saida) ultimaData = t_saida;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (totalTransitoViagem > 0) temposEmTransito.push(totalTransitoViagem);
Â  Â  Â  Â  Â  Â  Â  Â  if (totalLojaViagem > 0) temposEmLoja.push(totalLojaViagem);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const calcularMedia = (arr) => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  summaryContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-stat-card"><div class="stat-number">${totalViagens}</div><div class="stat-label">Total de Viagens</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-stat-card"><div class="stat-number">${totalEntregas}</div><div class="stat-label">Total de Entregas</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-stat-card"><div class="stat-number">${minutesToHHMM(calcularMedia(temposDeViagem))}</div><div class="stat-label">Tempo MÃ©dio Total</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-stat-card"><div class="stat-number">${minutesToHHMM(calcularMedia(temposInternos))}</div><div class="stat-label">Tempo MÃ©dio Interno</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-stat-card"><div class="stat-number">${minutesToHHMM(calcularMedia(temposEmTransito))}</div><div class="stat-label">Tempo MÃ©dio em TrÃ¢nsito</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-stat-card"><div class="stat-number">${minutesToHHMM(calcularMedia(temposEmLoja))}</div><div class="stat-label">Tempo MÃ©dio em Loja</div></div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  renderLojasRankingChart(lojasData);
Â  Â  Â  Â  Â  Â  renderEntregasChart(entregasFort, entregasComper);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderLojasRankingChart(lojasData) {
Â  Â  Â  Â  Â  Â  const ranking = Object.values(lojasData)
Â  Â  Â  Â  Â  Â  Â  Â  .map(loja => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...loja,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempoMedio: loja.tempos.length > 0 ? loja.tempos.reduce((a, b) => a + b, 0) / loja.tempos.length : 0
Â  Â  Â  Â  Â  Â  Â  Â  }))
Â  Â  Â  Â  Â  Â  Â  Â  .filter(loja => loja.tempoMedio > 0)
Â  Â  Â  Â  Â  Â  Â  Â  .sort((a, b) => b.tempoMedio - a.tempoMedio)
Â  Â  Â  Â  Â  Â  Â  Â  .slice(0, 15); // Top 15

Â  Â  Â  Â  Â  Â  const labels = ranking.map(l => l.nome);
Â  Â  Â  Â  Â  Â  const data = ranking.map(l => l.tempoMedio);
Â  Â  Â  Â  Â  Â  const backgroundColors = ranking.map(l => l.nome.toLowerCase().includes('fort') ? 'rgba(214, 40, 40, 0.7)' : 'rgba(0, 119, 182, 0.7)');
Â  Â  Â  Â  Â  Â  const borderColors = ranking.map(l => l.nome.toLowerCase().includes('fort') ? 'rgb(214, 40, 40)' : 'rgb(0, 119, 182)');

Â  Â  Â  Â  Â  Â  const chartData = {
Â  Â  Â  Â  Â  Â  Â  Â  labels: labels,
Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: 'Tempo MÃ©dio em Loja (minutos)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: data,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: backgroundColors,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: borderColors,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 1
Â  Â  Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  renderChart('lojasRankingChart', 'bar', chartData, {
Â  Â  Â  Â  Â  Â  Â  Â  indexAxis: 'y',
Â  Â  Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  datalabels: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  anchor: 'end',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  align: 'end',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  formatter: (value) => minutesToHHMM(value),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: '#333'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tooltip: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  callbacks: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: function(context) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `Tempo MÃ©dio: ${minutesToHHMM(context.raw)}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  beginAtZero: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â callback: function(value) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return minutesToHHMM(value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function renderEntregasChart(fort, comper) {
Â  Â  Â  Â  Â  Â  Â const data = {
Â  Â  Â  Â  Â  Â  Â  Â  labels: ['Lojas Fort', 'Lojas Comper'],
Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: 'DistribuiÃ§Ã£o de Entregas',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: [fort, comper],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: ['rgba(214, 40, 40, 0.7)', 'rgba(0, 119, 182, 0.7)'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: ['rgb(214, 40, 40)', 'rgb(0, 119, 182)'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 1
Â  Â  Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  renderChart('entregasChart', 'pie', data, { responsive: true, plugins: { datalabels: { formatter: (value, ctx) => { let sum = 0; let dataArr = ctx.chart.data.datasets[0].data; dataArr.map(data => { sum += data; }); let percentage = (value*100 / sum).toFixed(2)+"%"; return `${value} (${percentage})`; }, color: '#fff', } } });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- NOVAS FUNÃ‡Ã•ES PARA RELATÃ“RIOS DE MOTORISTAS ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  async function generateMotoristaReports() {
Â  Â  Â  Â  Â  Â  const dataInicio = document.getElementById('relatorioMotoristaDataInicio').value;
Â  Â  Â  Â  Â  Â  const dataFim = document.getElementById('relatorioMotoristaDataFim').value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let query = 'expeditions?status=eq.entregue&order=data_hora.desc';
Â  Â  Â  Â  Â  Â  if(dataInicio) query += `&data_hora=gte.${dataInicio}`;
Â  Â  Â  Â  Â  Â  if(dataFim) query += `&data_hora=lte.${new Date(dataFim).toISOString().split('T')[0] + 'T23:59:59.999Z'}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const expeditions = await supabaseRequest(query);
Â  Â  Â  Â  Â  Â  const items = await supabaseRequest('expedition_items');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const data = expeditions.map(exp => ({
Â  Â  Â  Â  Â  Â  Â  Â  ...exp,
Â  Â  Â  Â  Â  Â  Â  Â  items: items.filter(i => i.expedition_id === exp.id)
Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (data.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('motoristaReportSummary').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('motoristaTableContainer').innerHTML = '<div class="alert alert-info">Sem dados para o perÃ­odo selecionado.</div>';
Â  Â  Â  Â  Â  Â  Â  Â  destroyChart('motoristasRankingChart');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('motoristaReportSummary').style.display = 'grid';

Â  Â  Â  Â  Â  Â  let motoristasData = {};
Â  Â  Â  Â  Â  Â  let totalViagens = data.length;
Â  Â  Â  Â  Â  Â  let totalEntregas = 0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  data.forEach(exp => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!exp.motorista_id) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const motorista = motoristas.find(m => m.id === exp.motorista_id);
Â  Â  Â  Â  Â  Â  Â  Â  if (!motorista) return;

Â  Â  Â  Â  Â  Â  Â  Â  if (!motoristasData[motorista.id]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motoristasData[motorista.id] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: motorista.nome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  viagens: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entregas: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  temposDeslocamento: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  temposEmLoja: []
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  motoristasData[motorista.id].viagens++;
Â  Â  Â  Â  Â  Â  Â  Â  motoristasData[motorista.id].entregas += exp.items.length;
Â  Â  Â  Â  Â  Â  Â  Â  totalEntregas += exp.items.length;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let ultimaData = exp.data_saida_entrega ? new Date(exp.data_saida_entrega) : null;
Â  Â  Â  Â  Â  Â  Â  Â  exp.items.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const t_chegada = item.data_inicio_descarga ? new Date(item.data_inicio_descarga) : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const t_saida = item.data_fim_descarga ? new Date(item.data_fim_descarga) : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (ultimaData && t_chegada) motoristasData[motorista.id].temposDeslocamento.push((t_chegada - ultimaData) / 60000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t_chegada && t_saida) motoristasData[motorista.id].temposEmLoja.push((t_saida - t_chegada) / 60000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t_saida) ultimaData = t_saida;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const calcularMedia = (arr) => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
Â  Â  Â  Â  Â  Â  const motoristasArray = Object.values(motoristasData);

Â  Â  Â  Â  Â  Â  // Resumo
Â  Â  Â  Â  Â  Â  document.getElementById('totalMotoristas').textContent = motoristasArray.length;
Â  Â  Â  Â  Â  Â  document.getElementById('totalViagensMotoristas').textContent = totalViagens;
Â  Â  Â  Â  Â  Â  document.getElementById('totalEntregasMotoristas').textContent = totalEntregas;
Â  Â  Â  Â  Â  Â  const veiculosUtilizados = new Set(data.map(exp => exp.veiculo_id)).size;
Â  Â  Â  Â  Â  Â  document.getElementById('produtividadeFrota').textContent = veiculosUtilizados > 0 ? (totalEntregas / veiculosUtilizados).toFixed(1) : 0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // GrÃ¡fico
Â  Â  Â  Â  Â  Â  const rankingMotoristas = motoristasArray.sort((a, b) => b.entregas - a.entregas).slice(0, 10);
Â  Â  Â  Â  Â  Â  renderMotoristasRankingChart(rankingMotoristas);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Tabela
Â  Â  Â  Â  Â  Â  renderMotoristaTable(motoristasArray, calcularMedia);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderMotoristasRankingChart(ranking) {
Â  Â  Â  Â  Â  Â  const chartData = {
Â  Â  Â  Â  Â  Â  Â  Â  labels: ranking.map(m => m.nome),
Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: 'Total de Entregas',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: ranking.map(m => m.entregas),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: 'rgba(0, 212, 170, 0.7)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: 'rgb(0, 212, 170)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 1
Â  Â  Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  renderChart('motoristasRankingChart', 'bar', chartData, {
Â  Â  Â  Â  Â  Â  Â  Â  Â scales: { y: { beginAtZero: true } },
Â  Â  Â  Â  Â  Â  Â  Â  Â plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  datalabels: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  anchor: 'end',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  align: 'top',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  formatter: (value) => value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: '#333'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function renderMotoristaTable(data, avgFn) {
Â  Â  Â  Â  Â  Â  let tableHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <table id="motoristaReportTable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Motorista</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Viagens</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Entregas</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>MÃ©dia Deslocamento</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>MÃ©dia em Loja</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${data.map(m => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${m.nome}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${m.viagens}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${m.entregas}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${minutesToHHMM(avgFn(m.temposDeslocamento))}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${minutesToHHMM(avgFn(m.temposEmLoja))}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  document.getElementById('motoristaTableContainer').innerHTML = tableHtml;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderChart(canvasId, type, data, options) {
Â  Â  Â  Â  Â  Â  if (chartInstances[canvasId]) {
Â  Â  Â  Â  Â  Â  Â  Â  chartInstances[canvasId].destroy();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const ctx = document.getElementById(canvasId).getContext('2d');
Â  Â  Â  Â  Â  Â  chartInstances[canvasId] = new Chart(ctx, {
Â  Â  Â  Â  Â  Â  Â  Â  type: type,
Â  Â  Â  Â  Â  Â  Â  Â  data: data,
Â  Â  Â  Â  Â  Â  Â  Â  options: options
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function destroyChart(canvasId) {
Â  Â  Â  Â  Â  Â  if (chartInstances[canvasId]) {
Â  Â  Â  Â  Â  Â  Â  Â  chartInstances[canvasId].destroy();
Â  Â  Â  Â  Â  Â  Â  Â  delete chartInstances[canvasId];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
// FunÃ§Ã£o para carregar e renderizar la tabela de configuraÃ§Ã£o de veÃ­culos
async function renderVeiculosConfig() {
Â  Â  const tbody = document.getElementById('veiculosConfigBody');
Â  Â  if (!tbody) return;

Â  Â  tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div>Carregando veÃ­culos...</td></tr>';

Â  Â  // Garante que a lista de veÃ­culos estÃ¡ atualizada
Â  Â  if (veiculos.length === 0) {
Â  Â  Â  Â  await loadSelectData();
Â  Â  }

Â  Â  const html = veiculos.map(v => `
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td>${v.placa}</td>
Â  Â  Â  Â  Â  Â  <td>${v.modelo}</td>
Â  Â  Â  Â  Â  Â  <td>${v.tipo}</td>
Â  Â  Â  Â  Â  Â  <td>${v.capacidade_pallets}</td>
Â  Â  Â  Â  Â  Â  <td><span class="status-badge status-${v.status.replace(/ /g, '_')}">${getStatusLabel(v.status)}</span></td>
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <select class="form-group-select" onchange="updateVeiculoStatus('${v.id}', this.value)" style="padding: 8px 12px; border-radius: 6px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="disponivel" ${v.status === 'disponivel' ? 'selected' : ''}>DisponÃ­vel</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="em_uso" ${v.status === 'em_uso' ? 'selected' : ''}>Em Uso</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="manutencao" ${v.status === 'manutencao' ? 'selected' : ''}>ManutenÃ§Ã£o</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  </tr>
Â  Â  `).join('');

Â  Â  tbody.innerHTML = html;
}

// FunÃ§Ã£o para atualizar o status de um veÃ­culo
async function updateVeiculoStatus(veiculoId, novoStatus) {
Â  Â  try {
Â  Â  Â  Â  debugLog.add(`Alterando status do veÃ­culo ${veiculoId} para ${novoStatus}`, 'info');
Â  Â  Â  Â  await supabaseRequest(`veiculos?id=eq.${veiculoId}`, 'PATCH', { status: novoStatus }, false);
Â  Â  Â  Â  showNotification(`Status do veÃ­culo atualizado para ${getStatusLabel(novoStatus)}!`, 'success');

Â  Â  Â  Â  // Recarrega os dados para refletir a mudanÃ§a em todo o sistema
Â  Â  Â  Â  await loadSelectData();Â 
Â  Â  Â  Â  await renderVeiculosConfig(); // Re-renderiza a tabela de configuraÃ§Ã£o ATUAL

Â  Â  Â  Â  // ---- ADICIONE AS DUAS LINHAS ABAIXO ----
Â  Â  Â  Â  loadTransportList();
Â  Â  Â  Â  renderMotoristasStatusList();
Â  Â  Â  Â  // -----------------------------------------

Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Erro ao atualizar status do veÃ­culo:', error);
Â  Â  Â  Â  debugLog.add(`Erro ao atualizar status do veÃ­culo: ${error.message}`, 'error');
Â  Â  Â  Â  showNotification('Erro ao atualizar status: ' + error.message, 'error');
Â  Â  }
}
Â  Â  Â  Â  // FunÃ§Ã£o para deletar uma expediÃ§Ã£o do histÃ³rico
async function deleteHistoricoExpedition(expeditionId) {
Â  Â  if (!await showConfirmationModal('Tem certeza que deseja EXCLUIR PERMANENTEMENTE esta expediÃ§Ã£o do histÃ³rico? Esta aÃ§Ã£o nÃ£o pode ser desfeita.')) {
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  debugLog.add(`Iniciando exclusÃ£o da expediÃ§Ã£o do histÃ³rico: ${expeditionId}`, 'info');

Â  Â  Â  Â  // Deleta primeiro os itens da expediÃ§Ã£o (chave estrangeira)
Â  Â  Â  Â  await supabaseRequest(`expedition_items?expedition_id=eq.${expeditionId}`, 'DELETE', null, false);

Â  Â  Â  Â  // Agora deleta a expediÃ§Ã£o principal
Â  Â  Â  Â  await supabaseRequest(`expeditions?id=eq.${expeditionId}`, 'DELETE', null, false);

Â  Â  Â  Â  debugLog.add('ExpediÃ§Ã£o do histÃ³rico excluÃ­da com sucesso', 'success');
Â  Â  Â  Â  showNotification('ExpediÃ§Ã£o excluÃ­da do histÃ³rico!', 'success');

Â  Â  Â  Â  // Recarrega os dados do histÃ³rico para refletir a exclusÃ£o
Â  Â  Â  Â  loadHistorico();

Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Erro ao excluir expediÃ§Ã£o do histÃ³rico:', error);
Â  Â  Â  Â  debugLog.add(`Erro ao excluir do histÃ³rico: ${error.message}`, 'error');
Â  Â  Â  Â  showNotification('Erro ao excluir: ' + error.message, 'error');
Â  Â  }
}
// FunÃ§Ã£o para carregar e renderizar a tabela de configuraÃ§Ã£o de motoristas
async function renderMotoristasConfig() {
Â  Â  const tbody = document.getElementById('motoristasConfigBody');
Â  Â  if (!tbody) return;

Â  Â  tbody.innerHTML = '<tr><td colspan="4" class="loading"><div class="spinner"></div>Carregando motoristas...</td></tr>';

Â  Â  if (motoristas.length === 0) {
Â  Â  Â  Â  await loadSelectData();
Â  Â  }

Â  Â  const html = motoristas.map(m => `
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td>${m.nome}</td>
Â  Â  Â  Â  Â  Â  <td>${m.PRODUTIVO || 'N/A'}</td>
Â  Â  Â  Â  Â  Â  <td><span class="status-badge status-${m.status.replace(/ /g, '_')}">${getStatusLabel(m.status)}</span></td>
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <select class="form-group-select" onchange="updateMotoristaStatus('${m.id}', this.value)" style="padding: 8px 12px; border-radius: 6px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="disponivel" ${m.status === 'disponivel' ? 'selected' : ''}>DisponÃ­vel</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="em_viagem" ${m.status === 'em_viagem' ? 'selected' : ''}>Ocupado (Em Viagem)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="folga" ${m.status === 'folga' ? 'selected' : ''}>Folga</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  </tr>
Â  Â  `).join('');

Â  Â  tbody.innerHTML = html;
}

// FunÃ§Ã£o para atualizar o status de um motorista
async function updateMotoristaStatus(motoristaId, novoStatus) {
Â  Â  try {
Â  Â  Â  Â  debugLog.add(`Alterando status do motorista ${motoristaId} para ${novoStatus}`, 'info');
Â  Â  Â  Â  await supabaseRequest(`motoristas?id=eq.${motoristaId}`, 'PATCH', { status: novoStatus }, false);
Â  Â  Â  Â  showNotification(`Status do motorista atualizado para ${getStatusLabel(novoStatus)}!`, 'success');

Â  Â  Â  Â  // Recarrega os dados para refletir a mudanÃ§a em todo o sistema
Â  Â  Â  Â  await loadSelectData();Â 
Â  Â  Â  Â  await renderMotoristasConfig();Â 

Â  Â  Â  Â  // Atualiza outras listas que dependem do status do motorista
Â  Â  Â  Â  loadTransportList();
Â  Â  Â  Â  renderMotoristasStatusList();

Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Erro ao atualizar status do motorista:', error);
Â  Â  Â  Â  debugLog.add(`Erro ao atualizar status do motorista: ${error.message}`, 'error');
Â  Â  Â  Â  showNotification('Erro ao atualizar status: ' + error.message, 'error');
Â  Â  }
}
Â  Â  Â  Â  console.log('âœ… Sistema de Controle de ExpediÃ§Ã£o Multi-Filial v4.3 carregado com sucesso!');
Â  Â  Â  Â  console.log('ğŸ¢ Desenvolvido por Juliano Patrick - JP Tech Solutions');
Â  Â  Â  Â  console.log('ğŸ“§ Contato: julianocorrea@bateforte.com.br');
Â  Â  Â  Â  // --- NOVAS FUNÃ‡Ã•ES PARA ACOMPANHAMENTO DE FROTA E OCIOSIDADE ---

// FunÃ§Ã£o principal para calcular a ociosidade da frota
async function calculateIdleness() {
Â  Â  if (!selectedFilial) {
Â  Â  Â  Â  showNotification('Selecione uma filial para calcular a ociosidade.', 'error');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const startInput = document.getElementById('ociosidadeFiltroDataInicio');
Â  Â  const endInput = document.getElementById('ociosidadeFiltroDataFim');

Â  Â  if (!startInput.value || !endInput.value) {
Â  Â  Â  Â  showNotification('Por favor, defina a data de inÃ­cio e fim.', 'error');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const startDate = new Date(startInput.value + 'T06:00:00-04:00'); // HorÃ¡rio de CuiabÃ¡
Â  Â  const endDate = new Date(endInput.value + 'T22:00:00-04:00'); // HorÃ¡rio de CuiabÃ¡

Â  Â  if (startDate >= endDate) {
Â  Â  Â  Â  showNotification('A data de inÃ­cio deve ser anterior Ã  data de fim.', 'error');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const tbody = document.getElementById('ociosidadeBody');
Â  Â  tbody.innerHTML = '<tr><td colspan="3" class="loading"><div class="spinner"></div>Calculando ociosidade...</td></tr>';
Â  Â Â 
Â  Â  let totalIdleTime = 0;
Â  Â  let vehiclesWithData = 0;

Â  Â  // Buscar todos os veÃ­culos da filial
Â  Â  const vehiclesInFilial = await supabaseRequest('veiculos?order=placa');
Â  Â  let vehicleIdleTimes = [];

Â  Â  // Para cada veÃ­culo, buscar o histÃ³rico de status
Â  Â  for (const vehicle of vehiclesInFilial) {
Â  Â  Â  Â  const history = await supabaseRequest(`veiculos_status_historico?veiculo_id=eq.${vehicle.id}&created_at=gte.${startDate.toISOString()}&created_at=lte.${endDate.toISOString()}&order=created_at.asc`);

Â  Â  Â  Â  let idleTimeForVehicle = 0;
Â  Â  Â  Â  let lastKnownTime = startDate;
Â  Â  Â  Â  let isIdle = false;

Â  Â  Â  Â  // Adiciona um status inicial se o primeiro evento for apÃ³s o inÃ­cio do perÃ­odo
Â  Â  Â  Â  if (history.length > 0 && new Date(history[0].created_at) > startDate) {
Â  Â  Â  Â  Â  Â  // Se o status anterior era 'disponivel', conta ociosidade desde o inÃ­cio do perÃ­odo
Â  Â  Â  Â  Â  Â  if (history[0].status_anterior === 'disponivel') {
Â  Â  Â  Â  Â  Â  Â  Â  Â idleTimeForVehicle += (new Date(history[0].created_at) - lastKnownTime) / 60000;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Processa o histÃ³rico de status
Â  Â  Â  Â  for (let i = 0; i < history.length; i++) {
Â  Â  Â  Â  Â  Â  const entry = history[i];
Â  Â  Â  Â  Â  Â  const eventTime = new Date(entry.created_at);

Â  Â  Â  Â  Â  Â  // Se o status era ocioso antes da mudanÃ§a, calcula o tempo de ociosidade
Â  Â  Â  Â  Â  Â  if (entry.status_anterior === 'disponivel') {
Â  Â  Â  Â  Â  Â  Â  Â  idleTimeForVehicle += (eventTime - lastKnownTime) / 60000;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Atualiza o Ãºltimo tempo conhecido para o prÃ³ximo cÃ¡lculo
Â  Â  Â  Â  Â  Â  lastKnownTime = eventTime;

Â  Â  Â  Â  Â  Â  // Define se o veÃ­culo estÃ¡ ocioso no momento do evento
Â  Â  Â  Â  Â  Â  isIdle = entry.status_novo === 'disponivel';
Â  Â  Â  Â  }

Â  Â  Â  Â  // Adiciona o tempo de ociosidade atÃ© o final do perÃ­odo, se o Ãºltimo status for 'disponivel'
Â  Â  Â  Â  if (isIdle) {
Â  Â  Â  Â  Â  Â  idleTimeForVehicle += (endDate - lastKnownTime) / 60000;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (idleTimeForVehicle > 0) {
Â  Â  Â  Â  Â  Â  vehicleIdleTimes.push({
Â  Â  Â  Â  Â  Â  Â  Â  placa: vehicle.placa,
Â  Â  Â  Â  Â  Â  Â  Â  status: getStatusLabel(vehicle.status),
Â  Â  Â  Â  Â  Â  Â  Â  idleMinutes: idleTimeForVehicle
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  totalIdleTime += idleTimeForVehicle;
Â  Â  Â  Â  Â  Â  vehiclesWithData++;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Renderiza a tabela e a mÃ©dia
Â  Â  renderOciosidadeTable(vehicleIdleTimes);
Â  Â Â 
Â  Â  const avgIdleTime = vehiclesWithData > 0 ? totalIdleTime / vehiclesWithData : 0;
Â  Â  document.getElementById('ociosidadeTotalMedia').textContent = minutesToHHMM(avgIdleTime);
}

// Renderiza a tabela de ociosidade
function renderOciosidadeTable(data) {
Â  Â  const tbody = document.getElementById('ociosidadeBody');
Â  Â  if (data.length === 0) {
Â  Â  Â  Â  tbody.innerHTML = '<tr><td colspan="3" class="alert alert-info">Nenhum dado de ociosidade encontrado para o perÃ­odo.</td></tr>';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const html = data.map(item => `
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td><strong>${item.placa}</strong></td>
Â  Â  Â  Â  Â  Â  <td><span class="status-badge status-${item.status.replace(/ /g, '_').toLowerCase()}">${item.status}</span></td>
Â  Â  Â  Â  Â  Â  <td>${minutesToHHMM(item.idleMinutes)}</td>
Â  Â  Â  Â  </tr>
Â  Â  `).join('');

Â  Â  tbody.innerHTML = html;
}
Â  Â  </script>
</body>
</html>
